<%
  team_record = local_assigns[:team_record]
  team = local_assigns[:team]
  teams = local_assigns[:teams] || []
  initiatives = local_assigns[:initiatives] || []
  all_projects = local_assigns[:all_projects] || []
  subordinate_teams = local_assigns[:subordinate_teams] || []
  archived_child_teams = local_assigns[:archived_child_teams] || []

  has_subordinate_teams = subordinate_teams.any? || archived_child_teams.any?
  owned_projects = team.respond_to?(:owned_projects) ? (team.owned_projects || []) : []
  has_owned_projects = owned_projects.any?

  # Can create owned projects if: no subordinate teams (leaf team or empty team)
  can_create_owned_project = !has_subordinate_teams

  # Build flat list of all teams with ancestry for search
  all_teams_flat = []
  build_team_tree = ->(team_list, ancestors = []) do
    team_list.sort_by(&:name).each do |t|
      path = ancestors + [t.name]
      all_teams_flat << { entity: t, type: :team, path: path, record: TeamRecord.find_by(name: t.name) }
      build_team_tree.call(t.subordinate_teams, path) if t.subordinate_teams.any?
    end
  end
  build_team_tree.call(teams) if teams

  # Build flat list of all initiatives
  all_initiatives_flat = initiatives.map do |init|
    { entity: init, type: :initiative, record: InitiativeRecord.find_by(name: init.name) }
  end

  # Build flat list of all projects with ownership and linkability info
  # Note: TeamsProjectRecord returns integer IDs, but domain Project IDs are strings
  owned_project_ids = TeamsProjectRecord.pluck(:project_id).map(&:to_s).to_set
  current_team_owned_ids = owned_projects.map { |p| p.id.to_s }.to_set

  all_projects_flat = all_projects.map do |proj|
    record = ProjectRecord.find_by(name: proj.name)
    # Check if top-level: either no parent method, or parent returns nil
    is_top_level = !proj.respond_to?(:parent) || proj.parent.nil?
    proj_id_str = proj.id.to_s
    is_owned_by_current_team = current_team_owned_ids.include?(proj_id_str)
    is_owned_by_any_team = owned_project_ids.include?(proj_id_str)
    can_link = is_top_level && !is_owned_by_any_team && can_create_owned_project

    {
      entity: proj,
      type: :project,
      record: record,
      is_top_level: is_top_level,
      is_owned_by_current_team: is_owned_by_current_team,
      is_owned_by_any_team: is_owned_by_any_team,
      can_link: can_link
    }
  end
%>

<div class="global-search" data-controller="search">
  <input type="text"
         class="global-search__input"
         placeholder="<%= can_create_owned_project ? 'Find or create what you are looking for...' : 'Find what you are looking for...' %>"
         data-search-target="input"
         data-action="input->search#search keydown->search#escape">
  <div class="global-search__results-container" data-search-target="container">
    <div class="section section--search-results">
      <h3 class="section__title" data-search-target="resultsHeader">Results</h3>
      <div class="section__columns" data-search-target="resultsGrid">
        <!-- Teams Column -->
        <div class="section__column" data-search-target="column" data-results-column="teams">
          <h4 class="section__subtitle">Teams</h4>
          <ul class="section__list">
            <% all_teams_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="team"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= team_path(entry[:record]) %>" class="section__link" data-turbo-frame="_top">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Initiatives Column -->
        <div class="section__column" data-search-target="column" data-results-column="initiatives">
          <h4 class="section__subtitle">Initiatives</h4>
          <ul class="section__list">
            <% all_initiatives_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="initiative"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= initiative_path(entry[:record]) %>" class="section__link" data-turbo-frame="_top">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Projects Column -->
        <div class="section__column" data-search-target="column" data-results-column="projects">
          <h4 class="section__subtitle">Projects</h4>
          <ul class="section__list">
            <% all_projects_flat.each do |entry| %>
              <% has_action_or_badge = entry[:can_link] || entry[:is_owned_by_current_team] || entry[:is_owned_by_any_team] %>
              <li class="section__item section__item--searchable <%= 'section__item--with-action' if has_action_or_badge %>"
                  id="search-project-item-<%= entry[:record]&.id %>"
                  data-search-type="project"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>"
                  data-project-id="<%= entry[:record]&.id %>">
                <a href="<%= project_path(entry[:record]) %>" class="section__link" data-turbo-frame="_top">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
                <% if entry[:is_owned_by_current_team] %>
                  <span class="section__badge section__badge--linked">âœ“ Owned</span>
                <% elsif entry[:is_owned_by_any_team] %>
                  <span class="section__badge section__badge--unavailable">Owned</span>
                <% elsif entry[:can_link] %>
                  <button type="button"
                          class="section__link-btn"
                          data-action="click->search#linkProject"
                          data-project-id="<%= entry[:record].id %>"
                          data-link-url="<%= owned_projects_team_path(team_record, project_id: entry[:record].id) %>">
                    Link
                  </button>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <!-- No Results / Create Owned Project (only if team can have owned projects) -->
      <div class="global-search__no-results" data-search-target="noResults" hidden>
        <% if can_create_owned_project %>
          <h3 class="section__title">Create Owned Project</h3>
          <div class="global-search__form-card">
            <%= form_with url: add_owned_project_team_path(team_record), method: :post, local: false, class: "global-search__create-form" do |f| %>
              <div class="global-search__form-fields-inline">
                <input type="text" name="project[name]" class="global-search__form-input" placeholder="Project Name (required)" data-search-target="createName" required>
                <input type="text" name="project[description]" class="global-search__form-input" placeholder="Description (highly recommended)">
                <input type="text" name="project[point_of_contact]" class="global-search__form-input" placeholder="Contacts (highly recommended)">
                <button type="submit" class="global-search__create-btn">Create Owned Project</button>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="global-search__no-matches">No matches found. This team has subordinate teams, so it cannot own projects directly.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
