<turbo-frame id="owned-projects-section">
<%
  team = local_assigns[:team]
  team_record = local_assigns[:team_record]
  subordinate_teams = local_assigns[:subordinate_teams] || []
  archived_child_teams = local_assigns[:archived_child_teams] || []

  has_subordinate_teams = subordinate_teams.any? || archived_child_teams.any?

  all_owned_projects = team.respond_to?(:owned_projects) ? (team.owned_projects || []) : []
  has_owned_projects = all_owned_projects.any?

  # Show owned projects if: has projects OR has neither (empty team)
  if has_subordinate_teams && !has_owned_projects
%>
</turbo-frame>
<% return end %>

<%
  direct_projects = all_owned_projects.reject { |p| p.respond_to?(:archived?) && p.archived? }
  archived_projects = all_owned_projects.select { |p| p.respond_to?(:archived?) && p.archived? }
  sorted_projects = sort_projects_canonical(direct_projects)
  sorted_archived = sort_projects_canonical(archived_projects)

  # Determine list type based on first project (all should be same type)
  first_project = direct_projects.first
  list_type = (first_project && first_project.respond_to?(:children) && first_project.children.any?) ? :parent : :leaf
%>
  <section class="section section--projects" data-controller="inline-form">
    <div class="section__header">
      <h3 class="section__title">Owned Projects</h3>
      <div class="section__actions">
        <button class="dashboard-tab-v2 dashboard-tab-v2--add"
                data-inline-form-target="toggle"
                data-action="inline-form#toggle"
                aria-label="Create owned project">+</button>
        <div class="info-tooltip">
          <span class="info-tooltip__icon">i</span>
          <div class="info-tooltip__tooltip">
            <div class="info-tooltip__methodology">Teams can own projects or have subordinate teams — not both.</div>
            <div class="info-tooltip__range">
              <div>• Owned projects must be top-level (no parent)</div>
              <div>• Adding a project makes this a leaf team</div>
              <div>• Leaf teams track health via owned projects</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Owned Project Form (inline) -->
    <div class="inline-create-section" data-inline-form-target="section" hidden>
      <%= form_with url: add_owned_project_team_path(team_record), method: :post, local: false, class: "inline-create-form" do |f| %>
        <div class="inline-create-form__row">
          <input type="text" name="project[name]" class="inline-create-form__input" placeholder="Project Name (required)" required>
          <input type="text" name="project[description]" class="inline-create-form__input" placeholder="Brief Description (highly recommended)">
          <input type="text" name="project[point_of_contact]" class="inline-create-form__input" placeholder="Contacts (highly recommended)">
          <button type="submit" class="btn btn--small">Create Owned Project</button>
        </div>
      <% end %>
    </div>

    <% if direct_projects.empty? && archived_projects.empty? %>
      <div class="tab-empty-v2">No owned projects</div>
    <% else %>
      <% if direct_projects.any? %>
        <ul class="project-list-v2">
          <%= render 'dashboard/project_list_header', list_type: list_type %>
          <% sorted_projects.each do |project| %>
            <%= render 'dashboard/project_list_item', project: project, list_type: list_type %>
          <% end %>
        </ul>
      <% end %>

      <% if archived_projects.any? %>
        <details class="section__archived-details">
          <summary class="section__archived-summary">Archived (<%= archived_projects.size %>)</summary>
          <ul class="project-list-v2" style="margin-top: 8px;">
            <% sorted_archived.each do |project| %>
              <%= render 'dashboard/project_list_item', project: project, list_type: list_type, tag_text: 'Archived', tag_modifier: 'archived' %>
            <% end %>
          </ul>
        </details>
      <% end %>
    <% end %>
  </section>
</turbo-frame>
