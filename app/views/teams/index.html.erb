<div class="teams-index">
  <div class="teams-index__header">
    <h1 class="teams-index__title">Teams</h1>
    <div class="teams-index__controls">
      <div class="sort-controls" data-sort-controls>
        <div class="sort-dropdown" data-sort-dropdown>
          <button type="button" class="sort-dropdown__trigger" data-sort-trigger>
            <span class="sort-dropdown__label">Sort: <strong data-sort-label><%= { 'alphabet' => 'Alphabet', 'health' => 'Health' }[@sort_by] %></strong></span>
            <span class="sort-dropdown__arrow">▼</span>
          </button>
          <div class="sort-dropdown__menu" data-sort-menu hidden>
            <% [['alphabet', 'Alphabet'], ['health', 'Health']].each do |value, label| %>
              <button type="button"
                      class="sort-dropdown__option <%= 'active' if @sort_by == value %>"
                      data-sort-value="<%= value %>">
                <%= label %>
                <% if @sort_by == value %><span class="sort-dropdown__check">✓</span><% end %>
              </button>
            <% end %>
          </div>
        </div>
        <button type="button"
                class="sort-dir-toggle <%= @sort_dir %>"
                data-sort-dir-toggle
                data-current-dir="<%= @sort_dir %>"
                title="<%= @sort_dir == 'asc' ? 'Ascending' : 'Descending' %>">
          <span class="sort-dir-toggle__arrow"><%= @sort_dir == 'asc' ? '↑' : '↓' %></span>
        </button>
      </div>

      <% all_teams = TeamRecord.where(archived: false).order(:name) %>
      <%= form_with model: TeamRecord.new,
                    url: teams_path,
                    method: :post,
                    scope: :team,
                    local: true,
                    html: { class: 'team-add-form', data: { team_search_form: true } } do |form| %>
        <div class="team-search-dropdown" data-team-search>
          <input type="text"
                 name="team[name]"
                 class="team-search-dropdown__input"
                 placeholder="Search or add team..."
                 data-team-search-input
                 autocomplete="off" />
          <div class="team-search-dropdown__menu" data-team-search-menu hidden>
            <div class="team-search-dropdown__options" data-team-options>
              <% all_teams.each do |t| %>
                <a href="<%= team_path(t) %>"
                   class="team-search-dropdown__option"
                   data-team-name="<%= t.name %>"
                   data-team-search-text="<%= t.name.downcase %>">
                  <%= t.name %>
                </a>
              <% end %>
            </div>
            <div class="team-search-dropdown__create" data-create-option hidden>
              <span class="team-search-dropdown__create-label">Create "<span data-create-name></span>"</span>
            </div>
          </div>
        </div>
        <%= form.submit 'Go', class: 'btn secondary', data: { team_submit: true } %>
      <% end %>
    </div>
  </div>

  <% if defined?(@errors) && @errors.present? %>
    <div class="errors">
      <ul>
        <% @errors.each do |err| %>
          <li><%= err %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="teams-index__list">
    <% @teams.each do |team| %>
      <%= render partial: 'teams/team_card', locals: { team: team, team_data: @team_data } %>
    <% end %>
  </div>
</div>

<script>
(function() {
  const sortDropdown = document.querySelector('[data-sort-dropdown]');
  const sortTrigger = document.querySelector('[data-sort-trigger]');
  const sortMenu = document.querySelector('[data-sort-menu]');
  const sortDirToggle = document.querySelector('[data-sort-dir-toggle]');

  const currentUrl = new URL(window.location.href);
  const currentSort = currentUrl.searchParams.get('sort') || 'alphabet';
  const currentDir = currentUrl.searchParams.get('dir') || 'asc';

  const navigateWithSort = (sort, dir) => {
    const url = new URL(window.location.href);
    url.searchParams.set('sort', sort);
    url.searchParams.set('dir', dir);
    window.location.href = url.toString();
  };

  // Sort dropdown
  sortTrigger?.addEventListener('click', () => {
    sortMenu.hidden = !sortMenu.hidden;
  });

  document.querySelectorAll('[data-sort-value]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const newSort = btn.dataset.sortValue;
      navigateWithSort(newSort, currentDir);
    });
  });

  // Direction toggle
  sortDirToggle?.addEventListener('click', () => {
    const newDir = currentDir === 'asc' ? 'desc' : 'asc';
    navigateWithSort(currentSort, newDir);
  });

  // Close sort dropdown on outside click
  document.addEventListener('click', (e) => {
    if (sortDropdown && !sortDropdown.contains(e.target)) {
      sortMenu.hidden = true;
    }
  });

  // Team search/add functionality
  const searchContainer = document.querySelector('[data-team-search]');
  const searchForm = document.querySelector('[data-team-search-form]');
  const searchInput = document.querySelector('[data-team-search-input]');
  const searchMenu = document.querySelector('[data-team-search-menu]');
  const optionsContainer = document.querySelector('[data-team-options]');
  const createOption = document.querySelector('[data-create-option]');
  const createNameSpan = document.querySelector('[data-create-name]');
  const submitBtn = document.querySelector('[data-team-submit]');

  let selectedUrl = null;
  let exactMatch = null;

  const closeMenu = () => {
    searchMenu.hidden = true;
  };

  const openMenu = () => {
    searchMenu.hidden = false;
  };

  const filterOptions = (query) => {
    const lowerQuery = query.toLowerCase().trim();
    let visibleCount = 0;
    exactMatch = null;

    optionsContainer?.querySelectorAll('.team-search-dropdown__option').forEach((option) => {
      const searchText = option.dataset.teamSearchText || '';
      const name = option.dataset.teamName || '';
      const matches = lowerQuery === '' || searchText.includes(lowerQuery);
      option.style.display = matches ? '' : 'none';
      if (matches) visibleCount++;
      if (searchText === lowerQuery) {
        exactMatch = option;
      }
    });

    // Show create option if there's input and no exact match
    if (lowerQuery && !exactMatch) {
      createOption.hidden = false;
      createNameSpan.textContent = query.trim();
    } else {
      createOption.hidden = true;
    }

    return visibleCount;
  };

  searchInput?.addEventListener('focus', () => {
    filterOptions(searchInput.value);
    openMenu();
  });

  searchInput?.addEventListener('input', (e) => {
    selectedUrl = null;
    filterOptions(e.target.value);
    if (!searchMenu.hidden === false) {
      openMenu();
    }
  });

  searchInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeMenu();
      searchInput.blur();
    }
  });

  // Click on existing team navigates to it
  optionsContainer?.querySelectorAll('.team-search-dropdown__option').forEach((option) => {
    option.addEventListener('click', (e) => {
      // Let the link navigate naturally
    });
  });

  // Click on create option submits the form
  createOption?.addEventListener('click', () => {
    const name = searchInput.value.trim();
    if (name && confirm(`Create new team "${name}"?`)) {
      searchForm.submit();
    }
  });

  // Form submission
  searchForm?.addEventListener('submit', (e) => {
    const query = searchInput.value.trim();

    if (!query) {
      e.preventDefault();
      searchInput.focus();
      return;
    }

    // Check if there's an exact match - navigate to it instead
    filterOptions(query);
    if (exactMatch) {
      e.preventDefault();
      window.location.href = exactMatch.href;
      return;
    }

    // Otherwise confirm creation
    if (!confirm(`Create new team "${query}"?`)) {
      e.preventDefault();
    }
  });

  // Close menu on outside click
  document.addEventListener('click', (e) => {
    if (searchContainer && !searchContainer.contains(e.target) && e.target !== submitBtn) {
      closeMenu();
    }
  });

  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (sortMenu && !sortMenu.hidden) {
        sortMenu.hidden = true;
      }
      if (searchMenu && !searchMenu.hidden) {
        closeMenu();
      }
    }
  });
})();
</script>
