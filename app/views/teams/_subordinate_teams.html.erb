<turbo-frame id="subordinate-teams-section">
<%
  team = local_assigns[:team]
  subordinate_teams = local_assigns[:subordinate_teams] || []
  archived_child_teams = local_assigns[:archived_child_teams] || []
%>

<%
  health_update_repo = Rails.application.config.x.health_update_repository
  all_subteams = subordinate_teams.map do |sub_team|
    health = sub_team.health || :not_available
    leaf_projects = sub_team.all_leaf_projects || []
    project_count = leaf_projects.size
    stale_count = leaf_projects.count do |p|
      next false unless [:in_progress, :blocked].include?(p.current_state)
      latest = p.latest_health_update
      latest.nil? || (Date.current - latest.date.to_date).to_i > 7
    end

    # Get trend direction
    trend_service = TeamTrendService.new(team: sub_team, health_update_repository: health_update_repo, current_date: Date.current)
    trend_result = trend_service.call
    trend_direction = trend_result[:trend_direction]

    { team: sub_team, health: health, trend: trend_direction, projects: project_count, stale: stale_count }
  end.sort_by { |t| [t[:health] == :off_track ? 0 : (t[:health] == :at_risk ? 1 : 2), t[:team].name.downcase] }

  archived_subteams = archived_child_teams.map do |sub_team|
    { team: sub_team, health: :not_available, trend: :stable, projects: 0, stale: 0 }
  end.sort_by { |t| t[:team].name.downcase }
%>
  <section class="section section--projects">
    <%
      has_items = all_subteams.any? || archived_subteams.any?
    %>
    <ul class="project-list-v2">
      <li class="project-item-v2 project-item-v2--header">
        <div class="team-item__grid team-item__grid--header">
          <span class="team-item__col team-item__col--health section__title--grid">Teams</span>
          <span class="team-item__col team-item__col--name"></span>
          <span class="team-item__col team-item__col--trend team-item__header-label"><%= 'Trend' if has_items %></span>
          <span class="team-item__col team-item__col--projects team-item__header-label"><%= 'Projects' if has_items %></span>
          <span class="team-item__col team-item__col--stale team-item__header-label"><%= 'Stale' if has_items %></span>
          <span class="team-item__col team-item__col--contact team-item__header-label"><%= 'Contact' if has_items %></span>
        </div>
      </li>
      <% all_subteams.each do |team_data| %>
        <%= render 'teams/subordinate_team_row', team_data: team_data %>
      <% end %>
    </ul>

    <% if archived_subteams.any? %>
      <details class="section__archived-details">
        <summary class="section__archived-summary">Archived (<%= archived_subteams.size %>)</summary>
        <ul class="project-list-v2" style="margin-top: 8px;">
          <% archived_subteams.each do |team_data| %>
            <li class="project-item-v2">
              <a href="<%= team_path(team_data[:team].id) %>" class="project-item-v2__link" data-turbo-frame="_top">
                <div class="team-item__grid">
                  <span class="team-item__col team-item__col--health">
                    <span class="project-item-v2__health project-item-v2__health--not_available"></span>
                  </span>
                  <span class="team-item__col team-item__col--name" style="font-style: italic;"><%= team_data[:team].name %></span>
                  <span class="team-item__col team-item__col--trend">—</span>
                  <span class="team-item__col team-item__col--projects">—</span>
                  <span class="team-item__col team-item__col--stale">—</span>
                  <span class="team-item__col team-item__col--contact"><%= team_data[:team].point_of_contact.presence || '—' %></span>
                </div>
              </a>
            </li>
          <% end %>
        </ul>
      </details>
    <% end %>

    <!-- Create Team Form -->
    <div class="inline-create-section" data-controller="create-button">
      <%= form_with url: subordinate_teams_team_path(team.id), method: :post, local: false, class: "inline-create-form" do |f| %>
        <div class="inline-create-form__row">
          <input type="text" name="team[name]" class="inline-create-form__input" placeholder="Team Name (required)" required data-create-button-target="input" data-action="input->create-button#inputChanged">
          <input type="text" name="team[description]" class="inline-create-form__input" placeholder="Brief Description (recommended)" data-create-button-target="input" data-action="input->create-button#inputChanged">
          <input type="text" name="team[point_of_contact]" class="inline-create-form__input" placeholder="Contacts (recommended)" data-create-button-target="input" data-action="input->create-button#inputChanged">
          <button type="submit" class="btn btn--small btn--create" data-create-button-target="button">Create Team</button>
        </div>
      <% end %>
    </div>
  </section>
</turbo-frame>
