<% content_for(:title) { "#{@team_record.name} - Radar" } %>
<%
  all_child_teams = @team_record.child_relationships.includes(:child).order(:order).map(&:child)
  subordinate_teams = all_child_teams.reject(&:archived)
  archived_child_teams = all_child_teams.select(&:archived)
  owned_projects = @team_record.owned_project_relationships.includes(:project).order(:order).map(&:project).reject(&:archived)
  has_subteams = subordinate_teams.any? || archived_child_teams.any?
  is_leaf_team = !has_subteams
  total_leaf_projects = @team&.all_leaf_projects&.size || 0
%>

<!-- Sticky Header -->
<div class="sticky-header" data-sticky-header>
  <div class="sticky-header__container">
    <div class="sticky-header__left">
      <div class="sticky-header__breadcrumb">
        <%= @team ? team_breadcrumb(@team, @team_record) : render_breadcrumb([{ name: 'Radar', path: root_path }]) %>
      </div>
      <div class="sticky-header__title-row">
        <img src="/logo-radar-animated-loop-v8.svg" alt="" class="sticky-header__logo">
        <h2 class="sticky-header__title"><%= @team_record.name %></h2>
      </div>
    </div>
    <div class="sticky-header__right">
      <div class="sticky-header__actions">
        <% if @team_record.archived %>
          <span class="badge badge--archived">ARCHIVED</span>
        <% end %>
        <button type="button" class="sticky-header__edit-btn" data-sticky-edit-toggle aria-label="Edit team">✎</button>
      </div>
      <% sticky_contact = @team&.effective_contact || @team_record.point_of_contact %>
      <% if sticky_contact.present? %>
        <span class="sticky-header__contact">Contact: <%= sticky_contact %></span>
      <% else %>
        <span class="sticky-header__contact sticky-header__contact--missing">No contact specified</span>
      <% end %>
    </div>
  </div>
</div>

<!-- Hero Section -->
<div class="project-hero" data-project-hero>
  <div class="project-hero__breadcrumb" data-hero-breadcrumb>
    <%= @team ? team_breadcrumb(@team, @team_record) : render_breadcrumb([{ name: 'Radar', path: root_path }]) %>
  </div>
  <div class="project-hero__actions">
    <% if @team_record.archived %>
      <span class="badge badge--archived" data-archived-badge>ARCHIVED</span>
    <% end %>
    <button type="button" class="project-hero__edit-btn" data-edit-toggle aria-label="Edit team">✎</button>
  </div>
  <h1 class="project-hero__title" data-project-title><%= @team_record.name %></h1>
  <p class="project-hero__tagline" data-project-tagline<%= ' hidden' if @team_record.description.blank? %>><%= @team_record.description %></p>
  <% effective_contact = @team&.effective_contact || @team_record.point_of_contact %>
  <% if effective_contact.present? %>
    <p class="project-hero__contact" data-project-contact>For more information, contact <span data-project-poc><%= effective_contact %></span>.</p>
  <% else %>
    <p class="project-hero__contact project-hero__contact--missing" data-project-contact>Psst! Do me a favor! Tell me who to call if this thing breaks!</p>
  <% end %>
</div>

<!-- Metrics Row -->
<%
  team_health = @team&.health || :not_available
  health_class = team_health.to_s.tr('_', '-')
  raw_score = @team&.health_raw_score
  raw_score_display = raw_score ? raw_score.round(2) : 'N/A'

  # Calculate off-track and active counts from direct relationships
  owned = @team&.owned_projects || []
  active_states = [:in_progress, :blocked]
  active_owned = owned.select { |p| active_states.include?(p.current_state) }
  off_track_active = active_owned.select { |p| p.health == :off_track }
  off_track_count = off_track_active.size
  active_count = active_owned.size
%>
<div class="initiative-dashboard-v2">
  <div class="metrics-row-v2">
    <!-- Health Widget -->
    <div class="metric-widget metric-widget--health metric-widget--<%= health_class %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Current Health</span>
        <div class="info-tooltip">
          <span class="info-tooltip__icon">i</span>
          <div class="info-tooltip__tooltip">
            <div class="info-tooltip__methodology">Weighted average of leaf project health scores. On Track = +1, At Risk = 0, Off Track = −1.</div>
            <div class="info-tooltip__range">Range: −1.0 to +1.0</div>
            <div class="info-tooltip__score">Score: <%= raw_score_display %></div>
          </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <span class="metric-widget__dot metric-widget__dot--<%= health_class %>"></span>
        <div class="metric-widget__text">
          <div class="metric-widget__label metric-widget__label--<%= health_class %>"><%= team_health.to_s.tr('_', ' ').titleize %></div>
          <% if off_track_count > 0 %>
            <div class="metric-widget__detail"><%= off_track_count %> of <%= active_count %> owned <%= 'project'.pluralize(active_count) %> off-track</div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Trend Widget -->
    <% trend_class = @weeks_of_data >= 2 ? "trend-#{@trend_direction}" : 'trend-insufficient' %>
    <div class="metric-widget metric-widget--trend metric-widget--<%= trend_class %>">
      <div class="metric-widget__header">
        <span class="metric-widget__title">6-Week Trend</span>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="info-tooltip">
            <span class="info-tooltip__icon">i</span>
            <div class="info-tooltip__tooltip">
              <div class="info-tooltip__methodology">Weekly average health scores over the past 6 weeks. Direction based on change from oldest to newest data point.</div>
              <div class="info-tooltip__range">Range: −1.0 to +1.0 per week</div>
              <div class="info-tooltip__score">Delta: <%= @trend_delta >= 0 ? '+' : '' %><%= @trend_delta.round(2) %> (<%= @weeks_of_data %> weeks)</div>
            </div>
          </div>
        </div>
      </div>
      <div class="metric-widget__chart">
        <% if @weeks_of_data >= 2 %>
          <svg viewBox="0 0 200 50" preserveAspectRatio="none" class="trend-svg">
            <defs>
              <linearGradient id="trend-gradient-team" x1="0%" y1="0%" x2="100%" y2="0%">
                <% @trend_data.each_with_index do |point, i| %>
                  <% offset = (i.to_f / [@trend_data.length - 1, 1].max * 100).round %>
                  <% color = point[:health] == :on_track ? '#22c55e' : (point[:health] == :off_track ? '#ef4444' : '#f59e0b') %>
                  <stop offset="<%= offset %>%" stop-color="<%= color %>" />
                <% end %>
              </linearGradient>
            </defs>
            <%
              points = @trend_data.each_with_index.map do |point, i|
                x = (i.to_f / [@trend_data.length - 1, 1].max * 180) + 10
                y = 45 - ((point[:score] + 1) / 2.0 * 40)
                [x, y]
              end
              points_str = points.map { |p| "#{p[0].round(1)},#{p[1].round(1)}" }.join(' ')
            %>
            <polyline class="trend-line-v2" stroke="url(#trend-gradient-team)" points="<%= points_str %>" />
            <% points.each_with_index do |p, i| %>
              <% health = @trend_data[i][:health] %>
              <circle cx="<%= p[0].round(1) %>" cy="<%= p[1].round(1) %>" r="4" class="trend-point-v2 trend-point-v2--<%= health %>" />
            <% end %>
          </svg>
        <% elsif @weeks_of_data == 1 %>
          <div class="metric-widget__no-data">1 week of data</div>
        <% else %>
          <div class="metric-widget__no-data">Insufficient data</div>
        <% end %>
      </div>
    </div>

    <!-- Confidence Widget -->
    <%
      confidence_hint = case @confidence_factors&.dig(:biggest_drag)
      when :variance
        "Volatile health trend"
      when :staleness
        "Data growing stale"
      when :coverage
        "Update coverage is uneven"
      when :insufficient_data
        "Building history..."
      else
        nil
      end
    %>
    <div class="metric-widget metric-widget--confidence metric-widget--confidence-<%= @confidence_level %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Confidence</span>
        <div class="info-tooltip">
          <span class="info-tooltip__icon">i</span>
          <div class="info-tooltip__tooltip">
            <div class="info-tooltip__methodology">Based on trend consistency, data freshness, and project coverage. Lower variance and recent updates increase confidence.</div>
            <div class="info-tooltip__range">
              <div>Range: 0–100</div>
              <div>High ≥70</div>
              <div>Medium ≥40</div>
              <div>Low &lt;40</div>
            </div>
            <div class="info-tooltip__score">Score: <%= @confidence_score %></div>
          </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <div class="confidence-ring">
          <svg viewBox="0 0 44 44">
            <circle class="confidence-ring__bg" cx="22" cy="22" r="18" />
            <% circumference = 2 * Math::PI * 18 %>
            <% offset = circumference - (@confidence_score / 100.0 * circumference) %>
            <circle class="confidence-ring__fill confidence-ring__fill--<%= @confidence_level %>"
                    cx="22" cy="22" r="18"
                    stroke-dasharray="<%= circumference.round(1) %>"
                    stroke-dashoffset="<%= offset.round(1) %>" />
          </svg>
        </div>
        <div class="metric-widget__text">
          <div class="metric-widget__label confidence-label--<%= @confidence_level %>"><%= @confidence_level.to_s.titleize %></div>
          <% if confidence_hint && @confidence_level != :high %>
            <span class="metric-widget__hint"><%= confidence_hint %></span>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" data-toast-container></div>

<!-- Global Search -->
<%
  # Build flat list of all teams with ancestry for search
  all_teams_flat = []
  build_team_tree = ->(teams, ancestors = []) do
    teams.sort_by(&:name).each do |team|
      path = ancestors + [team.name]
      all_teams_flat << { entity: team, type: :team, path: path, record: TeamRecord.find_by(name: team.name) }
      build_team_tree.call(team.subordinate_teams, path) if team.subordinate_teams.any?
    end
  end
  build_team_tree.call(@teams) if @teams

  # Build flat list of all initiatives
  all_initiatives_flat = (@initiatives || []).map do |initiative|
    { entity: initiative, type: :initiative, record: InitiativeRecord.find_by(name: initiative.name) }
  end

  # Build flat list of all projects
  all_projects_flat = (@all_projects || []).map do |proj|
    { entity: proj, type: :project, record: ProjectRecord.find_by(name: proj.name) }
  end
%>
<div class="global-search">
  <input type="text" class="global-search__input" placeholder="Find or create what you are looking for..." data-global-search>
  <div class="global-search__results-container" data-global-search-container>
    <div class="section section--search-results">
      <h3 class="section__title" data-results-header>Results</h3>
      <div class="section__columns" data-global-search-results>
        <!-- Teams Column -->
        <div class="section__column" data-results-column="teams">
          <h4 class="section__subtitle">Teams</h4>
          <ul class="section__list">
            <% all_teams_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="team"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= team_path(entry[:record]) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Initiatives Column -->
        <div class="section__column" data-results-column="initiatives">
          <h4 class="section__subtitle">Initiatives</h4>
          <ul class="section__list">
            <% all_initiatives_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="initiative"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= initiative_path(entry[:record]) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Projects Column -->
        <div class="section__column" data-results-column="projects">
          <h4 class="section__subtitle">Projects</h4>
          <ul class="section__list">
            <% all_projects_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="project"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= project_path(entry[:record]) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <!-- No Results / Create Owned Project (only for leaf teams) -->
      <% if is_leaf_team %>
        <div class="global-search__no-results" data-no-results hidden>
          <h3 class="section__title">Create Owned Project</h3>
          <div class="global-search__form-card">
            <form action="<%= add_owned_project_team_path(@team_record) %>" method="post" class="global-search__create-form" data-create-form>
              <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
              <div class="global-search__form-fields-inline">
                <input type="text" name="project[name]" class="global-search__form-input" placeholder="Project Name (required)" data-create-name required>
                <input type="text" name="project[description]" class="global-search__form-input" placeholder="Description (highly recommended)">
                <input type="text" name="project[point_of_contact]" class="global-search__form-input" placeholder="Contacts (highly recommended)">
                <button type="submit" class="global-search__create-btn">Create Owned Project</button>
              </div>
            </form>
          </div>
        </div>
      <% else %>
        <div class="global-search__no-results" data-no-results hidden>
          <p class="global-search__no-matches">No matches found</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Subordinate Teams Section -->
<%
  health_update_repo = Rails.application.config.x.health_update_repository
  all_subteams = subordinate_teams.map do |sub_team|
    domain_team = Rails.application.config.x.team_repository.find(sub_team.id)
    health = domain_team&.health || :not_available
    leaf_projects = domain_team&.all_leaf_projects || []
    project_count = leaf_projects.size
    stale_count = leaf_projects.count do |p|
      next false unless [:in_progress, :blocked].include?(p.current_state)
      latest = p.latest_health_update
      latest.nil? || (Date.current - latest.date.to_date).to_i > 7
    end

    # Get trend direction
    trend_service = TeamTrendService.new(team: domain_team, health_update_repository: health_update_repo)
    trend_result = trend_service.call
    trend_direction = trend_result[:trend_direction]

    { record: sub_team, domain: domain_team, health: health, trend: trend_direction, projects: project_count, stale: stale_count }
  end.sort_by { |t| [t[:health] == :off_track ? 0 : (t[:health] == :at_risk ? 1 : 2), t[:record].name.downcase] }

  archived_subteams = archived_child_teams.map do |sub_team|
    domain_team = Rails.application.config.x.team_repository.find(sub_team.id)
    { record: sub_team, domain: domain_team, health: :not_available, trend: :stable, projects: 0, stale: 0 }
  end.sort_by { |t| t[:record].name.downcase }

  unhealthy_subteams = all_subteams.select { |t| [:off_track, :at_risk].include?(t[:health]) }
  stale_subteams = all_subteams.select { |t| t[:stale] > 0 }
%>
<section class="section section--projects">
  <div class="section__title-row">
    <h3 class="section__title">Subordinate Teams</h3>
    <div class="dashboard-tabs-v2">
      <button class="dashboard-tab-v2 active" data-team-tab="all">
        All <span class="dashboard-tab-v2__count"><%= all_subteams.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-team-tab="unhealthy">
        Unhealthy <span class="dashboard-tab-v2__count"><%= unhealthy_subteams.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-team-tab="stale">
        Stale <span class="dashboard-tab-v2__count"><%= stale_subteams.size %></span>
      </button>
      <% if archived_subteams.any? %>
        <button class="dashboard-tab-v2" data-team-tab="archived">
          Archived <span class="dashboard-tab-v2__count"><%= archived_subteams.size %></span>
        </button>
      <% end %>
      <button class="dashboard-tab-v2 dashboard-tab-v2--add" data-toggle-create-team aria-label="Create subordinate team">+</button>
    </div>
  </div>

  <!-- Create Subordinate Team Form (inline) -->
  <div class="inline-create-section" data-create-team-section hidden>
    <form action="<%= subordinate_teams_team_path(@team_record) %>" method="post" class="inline-create-form" data-create-subteam-form>
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <div class="inline-create-form__row">
        <input type="text" name="team[name]" class="inline-create-form__input" placeholder="Team Name (required)" required data-subteam-name>
        <input type="text" name="team[description]" class="inline-create-form__input" placeholder="Brief Description (highly recommended)">
        <input type="text" name="team[point_of_contact]" class="inline-create-form__input" placeholder="Contacts (highly recommended)">
        <button type="submit" class="btn btn--small" data-subteam-submit>Create Subteam</button>
      </div>
    </form>
  </div>

  <!-- Tab Content: All -->
  <div class="tab-content-v2 active" data-team-tab-content="all">
    <% if all_subteams.empty? %>
      <div class="tab-empty-v2">No subordinate teams</div>
    <% else %>
      <ul class="project-list-v2">
        <li class="project-item-v2 project-item-v2--header">
          <div class="team-item__grid team-item__grid--header">
            <span class="team-item__col team-item__col--health"></span>
            <span class="team-item__col team-item__col--name team-item__header-label">Team</span>
            <span class="team-item__col team-item__col--trend team-item__header-label">Trend</span>
            <span class="team-item__col team-item__col--projects team-item__header-label">Projects</span>
            <span class="team-item__col team-item__col--stale team-item__header-label">Stale</span>
            <span class="team-item__col team-item__col--contact team-item__header-label">Contact</span>
          </div>
        </li>
        <% all_subteams.each do |team_data| %>
          <li class="project-item-v2">
            <a href="<%= team_path(team_data[:record]) %>" class="project-item-v2__link">
              <div class="team-item__grid">
                <span class="team-item__col team-item__col--health">
                  <span class="project-item-v2__health project-item-v2__health--<%= team_data[:health] %>"></span>
                </span>
                <span class="team-item__col team-item__col--name"><%= team_data[:record].name %></span>
                <span class="team-item__col team-item__col--trend">
                  <%= trend_arrow_svg(team_data[:trend]) %>
                </span>
                <span class="team-item__col team-item__col--projects"><%= team_data[:projects] %></span>
                <span class="team-item__col team-item__col--stale<%= ' team-item__col--stale-warning' if team_data[:stale] > 0 %>"
                      <% if team_data[:stale] > 0 %>data-stale-link="<%= team_path(team_data[:record], tab: 'stale') %>"<% end %>><%= team_data[:stale] %></span>
                <span class="team-item__col team-item__col--contact"><%= team_data[:record].point_of_contact.presence || '—' %></span>
              </div>
            </a>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Unhealthy -->
  <div class="tab-content-v2" data-team-tab-content="unhealthy">
    <% if unhealthy_subteams.empty? %>
      <div class="tab-empty-v2">All subordinate teams are healthy!</div>
    <% else %>
      <ul class="project-list-v2">
        <li class="project-item-v2 project-item-v2--header">
          <div class="team-item__grid team-item__grid--header">
            <span class="team-item__col team-item__col--health"></span>
            <span class="team-item__col team-item__col--name team-item__header-label">Team</span>
            <span class="team-item__col team-item__col--trend team-item__header-label">Trend</span>
            <span class="team-item__col team-item__col--projects team-item__header-label">Projects</span>
            <span class="team-item__col team-item__col--stale team-item__header-label">Stale</span>
            <span class="team-item__col team-item__col--contact team-item__header-label">Contact</span>
          </div>
        </li>
        <% unhealthy_subteams.each do |team_data| %>
          <li class="project-item-v2">
            <a href="<%= team_path(team_data[:record]) %>" class="project-item-v2__link">
              <div class="team-item__grid">
                <span class="team-item__col team-item__col--health">
                  <span class="project-item-v2__health project-item-v2__health--<%= team_data[:health] %>"></span>
                </span>
                <span class="team-item__col team-item__col--name"><%= team_data[:record].name %></span>
                <span class="team-item__col team-item__col--trend">
                  <%= trend_arrow_svg(team_data[:trend]) %>
                </span>
                <span class="team-item__col team-item__col--projects"><%= team_data[:projects] %></span>
                <span class="team-item__col team-item__col--stale<%= ' team-item__col--stale-warning' if team_data[:stale] > 0 %>"
                      <% if team_data[:stale] > 0 %>data-stale-link="<%= team_path(team_data[:record], tab: 'stale') %>"<% end %>><%= team_data[:stale] %></span>
                <span class="team-item__col team-item__col--contact"><%= team_data[:record].point_of_contact.presence || '—' %></span>
              </div>
            </a>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Stale -->
  <div class="tab-content-v2" data-team-tab-content="stale">
    <% if stale_subteams.empty? %>
      <div class="tab-empty-v2">All subordinate teams are up to date!</div>
    <% else %>
      <ul class="project-list-v2">
        <li class="project-item-v2 project-item-v2--header">
          <div class="team-item__grid team-item__grid--header">
            <span class="team-item__col team-item__col--health"></span>
            <span class="team-item__col team-item__col--name team-item__header-label">Team</span>
            <span class="team-item__col team-item__col--trend team-item__header-label">Trend</span>
            <span class="team-item__col team-item__col--projects team-item__header-label">Projects</span>
            <span class="team-item__col team-item__col--stale team-item__header-label">Stale</span>
            <span class="team-item__col team-item__col--contact team-item__header-label">Contact</span>
          </div>
        </li>
        <% stale_subteams.each do |team_data| %>
          <li class="project-item-v2">
            <a href="<%= team_path(team_data[:record]) %>" class="project-item-v2__link">
              <div class="team-item__grid">
                <span class="team-item__col team-item__col--health">
                  <span class="project-item-v2__health project-item-v2__health--<%= team_data[:health] %>"></span>
                </span>
                <span class="team-item__col team-item__col--name"><%= team_data[:record].name %></span>
                <span class="team-item__col team-item__col--trend">
                  <%= trend_arrow_svg(team_data[:trend]) %>
                </span>
                <span class="team-item__col team-item__col--projects"><%= team_data[:projects] %></span>
                <span class="team-item__col team-item__col--stale<%= ' team-item__col--stale-warning' if team_data[:stale] > 0 %>"
                      <% if team_data[:stale] > 0 %>data-stale-link="<%= team_path(team_data[:record], tab: 'stale') %>"<% end %>><%= team_data[:stale] %></span>
                <span class="team-item__col team-item__col--contact"><%= team_data[:record].point_of_contact.presence || '—' %></span>
              </div>
            </a>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Archived -->
  <% if archived_subteams.any? %>
    <div class="tab-content-v2" data-team-tab-content="archived">
      <ul class="project-list-v2">
        <li class="project-item-v2 project-item-v2--header">
          <div class="team-item__grid team-item__grid--header">
            <span class="team-item__col team-item__col--health"></span>
            <span class="team-item__col team-item__col--name team-item__header-label">Team</span>
            <span class="team-item__col team-item__col--trend team-item__header-label">Trend</span>
            <span class="team-item__col team-item__col--projects team-item__header-label">Projects</span>
            <span class="team-item__col team-item__col--stale team-item__header-label">Stale</span>
            <span class="team-item__col team-item__col--contact team-item__header-label">Contact</span>
          </div>
        </li>
        <% archived_subteams.each do |team_data| %>
          <li class="project-item-v2">
            <a href="<%= team_path(team_data[:record]) %>" class="project-item-v2__link">
              <div class="team-item__grid">
                <span class="team-item__col team-item__col--health">
                  <span class="project-item-v2__health project-item-v2__health--not_available"></span>
                </span>
                <span class="team-item__col team-item__col--name" style="font-style: italic;"><%= team_data[:record].name %></span>
                <span class="team-item__col team-item__col--trend">—</span>
                <span class="team-item__col team-item__col--projects">—</span>
                <span class="team-item__col team-item__col--stale">—</span>
                <span class="team-item__col team-item__col--contact"><%= team_data[:record].point_of_contact.presence || '—' %></span>
              </div>
            </a>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>
</section>

<!-- Owned Projects Section -->
<%
  all_owned_projects = @team&.owned_projects || []
  direct_projects = all_owned_projects.reject { |p| p.respond_to?(:archived?) && p.archived? }
  archived_projects = all_owned_projects.select { |p| p.respond_to?(:archived?) && p.archived? }
  sorted_projects = sort_projects_canonical(direct_projects)
  sorted_archived = sort_projects_canonical(archived_projects)

  unhealthy = direct_projects.select { |p| [:off_track, :at_risk].include?(p.health) }
  sorted_unhealthy = sort_projects_canonical(unhealthy)

  stale = direct_projects.select do |p|
    next false unless [:in_progress, :blocked].include?(p.current_state)
    latest = p.latest_health_update
    latest.nil? || (Date.current - latest.date.to_date).to_i > 7
  end
  sorted_stale = sort_projects_canonical(stale)

  active_states = [:new, :in_progress, :blocked]
  inactive_states = [:completed, :paused, :cancelled, :done, :on_hold, :todo]

  active_projects = direct_projects.select { |p| active_states.include?(p.current_state) }
  sorted_active = sort_projects_canonical(active_projects)

  inactive_projects = direct_projects.select { |p| inactive_states.include?(p.current_state) }
  sorted_inactive = sort_projects_canonical(inactive_projects)
%>
<section class="section section--projects">
  <div class="section__title-row">
    <h3 class="section__title">Owned Projects</h3>
    <div class="dashboard-tabs-v2">
      <button class="dashboard-tab-v2 active" data-child-tab="all">
        All <span class="dashboard-tab-v2__count"><%= direct_projects.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-child-tab="unhealthy">
        Unhealthy <span class="dashboard-tab-v2__count"><%= unhealthy.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-child-tab="stale">
        Stale <span class="dashboard-tab-v2__count"><%= stale.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-child-tab="active">
        Active <span class="dashboard-tab-v2__count"><%= active_projects.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-child-tab="inactive">
        Inactive <span class="dashboard-tab-v2__count"><%= inactive_projects.size %></span>
      </button>
      <% if archived_projects.any? %>
        <button class="dashboard-tab-v2" data-child-tab="archived">
          Archived <span class="dashboard-tab-v2__count"><%= archived_projects.size %></span>
        </button>
      <% end %>
      <button class="dashboard-tab-v2 dashboard-tab-v2--add" data-toggle-create-owned aria-label="Create owned project">+</button>
    </div>
  </div>

  <!-- Create Owned Project Form (inline) -->
  <div class="inline-create-section" data-create-owned-section hidden>
    <form action="<%= add_owned_project_team_path(@team_record) %>" method="post" class="inline-create-form" data-create-owned-form>
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <div class="inline-create-form__row">
        <input type="text" name="project[name]" class="inline-create-form__input" placeholder="Project Name (required)" required data-owned-name>
        <input type="text" name="project[description]" class="inline-create-form__input" placeholder="Brief Description (highly recommended)">
        <input type="text" name="project[point_of_contact]" class="inline-create-form__input" placeholder="Contacts (highly recommended)">
        <button type="submit" class="btn btn--small" data-owned-submit>Create Owned Project</button>
      </div>
    </form>
  </div>

  <!-- Tab Content: All -->
  <div class="tab-content-v2 active" data-child-tab-content="all">
    <% if direct_projects.empty? %>
      <div class="tab-empty-v2">No owned projects</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_projects.each do |project| %>
          <%= render 'dashboard/project_list_item', project: project %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Unhealthy -->
  <div class="tab-content-v2" data-child-tab-content="unhealthy">
    <% if unhealthy.empty? %>
      <div class="tab-empty-v2">All owned projects are healthy!</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_unhealthy.each do |project| %>
          <%= render 'dashboard/project_list_item', project: project %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Stale -->
  <div class="tab-content-v2" data-child-tab-content="stale">
    <% if stale.empty? %>
      <div class="tab-empty-v2">All owned projects are up to date!</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_stale.each do |project| %>
          <%= render 'dashboard/project_list_item', project: project, tag_text: 'Stale', tag_modifier: 'stale' %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Active -->
  <div class="tab-content-v2" data-child-tab-content="active">
    <% if active_projects.empty? %>
      <div class="tab-empty-v2">No active owned projects</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_active.each do |project| %>
          <% tag_text = project.current_state == :blocked ? 'Blocked' : nil %>
          <% tag_modifier = project.current_state == :blocked ? 'blocked' : nil %>
          <%= render 'dashboard/project_list_item', project: project, tag_text: tag_text, tag_modifier: tag_modifier %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Inactive -->
  <div class="tab-content-v2" data-child-tab-content="inactive">
    <% if inactive_projects.empty? %>
      <div class="tab-empty-v2">No inactive owned projects</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_inactive.each do |project| %>
          <% tag_text = project.current_state.to_s.tr('_', ' ').titleize %>
          <%= render 'dashboard/project_list_item', project: project, tag_text: tag_text, tag_modifier: 'inactive' %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Archived -->
  <% if archived_projects.any? %>
    <div class="tab-content-v2" data-child-tab-content="archived">
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_archived.each do |project| %>
          <%= render 'dashboard/project_list_item', project: project, tag_text: 'Archived', tag_modifier: 'archived' %>
        <% end %>
      </ul>
    </div>
  <% end %>
</section>

<!-- Edit Modal -->
<div class="modal-overlay" data-edit-modal hidden>
  <div class="modal">
    <div class="modal__header">
      <h3>Edit Team</h3>
    </div>
    <form class="edit-project-form" data-edit-form>
      <div class="modal__body">
        <div class="form-field">
          <label for="team_name" class="form-field__label">Name</label>
          <input type="text" id="team_name" name="team[name]" class="form-field__input" value="<%= @team_record.name %>" required data-input-name>
        </div>
        <div class="form-field">
          <label for="team_description" class="form-field__label">Description</label>
          <input type="text" id="team_description" name="team[description]" class="form-field__input" value="<%= @team_record.description %>" data-input-description>
        </div>
        <div class="form-field">
          <label for="team_point_of_contact" class="form-field__label">Contact(s)</label>
          <input type="text" id="team_point_of_contact" name="team[point_of_contact]" class="form-field__input" value="<%= @team_record.point_of_contact %>" data-input-poc>
        </div>
        <div class="form-field form-field--archive">
          <span class="form-field__label">Archive this team and remove it from view?</span>
          <label class="checkbox-field">
            <input type="hidden" name="team[archived]" value="0">
            <input type="checkbox" name="team[archived]" value="1" class="checkbox-field__input" <%= 'checked' if @team_record.archived %> data-archive-checkbox>
            <span class="checkbox-field__box"></span>
            <span class="checkbox-field__label" data-archive-label><%= @team_record.archived ? 'This team is archived and hidden.' : 'Click checkbox to archive' %></span>
          </label>
        </div>
      </div>
      <div class="modal__actions">
        <button type="button" class="btn secondary" data-edit-cancel>Cancel</button>
        <button type="submit" class="btn" data-edit-save>Save</button>
      </div>
    </form>
  </div>
</div>

<% if defined?(@errors) && @errors.present? %>
  <div class="errors">
    <ul>
      <% @errors.each do |err| %>
        <li><%= err %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const token = document.querySelector('meta[name="csrf-token"]')?.content;

  // Edit modal
  const editToggle = document.querySelector('[data-edit-toggle]');
  const editModal = document.querySelector('[data-edit-modal]');
  const editCancel = document.querySelector('[data-edit-cancel]');
  const editForm = document.querySelector('[data-edit-form]');

  const showEditModal = () => {
    editModal.hidden = false;
  };

  const hideEditModal = () => {
    editModal.hidden = true;
  };

  editToggle?.addEventListener('click', showEditModal);
  editCancel?.addEventListener('click', hideEditModal);

  editModal?.addEventListener('click', (e) => {
    if (e.target === editModal) hideEditModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && editModal && !editModal.hidden) {
      hideEditModal();
    }
  });

  // Dynamic archive checkbox label
  const archiveCheckbox = document.querySelector('[data-archive-checkbox]');
  const archiveLabel = document.querySelector('[data-archive-label]');

  archiveCheckbox?.addEventListener('change', () => {
    archiveLabel.textContent = archiveCheckbox.checked
      ? 'This team is archived and hidden.'
      : 'Click checkbox to archive';
  });

  // AJAX form submission for edit
  editForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(editForm);
    const saveBtn = editForm.querySelector('[data-edit-save]');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;

    try {
      const response = await fetch('<%= team_path(@team_record) %>', {
        method: 'PATCH',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': token
        },
        body: formData
      });

      const data = await response.json();

      if (response.ok) {
        // Update hero section
        const titleEl = document.querySelector('[data-project-title]');
        const taglineEl = document.querySelector('[data-project-tagline]');
        const contactEl = document.querySelector('[data-project-contact]');
        const pocEl = document.querySelector('[data-project-poc]');
        const actionsEl = document.querySelector('.project-hero__actions');
        let archivedBadge = document.querySelector('[data-archived-badge]');

        const name = formData.get('team[name]');
        const description = formData.get('team[description]');
        const poc = formData.get('team[point_of_contact]');
        const archived = formData.get('team[archived]') === '1';

        if (titleEl) titleEl.textContent = name;

        if (taglineEl) {
          taglineEl.textContent = description;
          taglineEl.hidden = !description;
        }

        if (contactEl && pocEl) {
          pocEl.textContent = poc;
          contactEl.hidden = !poc;
        }

        // Handle archived badge
        if (archived && !archivedBadge) {
          archivedBadge = document.createElement('span');
          archivedBadge.className = 'badge badge--archived';
          archivedBadge.setAttribute('data-archived-badge', '');
          archivedBadge.textContent = 'ARCHIVED';
          actionsEl.insertBefore(archivedBadge, actionsEl.firstChild);
        } else if (!archived && archivedBadge) {
          archivedBadge.remove();
        }

        hideEditModal();
      } else {
        const errorMsg = data.errors ? data.errors.join(', ') : 'Failed to save';
        alert(errorMsg);
      }
    } catch (error) {
      console.error(error);
      alert('An error occurred. Please try again.');
    } finally {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }
  });

  // Add subordinate team form
  const subteamForm = document.querySelector('[data-create-subteam-form]');
  if (subteamForm) {
    subteamForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(subteamForm);
      const submitBtn = subteamForm.querySelector('[data-subteam-submit]');
      const nameInput = subteamForm.querySelector('[data-subteam-name]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Adding...';
      submitBtn.disabled = true;

      try {
        const response = await fetch(subteamForm.action, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': token
          },
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          showToast(`"${data.name}" created!`, 'success');
          // Clear all form inputs
          subteamForm.querySelectorAll('input:not([type="hidden"])').forEach(input => input.value = '');
          nameInput.focus();
          // Reload with parameter to keep form open
          const url = new URL(window.location.href);
          url.searchParams.set('showCreateForm', 'true');
          setTimeout(() => window.location.href = url.toString(), 1500);
        } else {
          const errorMsg = data.errors ? data.errors.join(', ') : 'Failed to create team';
          showToast(errorMsg, 'error');
        }
      } catch (error) {
        showToast('An error occurred. Please try again.', 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
  }

  // Global search functionality
  const globalSearch = document.querySelector('[data-global-search]');
  const searchContainer = document.querySelector('[data-global-search-container]');
  const searchResultsBox = document.querySelector('.section--search-results');

  if (globalSearch && searchContainer && searchResultsBox) {
    const columns = searchResultsBox.querySelectorAll('[data-results-column]');
    const noResultsEl = searchResultsBox.querySelector('[data-no-results]');
    const createNameInput = searchResultsBox.querySelector('[data-create-name]');
    const resultsGrid = searchResultsBox.querySelector('.section__columns');
    const resultsHeader = searchResultsBox.querySelector('[data-results-header]');

    globalSearch.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      const queryLower = query.toLowerCase();

      if (query === '') {
        searchContainer.classList.remove('open');
        return;
      }

      searchContainer.classList.add('open');

      let totalVisible = 0;

      columns.forEach((column) => {
        const items = column.querySelectorAll('.section__item--searchable');
        let columnVisible = 0;

        items.forEach((item) => {
          const name = item.dataset.searchName || '';
          const poc = item.dataset.searchPoc || '';
          const matches = name.includes(queryLower) || poc.includes(queryLower);
          item.hidden = !matches;
          if (matches) columnVisible++;
        });

        column.hidden = columnVisible === 0;
        totalVisible += columnVisible;
      });

      if (noResultsEl) {
        noResultsEl.hidden = totalVisible > 0;
        const capitalizedQuery = query.charAt(0).toUpperCase() + query.slice(1);
        if (createNameInput) createNameInput.value = capitalizedQuery;
      }

      if (resultsGrid) resultsGrid.hidden = totalVisible === 0;
      if (resultsHeader) resultsHeader.hidden = totalVisible === 0;
    });

    document.addEventListener('click', (e) => {
      const globalSearchEl = document.querySelector('.global-search');
      if (globalSearchEl && !globalSearchEl.contains(e.target)) {
        searchContainer.classList.remove('open');
        globalSearch.value = '';
      }
    });

    globalSearch.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchContainer.classList.remove('open');
        globalSearch.value = '';
        globalSearch.blur();
      }
    });

    const createForm = searchResultsBox.querySelector('[data-create-form]');
    if (createForm) {
      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(createForm);
        const submitBtn = createForm.querySelector('.global-search__create-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Creating...';
        submitBtn.disabled = true;

        try {
          const response = await fetch(createForm.action, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'X-CSRF-Token': formData.get('authenticity_token')
            },
            body: formData
          });

          const data = await response.json();

          if (response.ok) {
            showToast(`"${data.name}" created and linked to team!`, 'success');
            searchContainer.classList.remove('open');
            globalSearch.value = '';
            createForm.reset();
            // Reload to show new project
            setTimeout(() => window.location.reload(), 1500);
          } else {
            const errorMsg = data.errors ? data.errors.join(', ') : 'Failed to create project';
            showToast(errorMsg, 'error');
          }
        } catch (error) {
          showToast('An error occurred. Please try again.', 'error');
        } finally {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      });
    }
  }

  // Child projects tab switching
  const childTabs = document.querySelectorAll('[data-child-tab]');
  const childTabContents = document.querySelectorAll('[data-child-tab-content]');

  const openChildTab = (tabName) => {
    const targetTab = document.querySelector(`[data-child-tab="${tabName}"]`);
    if (!targetTab) return;

    childTabs.forEach((t) => t.classList.remove('active'));
    targetTab.classList.add('active');

    childTabContents.forEach((content) => {
      content.classList.toggle('active', content.dataset.childTabContent === tabName);
    });
  };

  childTabs.forEach((tab) => {
    tab.addEventListener('click', () => {
      openChildTab(tab.dataset.childTab);
    });
  });

  // Open tab from URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const tabParam = urlParams.get('tab');
  if (tabParam) {
    openChildTab(tabParam);
  }

  // Stale count click handler
  document.querySelectorAll('[data-stale-link]').forEach((el) => {
    el.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = el.dataset.staleLink;
    });
  });

  // Subordinate teams tab switching
  const teamTabs = document.querySelectorAll('[data-team-tab]');
  const teamTabContents = document.querySelectorAll('[data-team-tab-content]');

  teamTabs.forEach((tab) => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.teamTab;

      teamTabs.forEach((t) => t.classList.remove('active'));
      tab.classList.add('active');

      teamTabContents.forEach((content) => {
        content.classList.toggle('active', content.dataset.teamTabContent === tabName);
      });
    });
  });

  // Toggle create team section
  const createTeamToggle = document.querySelector('[data-toggle-create-team]');
  const createTeamSection = document.querySelector('[data-create-team-section]');

  const showCreateForm = () => {
    if (createTeamSection && createTeamToggle) {
      createTeamSection.hidden = false;
      createTeamToggle.classList.add('active');
      createTeamToggle.textContent = '×';
      createTeamSection.querySelector('input[name="team[name]"]')?.focus();
    }
  };

  const hideCreateForm = () => {
    if (createTeamSection && createTeamToggle) {
      createTeamSection.hidden = true;
      createTeamToggle.classList.remove('active');
      createTeamToggle.textContent = '+';
    }
  };

  if (createTeamToggle && createTeamSection) {
    createTeamToggle.addEventListener('click', () => {
      if (createTeamSection.hidden) {
        showCreateForm();
      } else {
        hideCreateForm();
      }
    });

    // Show form if URL parameter is present
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('showCreateForm') === 'true') {
      showCreateForm();
      // Clean up the URL
      urlParams.delete('showCreateForm');
      const newUrl = urlParams.toString()
        ? `${window.location.pathname}?${urlParams.toString()}`
        : window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }
  }

  // Toast notification function
  function showToast(message, type = 'success') {
    const container = document.querySelector('[data-toast-container]');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast toast--${type}`;
    toast.innerHTML = message;

    container.appendChild(toast);

    requestAnimationFrame(() => {
      toast.classList.add('toast--visible');
    });

    setTimeout(() => {
      toast.classList.remove('toast--visible');
      setTimeout(() => toast.remove(), 300);
    }, 10000);

    toast.addEventListener('click', (e) => {
      if (e.target.tagName !== 'A') {
        toast.classList.remove('toast--visible');
        setTimeout(() => toast.remove(), 300);
      }
    });
  }

  // Toggle create owned project section
  const createOwnedToggle = document.querySelector('[data-toggle-create-owned]');
  const createOwnedSection = document.querySelector('[data-create-owned-section]');

  const showCreateOwnedForm = () => {
    if (createOwnedSection && createOwnedToggle) {
      createOwnedSection.hidden = false;
      createOwnedToggle.classList.add('active');
      createOwnedToggle.textContent = '×';
      createOwnedSection.querySelector('input[name="project[name]"]')?.focus();
    }
  };

  const hideCreateOwnedForm = () => {
    if (createOwnedSection && createOwnedToggle) {
      createOwnedSection.hidden = true;
      createOwnedToggle.classList.remove('active');
      createOwnedToggle.textContent = '+';
    }
  };

  if (createOwnedToggle && createOwnedSection) {
    createOwnedToggle.addEventListener('click', () => {
      if (createOwnedSection.hidden) {
        showCreateOwnedForm();
      } else {
        hideCreateOwnedForm();
      }
    });

    // Handle form submission via AJAX
    const createOwnedForm = document.querySelector('[data-create-owned-form]');
    if (createOwnedForm) {
      createOwnedForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(createOwnedForm);
        const submitBtn = createOwnedForm.querySelector('[data-owned-submit]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';

        try {
          const response = await fetch(createOwnedForm.action, {
            method: 'POST',
            body: formData,
            headers: {
              'Accept': 'application/json'
            }
          });

          if (response.ok) {
            const data = await response.json();
            showToast(`Created owned project: <a href="${data.url}">${data.name}</a>`);
            createOwnedForm.reset();
            // Reload to show the new project
            setTimeout(() => window.location.reload(), 1000);
          } else {
            const error = await response.json();
            showToast(error.message || 'Failed to create project', 'error');
          }
        } catch (err) {
          showToast('An error occurred', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
  }
});
</script>
