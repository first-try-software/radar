<!-- Toast Container -->
<div class="toast-container" data-toast-container></div>

<div class="home-hero">
  <div class="home-hero__header">
    <img src="/logo-radar-animated-loop-v8.svg" alt="" class="home-hero__logo" aria-hidden="true">
    <h1 class="home-hero__title">Radar</h1>
  </div>
  <p class="home-hero__tagline">Get your bearings. And everyone else's, too.</p>
</div>

<div class="initiative-dashboard-v2">
  <!-- Metrics Row: Health | Trend | Confidence -->
  <% system_health = @system_health || :not_available %>
  <% health_class = system_health.to_s.tr('_', '-') %>
  <%
    # Calculate raw score from teams + initiatives equally weighted
    health_scores = { on_track: 1, at_risk: 0, off_track: -1 }
    health_values = []
    @teams.each do |team|
      health = team.health
      health_values << health_scores[health] if health != :not_available && health_scores.key?(health)
    end
    @initiatives.each do |initiative|
      health = initiative.health
      health_values << health_scores[health] if health != :not_available && health_scores.key?(health)
    end
    raw_score = health_values.any? ? health_values.sum(0.0) / health_values.length : nil
    raw_score_display = raw_score ? raw_score.round(2) : 'N/A'
  %>

  <div class="metrics-row-v2">
    <!-- Health Widget -->
    <%
      # Count off-track teams and initiatives
      off_track_teams = @teams.select { |t| t.health == :off_track }
      off_track_initiatives = @initiatives.select { |i| i.health == :off_track }
      off_track_count = off_track_teams.size + off_track_initiatives.size
      total_entities = @teams.size + @initiatives.size

      # Count at-risk teams and initiatives
      at_risk_teams = @teams.select { |t| t.health == :at_risk }
      at_risk_initiatives = @initiatives.select { |i| i.health == :at_risk }
      at_risk_count = at_risk_teams.size + at_risk_initiatives.size

      urgent_action = if off_track_count > 0
        entity_word = off_track_count == 1 ? 'team/initiative' : 'teams/initiatives'
        { text: "#{off_track_count} of #{total_entities} #{entity_word} off-track" }
      elsif at_risk_count > 0
        entity_word = at_risk_count == 1 ? 'team/initiative' : 'teams/initiatives'
        { text: "#{at_risk_count} of #{total_entities} #{entity_word} at-risk" }
      else
        nil
      end
    %>
    <div class="metric-widget metric-widget--health metric-widget--<%= health_class %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Current Health</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
            <div class="widget-info__tooltip">
              <div class="widget-info__methodology">Average of team and initiative health scores, equally weighted.</div>
              <div class="widget-info__range">
                <div>On Track = +1</div>
                <div>At Risk = 0</div>
                <div>Off Track = −1</div>
              </div>
              <div class="widget-info__score">Score: <%= raw_score_display %></div>
            </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <span class="metric-widget__dot metric-widget__dot--<%= health_class %>"></span>
        <div class="metric-widget__text">
          <div class="metric-widget__label metric-widget__label--<%= health_class %>"><%= system_health.to_s.tr('_', ' ').titleize %></div>
          <% if urgent_action %>
            <span class="metric-widget__detail"><%= urgent_action[:text] %></span>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Trend Widget -->
    <% trend_class = @weeks_of_data >= 2 ? "trend-#{@trend_direction}" : 'trend-insufficient' %>
    <div class="metric-widget metric-widget--trend metric-widget--<%= trend_class %>">
      <div class="metric-widget__header">
        <span class="metric-widget__title">6-Week Trend</span>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="widget-info">
            <span class="widget-info__icon">i</span>
            <div class="widget-info__tooltip">
              <div class="widget-info__methodology">Weekly average health scores over the past 6 weeks from oldest to newest.</div>
              <div class="widget-info__range">Range: −1.0 to +1.0 per week</div>
              <div class="widget-info__score">Delta: <%= @trend_delta >= 0 ? '+' : '' %><%= @trend_delta.round(2) %> (<%= @weeks_of_data %> weeks)</div>
            </div>
          </div>
        </div>
      </div>
      <div class="metric-widget__chart">
        <% if @weeks_of_data >= 2 %>
          <svg viewBox="0 0 200 50" preserveAspectRatio="none" class="trend-svg">
            <defs>
              <linearGradient id="trend-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <% @trend_data.each_with_index do |point, i| %>
                  <% offset = (i.to_f / [@trend_data.length - 1, 1].max * 100).round %>
                  <% color = point[:health] == :on_track ? '#22c55e' : (point[:health] == :off_track ? '#ef4444' : '#f59e0b') %>
                  <stop offset="<%= offset %>%" stop-color="<%= color %>" />
                <% end %>
              </linearGradient>
            </defs>
            <%
              points = @trend_data.each_with_index.map do |point, i|
                x = (i.to_f / [@trend_data.length - 1, 1].max * 180) + 10
                y = 45 - ((point[:score] + 1) / 2.0 * 40)
                [x, y]
              end
              points_str = points.map { |p| "#{p[0].round(1)},#{p[1].round(1)}" }.join(' ')
              first_point = points.first
              last_point = points.last
            %>
            <polyline class="trend-line-v2" stroke="url(#trend-gradient)" points="<%= points_str %>" />
            <% points.each_with_index do |p, i| %>
              <% health = @trend_data[i][:health] %>
              <circle cx="<%= p[0].round(1) %>" cy="<%= p[1].round(1) %>" r="4" class="trend-point-v2 trend-point-v2--<%= health %>" />
            <% end %>
          </svg>
        <% elsif @weeks_of_data == 1 %>
          <div class="metric-widget__no-data">1 week of data</div>
        <% else %>
          <div class="metric-widget__no-data">Insufficient data</div>
    <% end %>
      </div>
  </div>

    <!-- Confidence Widget -->
    <%
      confidence_hint = case @confidence_factors[:biggest_drag]
      when :variance
        "Volatile health trend"
      when :staleness
        "Data growing stale"
      when :coverage
        "Update coverage is uneven"
      when :insufficient_data
        "Building history..."
      else
        nil
      end
    %>
    <div class="metric-widget metric-widget--confidence metric-widget--confidence-<%= @confidence_level %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Confidence</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
            <div class="widget-info__tooltip">
              <div class="widget-info__methodology">Based on trend consistency, data freshness, and project coverage. Lower variance and recent updates increase confidence.</div>
              <div class="widget-info__range">
                <div>Range: 0–100</div>
                <div>High ≥70</div>
                <div>Medium ≥40</div>
                <div>Low &lt;40</div>
              </div>
              <div class="widget-info__score">Score: <%= @confidence_score %></div>
            </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <div class="confidence-ring">
          <svg viewBox="0 0 44 44">
            <circle class="confidence-ring__bg" cx="22" cy="22" r="18" />
            <% circumference = 2 * Math::PI * 18 %>
            <% offset = circumference - (@confidence_score / 100.0 * circumference) %>
            <circle class="confidence-ring__fill confidence-ring__fill--<%= @confidence_level %>"
                    cx="22" cy="22" r="18"
                    stroke-dasharray="<%= circumference.round(1) %>"
                    stroke-dashoffset="<%= offset.round(1) %>" />
          </svg>
        </div>
        <div class="metric-widget__text">
          <div class="metric-widget__label confidence-label--<%= @confidence_level %>"><%= @confidence_level.to_s.titleize %></div>
          <% if confidence_hint && @confidence_level != :high %>
            <span class="metric-widget__hint"><%= confidence_hint %></span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Search -->
  <%
    # Build flat list of all teams with ancestry for search
    all_teams_flat = []
    build_team_tree = ->(teams, ancestors = []) do
      teams.sort_by(&:name).each do |team|
        path = ancestors + [team.name]
        all_teams_flat << { entity: team, type: :team, path: path, record: TeamRecord.find_by(name: team.name) }
        build_team_tree.call(team.subordinate_teams, path) if team.subordinate_teams.any?
      end
    end
    build_team_tree.call(@teams)

    # Build flat list of all initiatives
    all_initiatives_flat = @initiatives.map do |initiative|
      { entity: initiative, type: :initiative, record: InitiativeRecord.find_by(name: initiative.name) }
    end

    # Build flat list of all projects
    all_projects_flat = @all_projects.map do |project|
      { entity: project, type: :project, record: ProjectRecord.find_by(name: project.name) }
    end
  %>
  <div class="global-search">
    <input type="text" class="global-search__input" placeholder="Find or create what you are looking for..." data-global-search autofocus>
    <div class="global-search__results-container" data-global-search-container>
      <div class="section section--search-results">
        <h3 class="section__title" data-results-header>Results</h3>
        <div class="section__columns" data-global-search-results>
          <!-- Teams Column -->
          <div class="section__column" data-results-column="teams">
            <h4 class="section__subtitle">Teams</h4>
            <ul class="section__list">
              <% all_teams_flat.each do |entry| %>
                <li class="section__item section__item--searchable"
                    data-search-type="team"
                    data-search-name="<%= entry[:entity].name.downcase %>"
                    data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                  <a href="<%= team_path(entry[:record]) %>" class="section__link">
                    <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                    <span class="section__name"><%= entry[:entity].name %></span>
                  </a>
                </li>
              <% end %>
            </ul>
          </div>

          <!-- Initiatives Column -->
          <div class="section__column" data-results-column="initiatives">
            <h4 class="section__subtitle">Initiatives</h4>
            <ul class="section__list">
              <% all_initiatives_flat.each do |entry| %>
                <li class="section__item section__item--searchable"
                    data-search-type="initiative"
                    data-search-name="<%= entry[:entity].name.downcase %>"
                    data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                  <a href="<%= initiative_path(entry[:record]) %>" class="section__link">
                    <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                    <span class="section__name"><%= entry[:entity].name %></span>
                  </a>
                </li>
              <% end %>
            </ul>
          </div>

          <!-- Projects Column -->
          <div class="section__column" data-results-column="projects">
            <h4 class="section__subtitle">Projects</h4>
            <ul class="section__list">
              <% all_projects_flat.each do |entry| %>
                <li class="section__item section__item--searchable"
                    data-search-type="project"
                    data-search-name="<%= entry[:entity].name.downcase %>"
                    data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                  <a href="<%= project_path(entry[:record]) %>" class="section__link">
                    <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                    <span class="section__name"><%= entry[:entity].name %></span>
                  </a>
                </li>
              <% end %>
            </ul>
          </div>
        </div>

        <!-- No Results / Create -->
        <div class="global-search__no-results" data-no-results hidden>
          <h3 class="section__title">Create Project</h3>
          <div class="global-search__form-card">
            <form action="<%= projects_path %>" method="post" class="global-search__create-form" data-create-form>
              <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
              <div class="global-search__form-fields-inline">
                <input type="text" name="project[name]" class="global-search__form-input" placeholder="Project Name (required)" data-create-name required>
                <input type="text" name="project[description]" class="global-search__form-input" placeholder="Description (highly recommended)">
                <input type="text" name="project[point_of_contact]" class="global-search__form-input" placeholder="Contacts (highly recommended)">
                <button type="submit" class="global-search__create-btn">Create Project</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Teams and Initiatives Columns -->
  <div class="sections">
    <div class="section section--compact">
      <% if @teams.any? %>
        <ul class="project-list-v2">
          <li class="project-item-v2 project-item-v2--header">
            <div class="team-item__grid team-item__grid--compact team-item__grid--header">
              <span class="team-item__col team-item__col--health section__title--grid">Teams</span>
              <span class="team-item__col team-item__col--name"></span>
              <span class="team-item__col team-item__col--trend team-item__header-label">Trend</span>
              <span class="team-item__col team-item__col--projects team-item__header-label">Projects</span>
              <span class="team-item__col team-item__col--stale team-item__header-label">Stale</span>
            </div>
          </li>
          <% @sorted_teams.each do |team| %>
            <%
              team_record = TeamRecord.find_by(name: team.name)
              team_info = @team_data[team.name] || {}
              trend = team_info[:trend_direction] || :stable
              projects_count = team_info[:projects_count] || 0
              stale_count = team_info[:stale_count] || 0
            %>
            <li class="project-item-v2">
              <a href="<%= team_path(team_record) %>" class="project-item-v2__link">
                <div class="team-item__grid team-item__grid--compact">
                  <span class="team-item__col team-item__col--health">
                    <span class="project-item-v2__health project-item-v2__health--<%= team.health || :not_available %>"></span>
                  </span>
                  <span class="team-item__col team-item__col--name"><%= team.name %></span>
                  <span class="team-item__col team-item__col--trend">
                    <%= trend_arrow_svg(trend) %>
                  </span>
                  <span class="team-item__col team-item__col--projects"><%= projects_count %></span>
                  <span class="team-item__col team-item__col--stale<%= ' team-item__col--stale-warning' if stale_count > 0 %>"><%= stale_count %></span>
                </div>
              </a>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="section__empty">No teams</p>
      <% end %>
      <% if @archived_teams.any? %>
        <details class="section__archived-details">
          <summary class="section__archived-summary">Archived (<%= @archived_teams.size %>)</summary>
          <ul class="section__list section__list--archived">
            <% @archived_teams.each do |team| %>
              <li class="section__item section__item--archived">
                <a href="<%= team_path(TeamRecord.find_by(name: team.name)) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--not_available"></span>
                  <span class="section__name"><%= team.name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </details>
      <% end %>
    </div>
    <div class="section section--compact">
      <% if @initiatives.any? %>
        <ul class="project-list-v2">
          <li class="project-item-v2 project-item-v2--header">
            <div class="team-item__grid team-item__grid--compact team-item__grid--header">
              <span class="team-item__col team-item__col--health section__title--grid">Initiatives</span>
              <span class="team-item__col team-item__col--name"></span>
              <span class="team-item__col team-item__col--trend team-item__header-label">Trend</span>
              <span class="team-item__col team-item__col--projects team-item__header-label">Projects</span>
              <span class="team-item__col team-item__col--stale team-item__header-label">Stale</span>
            </div>
          </li>
          <% @sorted_initiatives.each do |initiative| %>
            <%
              initiative_record = InitiativeRecord.find_by(name: initiative.name)
              initiative_info = @initiative_data[initiative.name] || {}
              trend = initiative_info[:trend_direction] || :stable
              projects_count = initiative_info[:projects_count] || 0
              stale_count = initiative_info[:stale_count] || 0
            %>
            <li class="project-item-v2">
              <a href="<%= initiative_path(initiative_record) %>" class="project-item-v2__link">
                <div class="team-item__grid team-item__grid--compact">
                  <span class="team-item__col team-item__col--health">
                    <span class="project-item-v2__health project-item-v2__health--<%= initiative.health || :not_available %>"></span>
                  </span>
                  <span class="team-item__col team-item__col--name"><%= initiative.name %></span>
                  <span class="team-item__col team-item__col--trend">
                    <%= trend_arrow_svg(trend) %>
                  </span>
                  <span class="team-item__col team-item__col--projects"><%= projects_count %></span>
                  <span class="team-item__col team-item__col--stale<%= ' team-item__col--stale-warning' if stale_count > 0 %>"><%= stale_count %></span>
                </div>
              </a>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="section__empty">No initiatives</p>
      <% end %>
      <% if @archived_initiatives.any? %>
        <details class="section__archived-details">
          <summary class="section__archived-summary">Archived (<%= @archived_initiatives.size %>)</summary>
          <ul class="section__list section__list--archived">
            <% @archived_initiatives.each do |initiative| %>
              <li class="section__item section__item--archived">
                <a href="<%= initiative_path(InitiativeRecord.find_by(name: initiative.name)) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--not_available"></span>
                  <span class="section__name"><%= initiative.name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </details>
      <% end %>
    </div>
  </div>

  <section class="section section--projects">
    <div class="section__title-row">
      <h3 class="section__title">Projects</h3>
      <div class="dashboard-tabs-v2">
        <button class="dashboard-tab-v2" data-tab="all">
          All <span class="dashboard-tab-v2__count"><%= @all_projects.size %></span>
        </button>
        <button class="dashboard-tab-v2" data-tab="attention">
          Unhealthy <span class="dashboard-tab-v2__count"><%= @attention_required.size %></span>
        </button>
        <button class="dashboard-tab-v2" data-tab="update">
          Stale <span class="dashboard-tab-v2__count"><%= @never_updated_projects.size + @stale_projects_14.size + @stale_projects_7.size %></span>
        </button>
        <button class="dashboard-tab-v2" data-tab="projects">
          Active <span class="dashboard-tab-v2__count"><%= @active_projects.size %></span>
        </button>
        <button class="dashboard-tab-v2" data-tab="inactive">
          Inactive <span class="dashboard-tab-v2__count"><%= @inactive_projects.size %></span>
        </button>
        <button class="dashboard-tab-v2" data-tab="manage">
          Unowned <span class="dashboard-tab-v2__count"><%= @orphan_projects.size %></span>
        </button>
      </div>
    </div>

    <%
      stale_project_names = (@stale_projects_14 + @stale_projects_7 + @never_updated_projects).map(&:name)
    %>

    <!-- Tab Content: All Projects -->
    <div class="tab-content-v2" data-tab-content="all">
      <% if @all_projects.empty? %>
        <div class="tab-empty-v2">No projects</div>
      <% else %>
        <ul class="project-list-v2">
          <%= render 'project_list_header' %>
          <% @sorted_all_projects.each do |project| %>
            <%= render 'project_list_item', project: project %>
          <% end %>
        </ul>
      <% end %>
    </div>

    <!-- Tab Content: Needs Attention -->
    <div class="tab-content-v2" data-tab-content="attention">
      <% if @attention_required.empty? && @on_hold_projects.empty? %>
        <div class="tab-empty-v2">Everything is on track!</div>
      <% else %>
        <% if @attention_required.any? %>
          <ul class="project-list-v2">
            <%= render 'project_list_header' %>
            <% @sorted_attention_required.each do |project| %>
              <% tag_text = project.current_state == :blocked ? 'Blocked' : nil %>
              <% tag_modifier = project.current_state == :blocked ? 'blocked' : nil %>
              <%= render 'project_list_item',
                        project: project,
                        tag_text: tag_text,
                        tag_modifier: tag_modifier %>
            <% end %>
          </ul>
        <% end %>
      <% end %>
    </div>

    <!-- Tab Content: Needs Update -->
    <div class="tab-content-v2" data-tab-content="update">
      <% if @never_updated_projects.empty? && @stale_projects_14.empty? && @stale_projects_7.empty? %>
        <div class="tab-empty-v2">Everything is up to date!</div>
      <% else %>
        <% if @never_updated_projects.any? %>
          <ul class="project-list-v2">
            <%= render 'project_list_header' %>
            <% @sorted_never_updated_projects.each do |project| %>
              <%= render 'project_list_item',
                        project: project,
                        tag_text: 'Stale',
                        tag_modifier: 'stale' %>
            <% end %>
          </ul>
        <% end %>
        <% if @stale_projects_14.any? %>
          <ul class="project-list-v2">
            <%= render 'project_list_header' %>
            <% @sorted_stale_projects_14.each do |project| %>
              <%= render 'project_list_item',
                        project: project,
                        tag_text: 'Stale',
                        tag_modifier: 'stale' %>
            <% end %>
          </ul>
        <% end %>
        <% if @stale_projects_7.any? %>
          <ul class="project-list-v2">
            <%= render 'project_list_header' %>
            <% @sorted_stale_projects_7.each do |project| %>
              <%= render 'project_list_item',
                        project: project,
                        tag_text: 'Stale',
                        tag_modifier: 'stale' %>
            <% end %>
          </ul>
        <% end %>
      <% end %>
    </div>

    <!-- Tab Content: Active Projects -->
    <div class="tab-content-v2" data-tab-content="projects">
      <% if @active_projects.empty? %>
        <div class="tab-empty-v2">No active projects</div>
      <% else %>
        <ul class="project-list-v2">
          <%= render 'project_list_header' %>
          <% @sorted_active_projects.each do |project| %>
            <% tag_text = nil %>
            <% tag_modifier = nil %>
            <% if project.current_state == :blocked %>
              <% tag_text = 'Blocked' %>
              <% tag_modifier = 'blocked' %>
            <% elsif stale_project_names.include?(project.name) %>
              <% tag_text = 'Stale' %>
              <% tag_modifier = 'stale' %>
            <% end %>
            <%= render 'project_list_item',
                      project: project,
                      tag_text: tag_text,
                      tag_modifier: tag_modifier,
                      ref: 'dashboard' %>
          <% end %>
        </ul>
      <% end %>
    </div>

    <!-- Tab Content: Inactive Projects -->
    <div class="tab-content-v2" data-tab-content="inactive">
      <% if @inactive_projects.empty? %>
        <div class="tab-empty-v2">No inactive projects</div>
      <% else %>
        <ul class="project-list-v2">
          <%= render 'project_list_header' %>
          <% @sorted_inactive_projects.each do |project| %>
            <% tag_text = project.current_state.to_s.tr('_', ' ').titleize %>
            <%= render 'project_list_item',
                      project: project,
                      tag_text: tag_text,
                      tag_modifier: 'inactive',
                      health: project.health || :not_available %>
          <% end %>
        </ul>
      <% end %>
    </div>

    <!-- Tab Content: Unowned -->
    <div class="tab-content-v2" data-tab-content="manage">
      <% if @orphan_projects.any? %>
        <ul class="project-list-v2">
          <%= render 'project_list_header' %>
          <% @sorted_orphan_projects.each do |project| %>
            <%= render 'project_list_item',
                      project: project,
                      health: project.health || :not_available %>
          <% end %>
        </ul>
      <% else %>
        <div class="tab-empty-v2">No unowned projects</div>
      <% end %>
    </div>
  </section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Tab toggle behavior
    const tabs = document.querySelectorAll('.dashboard-tab-v2');
    const tabContents = document.querySelectorAll('.tab-content-v2');

    function openTab(tabName) {
      const tab = document.querySelector(`.dashboard-tab-v2[data-tab="${tabName}"]`);
      const content = document.querySelector(`[data-tab-content="${tabName}"]`);

      // Close all tabs
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));

      // Open the requested tab
      tab?.classList.add('active');
      content?.classList.add('active');
    }

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        const isActive = tab.classList.contains('active');

        if (isActive) {
          // Close if already active
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
        } else {
          openTab(tabName);
        }
      });
    });

    // Urgent action badge click opens tab
    document.querySelectorAll('[data-open-tab]').forEach((btn) => {
      btn.addEventListener('click', () => {
        openTab(btn.dataset.openTab);
      });
    });

    // Global search functionality
    const globalSearch = document.querySelector('[data-global-search]');
    const searchContainer = document.querySelector('[data-global-search-container]');
    const searchResultsBox = document.querySelector('.section--search-results');

    if (globalSearch && searchContainer && searchResultsBox) {
      const columns = searchResultsBox.querySelectorAll('[data-results-column]');
      const noResultsEl = searchResultsBox.querySelector('[data-no-results]');
      const createNameInput = searchResultsBox.querySelector('[data-create-name]');
      const resultsGrid = searchResultsBox.querySelector('.section__columns');
      const resultsHeader = searchResultsBox.querySelector('[data-results-header]');

      globalSearch.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        const queryLower = query.toLowerCase();

        if (query === '') {
          searchContainer.classList.remove('open');
          return;
        }

        // Show search results with animation
        searchContainer.classList.add('open');

        // Filter results by name and point of contact only
        let totalVisible = 0;

        columns.forEach((column) => {
          const items = column.querySelectorAll('.section__item--searchable');
          let columnVisible = 0;

          items.forEach((item) => {
            const name = item.dataset.searchName || '';
            const poc = item.dataset.searchPoc || '';
            const matches = name.includes(queryLower) || poc.includes(queryLower);
            item.hidden = !matches;
            if (matches) columnVisible++;
          });

          // Hide entire column if no matches
          column.hidden = columnVisible === 0;

          totalVisible += columnVisible;
        });

        // Show create option if no results across all columns
        if (noResultsEl) {
          noResultsEl.hidden = totalVisible > 0;
          // Capitalize only the first word of the search term
          const capitalizedQuery = query.charAt(0).toUpperCase() + query.slice(1);
          if (createNameInput) createNameInput.value = capitalizedQuery;
        }

        // Hide results grid and header if no results, show create prompt
        if (resultsGrid) {
          resultsGrid.hidden = totalVisible === 0;
        }
        if (resultsHeader) {
          resultsHeader.hidden = totalVisible === 0;
        }
      });

      // Close search results when clicking outside
      document.addEventListener('click', (e) => {
        const globalSearchEl = document.querySelector('.global-search');
        if (globalSearchEl && !globalSearchEl.contains(e.target)) {
          searchContainer.classList.remove('open');
          globalSearch.value = '';
        }
      });

      // Close on Escape
      globalSearch.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchContainer.classList.remove('open');
          globalSearch.value = '';
          globalSearch.blur();
        }
      });

      // Handle create project form submission via AJAX
      const createForm = searchResultsBox.querySelector('[data-create-form]');
      if (createForm) {
        createForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = new FormData(createForm);
          const submitBtn = createForm.querySelector('.global-search__create-btn');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = 'Creating...';
          submitBtn.disabled = true;

          try {
            const response = await fetch(createForm.action, {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'X-CSRF-Token': formData.get('authenticity_token')
              },
              body: formData
            });

            const data = await response.json();

            if (response.ok) {
              // Show success toast
              showToast(`<a href="${data.url}">"${data.name}"</a> created!`, 'success');

              // Close search and reset
              searchContainer.classList.remove('open');
              globalSearch.value = '';
              createForm.reset();
            } else {
              // Show error toast
              const errorMsg = data.errors ? data.errors.join(', ') : 'Failed to create project';
              showToast(errorMsg, 'error');
            }
          } catch (error) {
            showToast('An error occurred. Please try again.', 'error');
          } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });
      }
    }

    // Toast notification function
    function showToast(message, type = 'success') {
      const container = document.querySelector('[data-toast-container]');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast toast--${type}`;
      toast.innerHTML = message;

      container.appendChild(toast);

      // Trigger animation
      requestAnimationFrame(() => {
        toast.classList.add('toast--visible');
      });

      // Auto-remove after 10 seconds
      setTimeout(() => {
        toast.classList.remove('toast--visible');
        setTimeout(() => toast.remove(), 300);
      }, 10000);

      // Click to dismiss
      toast.addEventListener('click', (e) => {
        if (e.target.tagName !== 'A') {
          toast.classList.remove('toast--visible');
          setTimeout(() => toast.remove(), 300);
        }
      });
    }
  });
</script>
