<turbo-frame id="child-projects-section">
<%
  project = local_assigns[:project]
  project_record = local_assigns[:project_record]
  health_updates = local_assigns[:health_updates] || []

  has_children = project.respond_to?(:children) && project.children.any?
  has_health_updates = health_updates.any?

  # Show child projects if: has children OR has neither (empty project)
  return if has_health_updates && !has_children

  all_children = project.children
  direct_children = all_children.reject { |p| p.respond_to?(:archived?) && p.archived? }
  archived_projects = all_children.select { |p| p.respond_to?(:archived?) && p.archived? }
  sorted_descendants = sort_projects_canonical(direct_children)
  sorted_archived = sort_projects_canonical(archived_projects)

  # Determine list type based on first child (all children should be same type)
  first_child = direct_children.first
  list_type = (first_child && first_child.respond_to?(:children) && first_child.children.any?) ? :parent : :leaf
%>

<section class="section section--projects" data-controller="inline-form">
  <div class="section__header">
    <h3 class="section__title">Child Projects</h3>
    <div class="section__actions">
      <button class="dashboard-tab-v2 dashboard-tab-v2--add"
              data-inline-form-target="toggle"
              data-action="inline-form#toggle"
              aria-label="Create child project">+</button>
      <div class="info-tooltip">
        <span class="info-tooltip__icon">i</span>
        <div class="info-tooltip__tooltip">
          <div class="info-tooltip__methodology">Projects can either contain child projects or track health updates directly — not both.</div>
          <div class="info-tooltip__range">
            <div>• Parent projects aggregate health from children</div>
            <div>• Leaf projects track their own health updates</div>
            <div>• Adding a child makes this a parent project</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Child Project Form (inline) -->
  <div class="inline-create-section" data-inline-form-target="section" hidden>
    <%= form_with url: subordinates_project_path(project_record), method: :post, local: false, class: "inline-create-form" do |f| %>
      <div class="inline-create-form__row">
        <input type="text" name="project[name]" class="inline-create-form__input" placeholder="Project Name (required)" required>
        <input type="text" name="project[description]" class="inline-create-form__input" placeholder="Brief Description (highly recommended)">
        <input type="text" name="project[point_of_contact]" class="inline-create-form__input" placeholder="Contacts (highly recommended)">
        <button type="submit" class="btn btn--small">Create Child Project</button>
      </div>
    <% end %>
  </div>

  <% if direct_children.empty? && archived_projects.empty? %>
    <div class="tab-empty-v2">No child projects</div>
  <% else %>
    <% if direct_children.any? %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header', list_type: list_type %>
        <% sorted_descendants.each do |child_project| %>
          <%= render 'dashboard/project_list_item', project: child_project, list_type: list_type %>
        <% end %>
      </ul>
    <% end %>

    <% if archived_projects.any? %>
      <details class="section__archived-details">
        <summary class="section__archived-summary">Archived (<%= archived_projects.size %>)</summary>
        <ul class="project-list-v2" style="margin-top: 8px;">
          <% sorted_archived.each do |child_project| %>
            <%= render 'dashboard/project_list_item', project: child_project, list_type: list_type, tag_text: 'Archived', tag_modifier: 'archived' %>
          <% end %>
        </ul>
      </details>
    <% end %>
  <% end %>
</section>
</turbo-frame>
