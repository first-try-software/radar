<turbo-frame id="child-projects-section">
<%
  project = local_assigns[:project]
  project_record = local_assigns[:project_record]
  health_updates = local_assigns[:health_updates] || []

  has_children = project.respond_to?(:children) && project.children.any?
  has_health_updates = health_updates.any?

  # Show child projects if: has children OR has neither (empty project)
  return if has_health_updates && !has_children

  all_children = project.children
  direct_children = all_children.reject { |p| p.respond_to?(:archived?) && p.archived? }
  archived_projects = all_children.select { |p| p.respond_to?(:archived?) && p.archived? }
  sorted_descendants = sort_projects_canonical(direct_children)
  sorted_archived = sort_projects_canonical(archived_projects)

  # Determine list type based on first child (all children should be same type)
  first_child = direct_children.first
  list_type = (first_child && first_child.respond_to?(:children) && first_child.children.any?) ? :parent : :leaf

  unhealthy = direct_children.select { |p| [:off_track, :at_risk].include?(p.health) }
  sorted_unhealthy = sort_projects_canonical(unhealthy)

  stale = direct_children.select do |p|
    next false unless [:in_progress, :blocked].include?(p.current_state)
    latest = p.latest_health_update
    latest.nil? || (Date.current - latest.date.to_date).to_i > 7
  end
  sorted_stale = sort_projects_canonical(stale)

  active_states = [:new, :in_progress, :blocked]
  inactive_states = [:completed, :paused, :cancelled]

  active_projects = direct_children.select { |p| active_states.include?(p.current_state) }
  sorted_active = sort_projects_canonical(active_projects)

  inactive_projects = direct_children.select { |p| inactive_states.include?(p.current_state) }
  sorted_inactive = sort_projects_canonical(inactive_projects)
%>

<section class="section section--projects" data-controller="tabs inline-form" data-tabs-active-value="all">
  <div class="section__title-row">
    <h3 class="section__title">Child Projects</h3>
    <div class="dashboard-tabs-v2">
      <button class="dashboard-tab-v2 active" data-tabs-target="tab" data-tabs-name="all" data-action="tabs#switch">
        All <span class="dashboard-tab-v2__count"><%= direct_children.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="unhealthy" data-action="tabs#switch">
        Unhealthy <span class="dashboard-tab-v2__count"><%= unhealthy.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="stale" data-action="tabs#switch">
        Stale <span class="dashboard-tab-v2__count"><%= stale.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="active" data-action="tabs#switch">
        Active <span class="dashboard-tab-v2__count"><%= active_projects.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="inactive" data-action="tabs#switch">
        Inactive <span class="dashboard-tab-v2__count"><%= inactive_projects.size %></span>
      </button>
      <% if archived_projects.any? %>
        <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="archived" data-action="tabs#switch">
          Archived <span class="dashboard-tab-v2__count"><%= archived_projects.size %></span>
        </button>
      <% end %>
      <button class="dashboard-tab-v2 dashboard-tab-v2--add"
              data-inline-form-target="toggle"
              data-action="inline-form#toggle"
              aria-label="Create child project">+</button>
      <div class="info-tooltip">
        <span class="info-tooltip__icon">i</span>
        <div class="info-tooltip__tooltip">
          <div class="info-tooltip__methodology">Projects can either contain child projects or track health updates directly — not both.</div>
          <div class="info-tooltip__range">
            <div>• Parent projects aggregate health from children</div>
            <div>• Leaf projects track their own health updates</div>
            <div>• Adding a child makes this a parent project</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Child Project Form (inline) -->
  <div class="inline-create-section" data-inline-form-target="section" hidden>
    <%= form_with url: subordinates_project_path(project_record), method: :post, local: false, class: "inline-create-form" do |f| %>
      <div class="inline-create-form__row">
        <input type="text" name="project[name]" class="inline-create-form__input" placeholder="Project Name (required)" required>
        <input type="text" name="project[description]" class="inline-create-form__input" placeholder="Brief Description (highly recommended)">
        <input type="text" name="project[point_of_contact]" class="inline-create-form__input" placeholder="Contacts (highly recommended)">
        <button type="submit" class="btn btn--small">Create Child Project</button>
      </div>
    <% end %>
  </div>

  <!-- Tab Content: All -->
  <div class="tab-content-v2 active" data-tabs-target="content" data-tabs-name="all">
    <% if direct_children.empty? %>
      <div class="tab-empty-v2">No child projects</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header', list_type: list_type %>
        <% sorted_descendants.each do |child_project| %>
          <%= render 'dashboard/project_list_item', project: child_project, list_type: list_type %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Unhealthy -->
  <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="unhealthy">
    <% if unhealthy.empty? %>
      <div class="tab-empty-v2">All child projects are healthy!</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header', list_type: list_type %>
        <% sorted_unhealthy.each do |child_project| %>
          <%= render 'dashboard/project_list_item', project: child_project, list_type: list_type %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Stale -->
  <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="stale">
    <% if stale.empty? %>
      <div class="tab-empty-v2">All child projects are up to date!</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header', list_type: list_type %>
        <% sorted_stale.each do |child_project| %>
          <%= render 'dashboard/project_list_item', project: child_project, list_type: list_type, tag_text: 'Stale', tag_modifier: 'stale' %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Active -->
  <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="active">
    <% if active_projects.empty? %>
      <div class="tab-empty-v2">No active child projects</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header', list_type: list_type %>
        <% sorted_active.each do |child_project| %>
          <% tag_text = child_project.current_state == :blocked ? 'Blocked' : nil %>
          <% tag_modifier = child_project.current_state == :blocked ? 'blocked' : nil %>
          <%= render 'dashboard/project_list_item', project: child_project, list_type: list_type, tag_text: tag_text, tag_modifier: tag_modifier %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Inactive -->
  <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="inactive">
    <% if inactive_projects.empty? %>
      <div class="tab-empty-v2">No inactive child projects</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header', list_type: list_type %>
        <% sorted_inactive.each do |child_project| %>
          <% tag_text = child_project.current_state.to_s.tr('_', ' ').titleize %>
          <%= render 'dashboard/project_list_item', project: child_project, list_type: list_type, tag_text: tag_text, tag_modifier: 'inactive' %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Archived -->
  <% if archived_projects.any? %>
    <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="archived">
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header', list_type: list_type %>
        <% sorted_archived.each do |child_project| %>
          <%= render 'dashboard/project_list_item', project: child_project, list_type: list_type, tag_text: 'Archived', tag_modifier: 'archived' %>
        <% end %>
      </ul>
    </div>
  <% end %>
</section>
</turbo-frame>
