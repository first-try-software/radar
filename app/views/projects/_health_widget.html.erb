<%
  project = local_assigns[:project]
  project_health = local_assigns[:project_health]
  health_summary = local_assigns[:health_summary]

  is_leaf = project.respond_to?(:children) ? project.children.empty? : true
  health = project_health || project.health || :not_available
  health_class = health.to_s.tr('_', '-')

  raw_score = health_summary&.dig(:raw_score)
  raw_score_display = raw_score ? (raw_score >= 0 ? "+#{raw_score.round(2)}" : raw_score.round(2).to_s) : "N/A"

  if !is_leaf
    children = project.children || []
    active_states = [:in_progress, :blocked]
    active_children = children.select { |p| active_states.include?(p.current_state) }
    off_track_active = active_children.select { |p| p.health == :off_track }
    off_track_count = off_track_active.size
    active_count = active_children.size
  end
%>
<div id="health-widget" class="metric-widget metric-widget--health metric-widget--<%= health_class %>">
  <div class="metric-widget__title-row">
    <span class="metric-widget__title">Current Health</span>
    <div class="info-tooltip">
      <span class="info-tooltip__icon">i</span>
      <div class="info-tooltip__tooltip">
        <% if is_leaf %>
          <div class="info-tooltip__methodology">Based on the most recent health update for this project.</div>
        <% else %>
          <div class="info-tooltip__methodology">Average of all leaf-node project health scores.</div>
        <% end %>
        <div class="info-tooltip__range">
          <div>On Track = +1</div>
          <div>At Risk = 0</div>
          <div>Off Track = âˆ’1</div>
        </div>
        <div class="info-tooltip__score">Score: <%= raw_score_display %></div>
      </div>
    </div>
  </div>
  <div class="metric-widget__content">
    <span class="metric-widget__dot metric-widget__dot--<%= health_class %>"></span>
    <div class="metric-widget__text">
      <div class="metric-widget__label metric-widget__label--<%= health_class %>"><%= health.to_s.tr('_', ' ').titleize %></div>
      <% if !is_leaf && off_track_count && off_track_count > 0 %>
        <div class="metric-widget__detail"><%= off_track_count %> of <%= active_count %> child <%= 'project'.pluralize(active_count) %> off-track</div>
      <% end %>
    </div>
  </div>
</div>
