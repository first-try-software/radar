<%
  data = project_data[project.id] || {}
  domain_project = data[:project]
  project_health = data[:health] || :not_available
  health_class = project_health.to_s.tr('_', '-')
  total_children = data[:total_children] || 0
  active_children = data[:active_children] || 0
  trend_data = data[:trend_data] || []
  trend_direction = data[:trend_direction] || :stable
  weeks_of_data = data[:weeks_of_data] || 0
  confidence_score = data[:confidence_score] || 0
  confidence_level = data[:confidence_level] || :low
  # Use domain project's current_state which derives state from children for parent projects
  display_state = domain_project&.current_state || project.current_state

  trend_class = weeks_of_data >= 2 ? "trend-#{trend_direction}" : 'trend-insufficient'
  gradient_id = "trend-gradient-project-#{project.id}"
%>

<a href="<%= project_path(project) %>" class="project-index-card">
  <div class="project-index-card__header-row">
    <div class="project-header-v2">
      <div class="project-name-v2"><%= project.name %></div>
      <div class="project-meta-v2">
        <span class="badge state state--<%= display_state.to_s.tr('_', '-') %>"><%= display_state.to_s.tr('_', ' ').upcase %></span>
        <% if total_children > 0 %>
          <span class="project-child-count"><%= active_children %> active / <%= total_children %> projects</span>
        <% end %>
        <% if project.archived %>
          <span class="badge archived">archived</span>
        <% end %>
      </div>
    </div>

    <!-- Health Widget -->
    <div class="metric-widget metric-widget--health metric-widget--<%= health_class %> project-health--<%= project_health %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Current Health</span>
      </div>
      <div class="metric-widget__content">
        <span class="metric-widget__dot metric-widget__dot--<%= health_class %>"></span>
        <div class="metric-widget__text">
          <div class="metric-widget__label metric-widget__label--<%= health_class %>"><%= project_health == :not_available ? 'N/A' : project_health.to_s.tr('_', ' ').titleize %></div>
        </div>
      </div>
    </div>

    <!-- Trend Widget -->
    <div class="metric-widget metric-widget--trend metric-widget--<%= trend_class %>">
      <div class="metric-widget__header">
        <span class="metric-widget__title">6-Week Trend</span>
      </div>
      <div class="metric-widget__chart">
        <% if weeks_of_data >= 2 %>
          <svg viewBox="0 0 200 50" preserveAspectRatio="none" class="trend-svg">
            <defs>
              <linearGradient id="<%= gradient_id %>" x1="0%" y1="0%" x2="100%" y2="0%">
                <% trend_data.each_with_index do |point, i| %>
                  <% offset = (i.to_f / [trend_data.length - 1, 1].max * 100).round %>
                  <% color = point[:health] == :on_track ? '#22c55e' : (point[:health] == :off_track ? '#ef4444' : '#f59e0b') %>
                  <stop offset="<%= offset %>%" stop-color="<%= color %>" />
                <% end %>
              </linearGradient>
            </defs>
            <%
              points = trend_data.each_with_index.map do |point, i|
                x = (i.to_f / [trend_data.length - 1, 1].max * 180) + 10
                y = 45 - ((point[:score] + 1) / 2.0 * 40)
                [x, y]
              end
              points_str = points.map { |p| "#{p[0].round(1)},#{p[1].round(1)}" }.join(' ')
              first_point = points.first
              last_point = points.last
            %>
            <line class="trend-line-dotted"
                  x1="<%= first_point[0].round(1) %>" y1="<%= first_point[1].round(1) %>"
                  x2="<%= last_point[0].round(1) %>" y2="<%= last_point[1].round(1) %>" />
            <polyline class="trend-line-v2" stroke="url(#<%= gradient_id %>)" points="<%= points_str %>" />
            <% points.each_with_index do |p, i| %>
              <% health = trend_data[i][:health] %>
              <circle cx="<%= p[0].round(1) %>" cy="<%= p[1].round(1) %>" r="4" class="trend-point-v2 trend-point-v2--<%= health %>" />
            <% end %>
          </svg>
        <% elsif weeks_of_data == 1 %>
          <div class="metric-widget__no-data">1 week of data</div>
        <% else %>
          <div class="metric-widget__no-data">Insufficient data</div>
        <% end %>
      </div>
    </div>

    <!-- Confidence Widget -->
    <div class="metric-widget metric-widget--confidence metric-widget--confidence-<%= confidence_level %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Confidence</span>
      </div>
      <div class="metric-widget__content">
        <div class="confidence-ring">
          <svg viewBox="0 0 44 44">
            <circle class="confidence-ring__bg" cx="22" cy="22" r="18" />
            <% circumference = 2 * Math::PI * 18 %>
            <% offset = circumference - (confidence_score / 100.0 * circumference) %>
            <circle class="confidence-ring__fill confidence-ring__fill--<%= confidence_level %>"
                    cx="22" cy="22" r="18"
                    stroke-dasharray="<%= circumference.round(1) %>"
                    stroke-dashoffset="<%= offset.round(1) %>" />
          </svg>
        </div>
        <div class="metric-widget__text">
          <div class="metric-widget__label confidence-label--<%= confidence_level %>"><%= confidence_level.to_s.titleize %></div>
        </div>
      </div>
    </div>
  </div>
</a>
