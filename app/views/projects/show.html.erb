<nav class="breadcrumbs" aria-label="Breadcrumb">
  <ol>
    <% ref_crumb = breadcrumb_from_ref(params[:ref]) %>
    <% if ref_crumb %>
      <li><%= link_to ref_crumb[:name], ref_crumb[:path] %></li>
    <% else %>
      <li><%= link_to 'Projects', projects_path %></li>
      <% ancestors = [] %>
      <% current = @project_record.parent %>
      <% while current do %>
        <% ancestors.unshift(current) %>
        <% current = current.parent %>
      <% end %>
      <% ancestors.each do |ancestor| %>
        <li><%= link_to ancestor.name, project_path(ancestor) %></li>
      <% end %>
    <% end %>
    <li aria-current="page"><%= @project_record.name %></li>
  </ol>
</nav>

<div class="grid">
  <div class="card">
    <% allowed_states = SetProjectState::SETTABLE_STATES %>
    <div class="project-header">
      <% if @project_record.children.empty? %>
        <button type="button" class="health-toggle-button" data-health-toggle>
          <div class="project-header__health">
            <%= project_health_indicator(@project || @project_record, with_tooltip: true) %>
          </div>
        </button>
      <% else %>
        <div class="health-toggle-placeholder">
          <div class="project-header__health">
            <%= project_health_indicator(@project || @project_record, with_tooltip: true) %>
          </div>
        </div>
      <% end %>
      <div class="project-header__text">
        <div class="editable-field project-name"
             contenteditable="true"
             data-field="name"
             data-update-url="<%= project_path(@project_record) %>"><%= @project_record.name %></div>

        <div class="editable-field project-description<%= ' editable-field--empty' if @project_record.description.blank? %>"
             contenteditable="true"
             data-field="description"
             data-hint="What is this project about?"
             data-update-url="<%= project_path(@project_record) %>"><%= @project_record.description.presence || 'What is this project about?' %></div>

        <div class="editable-field project-poc<%= ' editable-field--empty' if @project_record.point_of_contact.blank? %>"
             contenteditable="true"
             data-field="point_of_contact"
             data-hint="Where can I get more information (person, email, slack channel, etc.)?"
             data-update-url="<%= project_path(@project_record) %>"><%= @project_record.point_of_contact.presence || 'Where can I get more information (person, email, slack channel, etc.)?' %></div>
        <% if @project && project_health_trend(@project, interactive: @project_record.children.empty?) %>
          <%= project_health_trend(@project, interactive: @project_record.children.empty?) %>
        <% end %>
        <% if @project_record.children.empty? %>
          <% health_form_classes = ['project-header__health-update'] %>
          <% health_form_classes << 'open' if @show_health_update_form %>
          <div class="<%= health_form_classes.join(' ') %>" data-health-update-form>
            <%= form_with model: HealthUpdateRecord.new,
                          url: health_updates_project_path(@project_record),
                          method: :post,
                          scope: :health_update,
                          local: true,
                          html: { class: 'health-update-form', data: { turbo: false } } do |form| %>
              <div class="health-update-fields">
                <div class="health-select" data-health-select>
                  <%= form.hidden_field :health, value: @selected_health, data: { health_select_value: true } %>
                  <button type="button" class="health-select__toggle" data-health-select-toggle>
                    <span class="project-health project-health--<%= @selected_health %> project-health--small" aria-hidden="true"></span>
                    <span class="health-select__label"><%= @selected_health.to_s.tr('_', ' ').titleize %></span>
                  </button>
                  <div class="health-select__menu" data-health-select-menu>
                    <% @health_options.each do |option| %>
                      <button type="button"
                              class="health-select__option"
                              data-health-option="<%= option %>">
                        <span class="project-health project-health--<%= option %> project-health--small" aria-hidden="true"></span>
                        <span><%= option.to_s.tr('_', ' ').titleize %></span>
                      </button>
                    <% end %>
                  </div>
                </div>
                <%= form.date_field :date, value: Date.current, required: true, class: 'health-date-field' %>
                <%= form.text_field :description, placeholder: 'Description (optional)', class: 'health-description-field' %>
                <%= form.submit 'Add', class: 'btn' %>
              </div>
            <% end %>
          </div>
        <% end %>
        <% if defined?(@errors) && @errors.present? %>
          <div class="errors">
            <ul>
              <% @errors.each do |err| %>
                <li><%= err %></li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
      <div class="project-header__state project-header__state--with-archive">
        <% leaf_count = @project ? @project.leaf_descendants.count : 0 %>
        <div class="state-dropdown" data-state-url="<%= state_project_path(@project_record) %>" data-leaf-count="<%= leaf_count %>">
          <button class="state-toggle" type="button">
            <span class="badge state"><%= (@project || @project_record).current_state.to_s.tr('_', ' ').titleize %></span>
          </button>
          <div class="state-menu">
            <% if allowed_states.any? %>
              <% allowed_states.each do |state| %>
                <button type="button" data-state="<%= state %>"><%= state.to_s.tr('_', ' ').titleize %></button>
              <% end %>
            <% else %>
              <div class="empty">No further transitions</div>
            <% end %>
          </div>
        </div>
        <% if @project_record.archived %>
          <button type="button"
                  class="unarchive-btn"
                  data-unarchive-url="<%= unarchive_project_path(@project_record) %>"
                  data-project-name="<%= @project_record.name %>"
                  aria-label="Unarchive <%= @project_record.name %>">Unarchive</button>
        <% else %>
          <button type="button"
                  class="archive-btn"
                  data-archive-url="<%= archive_project_path(@project_record) %>"
                  data-project-name="<%= @project_record.name %>"
                  aria-label="Archive <%= @project_record.name %>">Archive</button>
        <% end %>
      </div>
    </div>

  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="section-title children-title">Projects</h3>
      <% visible_children = @project_record.children.reject(&:archived) %>
      <% if visible_children.any? %>
        <div class="sort-controls" data-sort-controls data-sortable-list="children-list">
          <div class="sort-dropdown" data-sort-dropdown>
            <button type="button" class="sort-dropdown__trigger" data-sort-trigger>
              <span class="sort-dropdown__label">Sort: <strong data-sort-label>Alphabet</strong></span>
              <span class="sort-dropdown__arrow">▼</span>
            </button>
            <div class="sort-dropdown__menu" data-sort-menu hidden>
              <% [['alphabet', 'Alphabet'], ['state', 'State'], ['health', 'Health'], ['updated', 'Updated']].each do |value, label| %>
                <button type="button"
                        class="sort-dropdown__option <%= 'active' if value == 'alphabet' %>"
                        data-sort-value="<%= value %>">
                  <%= label %>
                  <% if value == 'alphabet' %><span class="sort-dropdown__check">✓</span><% end %>
                </button>
              <% end %>
            </div>
          </div>
          <button type="button"
                  class="sort-dir-toggle asc"
                  data-sort-dir-toggle
                  data-current-dir="asc"
                  title="Ascending">
            <span class="sort-dir-toggle__arrow">↑</span>
          </button>
        </div>
      <% end %>
    </div>
    <ul class="list children-list" data-sortable-list="children-list">
      <%= render partial: 'projects/child_project_item', collection: visible_children, as: :project, locals: { parent: @project_record } %>
      <% if visible_children.empty? %>
        <li class="list-item"><span class="muted">No children yet.</span></li>
      <% end %>
      <% orphan_projects = ProjectRecord.where(archived: false).left_joins(:parent_relationship).where(projects_projects: { id: nil }).where.not(id: @project_record.id).order(:name) %>
      <li class="list-item list-item--add-child">
        <form action="<%= subordinates_project_path(@project_record) %>"
              method="post"
              class="child-form"
              data-add-link-form
              data-add-url="<%= subordinates_project_path(@project_record) %>"
              data-link-url="<%= link_subordinate_project_path(@project_record) %>">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <input type="hidden" name="project[name]" value="" data-project-name-field />
          <input type="hidden" name="child_id" value="" data-child-id-field />
          <div class="child-actions">
            <div class="project-dropdown" data-project-dropdown>
              <div class="project-dropdown__input-wrapper">
                <input type="text"
                       class="project-dropdown__input"
                       placeholder="Add or link a project..."
                       data-project-dropdown-input
                       autocomplete="off" />
                <% if orphan_projects.any? %>
                  <span class="project-dropdown__arrow">▼</span>
                <% end %>
              </div>
              <% if orphan_projects.any? %>
                <div class="project-dropdown__menu" data-project-dropdown-menu>
                  <div class="project-dropdown__options" data-project-options>
                    <% orphan_projects.each do |project| %>
                      <button type="button"
                              class="project-dropdown__option"
                              data-project-id="<%= project.id %>"
                              data-project-name="<%= project.name %>"
                              data-project-search-text="<%= project.name.downcase %>">
                        <span class="project-dropdown__option-name"><%= project.name %></span>
                        <% if project.description.present? %>
                          <span class="project-dropdown__option-desc"><%= truncate(project.description, length: 50) %></span>
                        <% end %>
                      </button>
                    <% end %>
                  </div>
                  <div class="project-dropdown__no-results" data-no-results hidden>
                    No matches — press Add to create
                  </div>
                </div>
              <% end %>
            </div>
            <button type="submit" class="btn secondary" data-add-link-submit>Add</button>
          </div>
        </form>
      </li>
    </ul>
  </div>
</div>

<div class="modal-overlay" data-state-confirm-modal hidden>
  <div class="modal">
    <div class="modal__header">
      <h3>Confirm State Change</h3>
    </div>
    <div class="modal__body">
      <p>This will update <strong data-leaf-count-display></strong> project(s) to <strong data-state-display></strong>.</p>
      <p>Are you sure you want to continue?</p>
    </div>
    <div class="modal__actions">
      <button type="button" class="btn secondary" data-modal-cancel>Cancel</button>
      <button type="button" class="btn" data-modal-confirm>Confirm</button>
    </div>
  </div>
</div>

<div class="modal-overlay" data-archive-modal hidden>
  <div class="modal">
    <div class="modal__header">
      <h3>Archive Project</h3>
    </div>
    <div class="modal__body">
      <p>Archive <strong data-archive-project-name></strong>?</p>
      <p>Archived projects are hidden from the main list but can still be accessed.</p>
    </div>
    <div class="modal__actions">
      <button type="button" class="btn secondary" data-archive-cancel>Cancel</button>
      <button type="button" class="btn danger" data-archive-confirm>Archive</button>
    </div>
  </div>
</div>

<div class="modal-overlay" data-unlink-modal hidden>
  <div class="modal">
    <div class="modal__header">
      <h3>Unlink Project</h3>
    </div>
    <div class="modal__body">
      <p>Remove <strong data-unlink-project-name></strong> from this project?</p>
      <p>The project itself will not be deleted.</p>
    </div>
    <div class="modal__actions">
      <button type="button" class="btn secondary" data-unlink-cancel>Cancel</button>
      <button type="button" class="btn danger" data-unlink-confirm>Unlink</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = document.querySelector('meta[name="csrf-token"]')?.content;

    document.querySelectorAll('.editable-field').forEach((el) => {
      const hint = el.dataset.hint;
      let original = el.innerText;
      let isShowingHint = el.classList.contains('editable-field--empty');

      // On focus: clear hint text if showing
      el.addEventListener('focus', () => {
        if (isShowingHint && hint) {
          el.innerText = '';
          el.classList.remove('editable-field--empty');
          isShowingHint = false;
        }
      });

      el.addEventListener('blur', () => {
        const value = el.innerText.trim();

        // If empty, show hint
        if (!value && hint) {
          el.innerText = hint;
          el.classList.add('editable-field--empty');
          isShowingHint = true;
        }

        // Save the actual value (empty string if hint is showing)
        const saveValue = isShowingHint ? '' : value;
        const originalValue = original === hint ? '' : original;

        if (saveValue === originalValue) return;

        const field = el.dataset.field;
        const url = el.dataset.updateUrl;
        fetch(url, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ project: { [field]: saveValue } })
        }).then((resp) => {
          if (resp.ok) { original = isShowingHint ? hint : value; }
        }).catch((err) => console.error(err));
      });
    });

    const dropdown = document.querySelector('.state-dropdown');
    const confirmModal = document.querySelector('[data-state-confirm-modal]');
    const leafCountDisplay = document.querySelector('[data-leaf-count-display]');
    const stateDisplay = document.querySelector('[data-state-display]');
    const cancelBtn = document.querySelector('[data-modal-cancel]');
    const confirmBtn = document.querySelector('[data-modal-confirm]');

    if (dropdown) {
      const menu = dropdown.querySelector('.state-menu');
      const toggle = dropdown.querySelector('.state-toggle');
      const url = dropdown.dataset.stateUrl;
      const leafCount = parseInt(dropdown.dataset.leafCount, 10) || 0;

      const updateState = (state) => {
        fetch(url, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ state })
        }).then((resp) => {
          if (resp.ok) {
            window.location.reload();
          } else {
            menu.classList.remove('open');
          }
        }).catch(() => menu.classList.remove('open'));
      };

      toggle?.addEventListener('click', () => {
        menu.classList.toggle('open');
      });

      menu?.querySelectorAll('button[data-state]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const state = btn.dataset.state;
          menu.classList.remove('open');

          if (leafCount > 1 && confirmModal) {
            leafCountDisplay.textContent = leafCount;
            stateDisplay.textContent = state.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            confirmModal.hidden = false;

            const handleConfirm = () => {
              confirmModal.hidden = true;
              updateState(state);
              confirmBtn.removeEventListener('click', handleConfirm);
              cancelBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
              confirmModal.hidden = true;
              confirmBtn.removeEventListener('click', handleConfirm);
              cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
          } else {
            updateState(state);
          }
        });
      });

      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
          menu.classList.remove('open');
        }
      });
    }

    const healthToggle = document.querySelector('[data-health-toggle]');
    const healthFormRow = document.querySelector('[data-health-update-form]');
    const healthDateField = document.querySelector('.health-date-field');

    healthToggle?.addEventListener('click', () => {
      healthFormRow?.classList.toggle('open');
    });

    const healthSelect = document.querySelector('[data-health-select]');
    const hiddenInput = healthSelect?.querySelector('[data-health-select-value]');
    const healthLabel = healthSelect?.querySelector('.health-select__label');
    const currentIcon = healthSelect?.querySelector('.health-select__toggle .project-health');

    const setHealthValue = (value) => {
      if (!value || !hiddenInput) return;
      hiddenInput.value = value;
      if (healthLabel) {
        healthLabel.textContent = value.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
      }
      if (currentIcon) {
        currentIcon.className = `project-health project-health--${value} project-health--small`;
      }
    };

    document.querySelectorAll('[data-trend-date]').forEach((trendItem) => {
      trendItem.addEventListener('click', () => {
        const date = trendItem.dataset.trendDate;
        const health = trendItem.dataset.trendHealth;
        if (healthFormRow && healthDateField) {
          const isOpen = healthFormRow.classList.contains('open');
          const isSameDate = healthDateField.value === date;
          if (isOpen && isSameDate) {
            healthFormRow.classList.remove('open');
          } else {
            healthFormRow.classList.add('open');
            healthDateField.value = date;
            setHealthValue(health);
          }
        }
      });
    });

    if (healthSelect) {
      const toggle = healthSelect.querySelector('[data-health-select-toggle]');
      const menu = healthSelect.querySelector('[data-health-select-menu]');

      const closeMenu = () => menu?.classList.remove('open');
      const openMenu = () => menu?.classList.add('open');

      toggle?.addEventListener('click', () => {
        if (menu?.classList.contains('open')) {
          closeMenu();
        } else {
          openMenu();
        }
      });

      menu?.querySelectorAll('[data-health-option]').forEach((optionBtn) => {
        optionBtn.addEventListener('click', () => {
          const value = optionBtn.dataset.healthOption;
          setHealthValue(value);
          closeMenu();
        });
      });

      document.addEventListener('click', (e) => {
        if (!healthSelect.contains(e.target)) {
          closeMenu();
        }
      });
    }

    // Archive button
    const archiveBtn = document.querySelector('.archive-btn');
    const archiveModal = document.querySelector('[data-archive-modal]');
    const archiveProjectName = document.querySelector('[data-archive-project-name]');
    const archiveConfirmBtn = document.querySelector('[data-archive-confirm]');
    const archiveCancelBtn = document.querySelector('[data-archive-cancel]');

    if (archiveBtn && archiveModal) {
      const showArchiveModal = () => {
        archiveProjectName.textContent = archiveBtn.dataset.projectName;
        archiveModal.hidden = false;
        archiveConfirmBtn?.focus();
      };

      const hideArchiveModal = () => {
        archiveModal.hidden = true;
      };

      const performArchive = () => {
        const url = archiveBtn.dataset.archiveUrl;
        hideArchiveModal();

        fetch(url, {
          method: 'PATCH',
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': token
          }
        }).then((resp) => {
          if (resp.ok) {
            window.location.reload();
          }
        }).catch((err) => console.error(err));
      };

      archiveBtn.addEventListener('click', showArchiveModal);
      archiveConfirmBtn?.addEventListener('click', performArchive);
      archiveCancelBtn?.addEventListener('click', hideArchiveModal);

      archiveModal.addEventListener('click', (e) => {
        if (e.target === archiveModal) hideArchiveModal();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !archiveModal.hidden) {
          hideArchiveModal();
        }
      });
    }

    // Unarchive button
    const unarchiveBtn = document.querySelector('.unarchive-btn');
    if (unarchiveBtn) {
      unarchiveBtn.addEventListener('click', () => {
        const url = unarchiveBtn.dataset.unarchiveUrl;

        fetch(url, {
          method: 'PATCH',
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': token
          }
        }).then((resp) => {
          if (resp.ok) {
            window.location.reload();
          }
        }).catch((err) => console.error(err));
      });
    }

    // Unlink modal for child projects
    const unlinkModal = document.querySelector('[data-unlink-modal]');
    const unlinkProjectName = document.querySelector('[data-unlink-project-name]');
    const unlinkConfirmBtn = document.querySelector('[data-unlink-confirm]');
    const unlinkCancelBtn = document.querySelector('[data-unlink-cancel]');
    let pendingUnlinkUrl = null;

    const showUnlinkModal = (projectName, url) => {
      unlinkProjectName.textContent = projectName;
      pendingUnlinkUrl = url;
      unlinkModal.hidden = false;
      unlinkConfirmBtn?.focus();
    };

    const hideUnlinkModal = () => {
      unlinkModal.hidden = true;
      pendingUnlinkUrl = null;
    };

    const performUnlink = () => {
      if (!pendingUnlinkUrl) return;

      const url = pendingUnlinkUrl;
      hideUnlinkModal();

      fetch(url, {
        method: 'DELETE',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': token
        }
      }).then((resp) => {
        if (resp.ok) {
          window.location.reload();
        }
      }).catch((err) => console.error(err));
    };

    unlinkConfirmBtn?.addEventListener('click', performUnlink);
    unlinkCancelBtn?.addEventListener('click', hideUnlinkModal);

    unlinkModal?.addEventListener('click', (e) => {
      if (e.target === unlinkModal) hideUnlinkModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && unlinkModal && !unlinkModal.hidden) {
        hideUnlinkModal();
      }
    });

    document.querySelectorAll('.unlink-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const url = btn.dataset.unlinkUrl;
        const projectName = btn.dataset.projectName;
        showUnlinkModal(projectName, url);
      });
    });
  });
</script>
