<div class="grid">
  <div class="card">
    <% allowed_states = SetProjectState::STATE_TRANSITIONS[@project_record.current_state.to_sym] || [] %>
    <div class="project-header">
      <button type="button" class="health-toggle-button" data-health-toggle>
        <div class="project-header__health">
          <%= project_health_indicator(@project || @project_record) %>
        </div>
      </button>
      <div class="project-header__text">
        <div class="editable-field project-name"
             contenteditable="true"
             data-field="name"
             data-update-url="<%= project_path(@project_record) %>"><%= @project_record.name %></div>

        <div class="editable-field project-description"
             contenteditable="true"
             data-field="description"
             data-update-url="<%= project_path(@project_record) %>"><%= @project_record.description.presence || 'No description yet.' %></div>

        <div class="editable-field project-poc"
              contenteditable="true"
              data-field="point_of_contact"
              data-update-url="<%= project_path(@project_record) %>"><%= @project_record.point_of_contact.presence || 'Enter a person, email, or slack channel.' %></div>
      </div>
      <div class="project-header__state">
        <div class="state-dropdown" data-state-url="<%= state_project_path(@project_record) %>">
          <button class="state-toggle" type="button">
            <span class="badge state"><%= @project_record.current_state.to_s.tr('_', ' ').titleize %></span>
          </button>
          <div class="state-menu">
            <% if allowed_states.any? %>
              <% allowed_states.each do |state| %>
                <button type="button" data-state="<%= state %>"><%= state.to_s.tr('_', ' ').titleize %></button>
              <% end %>
            <% else %>
              <div class="empty">No further transitions</div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <% if @project_record.children.empty? %>
      <% health_form_classes = ['project-header__health-update'] %>
      <% health_form_classes << 'open' if @show_health_update_form %>
      <div class="<%= health_form_classes.join(' ') %>" data-health-update-form>
        <%= form_with model: HealthUpdateRecord.new,
                      url: health_updates_project_path(@project_record),
                      method: :post,
                      scope: :health_update,
                      local: true,
                      html: { class: 'health-update-form', data: { turbo: false } } do |form| %>
          <div class="health-update-fields">
            <div class="health-select" data-health-select>
              <%= form.hidden_field :health, value: @selected_health, data: { health_select_value: true } %>
              <button type="button" class="health-select__toggle" data-health-select-toggle>
                <span class="project-health project-health--<%= @selected_health %> project-health--small" aria-hidden="true"></span>
                <span class="health-select__label"><%= @selected_health.to_s.tr('_', ' ').titleize %></span>
              </button>
              <div class="health-select__menu" data-health-select-menu>
                <% @health_options.each do |option| %>
                  <button type="button"
                          class="health-select__option"
                          data-health-option="<%= option %>">
                    <span class="project-health project-health--<%= option %> project-health--small" aria-hidden="true"></span>
                    <span><%= option.to_s.tr('_', ' ').titleize %></span>
                  </button>
                <% end %>
              </div>
            </div>
            <%= form.date_field :date, value: Date.current, required: true, class: 'health-date-field' %>
            <%= form.text_field :description, placeholder: 'Description (optional)', class: 'health-description-field' %>
            <%= form.submit 'Update', class: 'btn' %>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if defined?(@errors) && @errors.present? %>
      <div class="errors">
        <ul>
          <% @errors.each do |err| %>
            <li><%= err %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

  </div>

  <div class="card">
    <h3 class="section-title children-title">Projects</h3>
    <ul class="list children-list">
      <%= render partial: 'projects/project_list_item', collection: @project_record.children, as: :project %>
      <% if @project_record.children.empty? %>
        <li class="list-item"><span class="muted">No children yet.</span></li>
      <% end %>
      <li class="list-item">
        <%= form_with model: ProjectRecord.new,
                      url: subordinates_project_path(@project_record),
                      method: :post,
                      scope: :project,
                      local: true,
                      html: { class: 'child-form' } do |form| %>
          <div class="child-actions">
          <%= form.text_field :name, required: true, placeholder: 'New project name' %>
            <%= form.submit 'Add', class: 'btn secondary' %>
          </div>
        <% end %>
      </li>
    </ul>
  </div>
</div>

<p class="muted back-link"><%= link_to 'â† Back to projects', projects_path %></p>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = document.querySelector('meta[name="csrf-token"]')?.content;
    document.querySelectorAll('.editable-field').forEach((el) => {
      let original = el.innerText;
      el.addEventListener('blur', () => {
        const value = el.innerText.trim();
        if (value === original) return;
        const field = el.dataset.field;
        const url = el.dataset.updateUrl;
        fetch(url, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ project: { [field]: value } })
        }).then((resp) => {
          if (resp.ok) { original = value; }
        }).catch((err) => console.error(err));
      });
    });

    const dropdown = document.querySelector('.state-dropdown');
    if (dropdown) {
      const menu = dropdown.querySelector('.state-menu');
      const toggle = dropdown.querySelector('.state-toggle');
      const url = dropdown.dataset.stateUrl;

      toggle?.addEventListener('click', () => {
        menu.classList.toggle('open');
      });

      menu?.querySelectorAll('button[data-state]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const state = btn.dataset.state;
          fetch(url, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'X-CSRF-Token': token
            },
            body: JSON.stringify({ state })
          }).then((resp) => {
            if (resp.ok) {
              window.location.reload();
            } else {
              menu.classList.remove('open');
            }
          }).catch(() => menu.classList.remove('open'));
        });
      });

      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
          menu.classList.remove('open');
        }
      });
    }

    const healthToggle = document.querySelector('[data-health-toggle]');
    const healthFormRow = document.querySelector('[data-health-update-form]');
    healthToggle?.addEventListener('click', () => {
      healthFormRow?.classList.toggle('open');
    });

    const healthSelect = document.querySelector('[data-health-select]');
    if (healthSelect) {
      const toggle = healthSelect.querySelector('[data-health-select-toggle]');
      const menu = healthSelect.querySelector('[data-health-select-menu]');
      const hiddenInput = healthSelect.querySelector('[data-health-select-value]');
      const label = healthSelect.querySelector('.health-select__label');
      const currentIcon = healthSelect.querySelector('.health-select__toggle .project-health');

      const closeMenu = () => menu?.classList.remove('open');
      const openMenu = () => menu?.classList.add('open');

      toggle?.addEventListener('click', () => {
        if (menu?.classList.contains('open')) {
          closeMenu();
        } else {
          openMenu();
        }
      });

      menu?.querySelectorAll('[data-health-option]').forEach((optionBtn) => {
        optionBtn.addEventListener('click', () => {
          const value = optionBtn.dataset.healthOption;
          if (!value) return;
          hiddenInput.value = value;
          label.textContent = value.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
          if (currentIcon) {
            currentIcon.className = `project-health project-health--${value} project-health--small`;
          }
          closeMenu();
        });
      });

      document.addEventListener('click', (e) => {
        if (!healthSelect.contains(e.target)) {
          closeMenu();
        }
      });
    }
  });
</script>
