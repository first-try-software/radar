<% allowed_states = SetProjectState::SETTABLE_STATES %>
<% project = @project || @project_record %>

<div class="project-hero" data-project-hero>
  <% if @project %>
    <div class="project-hero__breadcrumb">
      <%= project_breadcrumb(@project, @project_record) %>
    </div>
  <% end %>
  <div class="project-hero__actions">
    <% if project.archived? %>
      <span class="badge badge--archived" data-archived-badge>ARCHIVED</span>
    <% end %>
    <div class="state-dropdown" data-state-dropdown>
      <button class="state-toggle" type="button" data-state-toggle>
        <span class="badge state state--<%= project.current_state.to_s.tr('_', '-') %>" data-state-badge><%= project.current_state.to_s.tr('_', ' ').upcase %></span>
      </button>
      <div class="state-menu" data-state-menu>
        <% if allowed_states.any? %>
          <% allowed_states.each do |state| %>
            <button type="button" data-state="<%= state %>"><%= state.to_s.tr('_', ' ').titleize %></button>
          <% end %>
        <% else %>
          <div class="empty">No further transitions</div>
        <% end %>
      </div>
    </div>
    <button type="button" class="project-hero__edit-btn" data-edit-toggle aria-label="Edit project">✎</button>
  </div>
  <h1 class="project-hero__title" data-project-title><%= project.name %></h1>
  <p class="project-hero__tagline" data-project-tagline<%= ' hidden' if project.description.blank? %>><%= project.description %></p>
  <% effective_contact = @project&.effective_contact || project.point_of_contact %>
  <% if effective_contact.present? %>
    <p class="project-hero__contact" data-project-contact>For more information, contact <span data-project-poc><%= effective_contact %></span>.</p>
  <% else %>
    <p class="project-hero__contact project-hero__contact--missing" data-project-contact>Psst! Do me a favor! Tell me who to call if this thing breaks!</p>
  <% end %>
</div>

<!-- Metrics Row -->
<% if @health_summary %>
<%
  health = @project_health || :not_available
  health_class = health.to_s.tr('_', '-')
  summary = @health_summary
  total = summary[:on_track] + summary[:at_risk] + summary[:off_track]
  raw_score = if total > 0
    (summary[:on_track] * 1 + summary[:at_risk] * 0 + summary[:off_track] * -1).to_f / total
  else
    nil
  end
  raw_score_display = raw_score ? raw_score.round(2) : 'N/A'
  is_leaf = project.leaf?
%>
<div class="initiative-dashboard-v2">
  <div class="metrics-row-v2">
    <!-- Health Widget -->
    <div class="metric-widget metric-widget--health metric-widget--<%= health_class %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Current Health</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
          <div class="widget-info__tooltip">
            <% if is_leaf %>
              <div class="widget-info__methodology">Based on the most recent health update for this project.</div>
            <% else %>
              <div class="widget-info__methodology">Average of all leaf-node project health scores.</div>
            <% end %>
            <div class="widget-info__range">
              <div>On Track = +1</div>
              <div>At Risk = 0</div>
              <div>Off Track = −1</div>
            </div>
            <div class="widget-info__score">Score: <%= raw_score_display %></div>
          </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <span class="metric-widget__dot metric-widget__dot--<%= health_class %>"></span>
        <div class="metric-widget__text">
          <div class="metric-widget__label metric-widget__label--<%= health_class %>"><%= health.to_s.tr('_', ' ').titleize %></div>
        </div>
      </div>
    </div>

    <!-- Trend Widget -->
    <% trend_class = @weeks_of_data >= 2 ? "trend-#{@trend_direction}" : 'trend-insufficient' %>
    <div class="metric-widget metric-widget--trend metric-widget--<%= trend_class %>">
      <div class="metric-widget__header">
        <span class="metric-widget__title">6-Week Trend</span>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="widget-info">
            <span class="widget-info__icon">i</span>
            <div class="widget-info__tooltip">
              <div class="widget-info__methodology">Weekly average health scores over the past 6 weeks.</div>
              <div class="widget-info__range">Range: −1.0 to +1.0 per week</div>
              <div class="widget-info__score">Delta: <%= @trend_delta >= 0 ? '+' : '' %><%= @trend_delta.round(2) %> (<%= @weeks_of_data %> weeks)</div>
            </div>
          </div>
        </div>
      </div>
      <div class="metric-widget__chart">
        <% if @weeks_of_data >= 2 %>
          <svg viewBox="0 0 200 50" preserveAspectRatio="none" class="trend-svg">
            <defs>
              <linearGradient id="project-trend-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <% @trend_data.each_with_index do |point, i| %>
                  <% offset = (i.to_f / [@trend_data.length - 1, 1].max * 100).round %>
                  <% color = point[:health] == :on_track ? '#22c55e' : (point[:health] == :off_track ? '#ef4444' : '#f59e0b') %>
                  <stop offset="<%= offset %>%" stop-color="<%= color %>" />
                <% end %>
              </linearGradient>
            </defs>
            <%
              points = @trend_data.each_with_index.map do |point, i|
                x = (i.to_f / [@trend_data.length - 1, 1].max * 180) + 10
                y = 45 - ((point[:score] + 1) / 2.0 * 40)
                [x, y]
              end
              points_str = points.map { |p| "#{p[0].round(1)},#{p[1].round(1)}" }.join(' ')
            %>
            <polyline class="trend-line-v2" stroke="url(#project-trend-gradient)" points="<%= points_str %>" />
            <% points.each_with_index do |p, i| %>
              <% pt_health = @trend_data[i][:health] %>
              <circle cx="<%= p[0].round(1) %>" cy="<%= p[1].round(1) %>" r="4" class="trend-point-v2 trend-point-v2--<%= pt_health %>" />
            <% end %>
          </svg>
        <% elsif @weeks_of_data == 1 %>
          <div class="metric-widget__no-data">1 week of data</div>
        <% else %>
          <div class="metric-widget__no-data">Insufficient data</div>
        <% end %>
      </div>
    </div>

    <!-- Confidence Widget -->
    <%
      confidence_cta = case @confidence_factors&.dig(:biggest_drag)
      when :variance
        { text: "Volatile health trend", type: :info }
      when :staleness
        days = @confidence_factors.dig(:details, :days_since_update)
        { text: "Data is #{days}+ days old", type: :warning }
      when :coverage
        count = @confidence_factors.dig(:details, :projects_needing_update) || 0
        { text: "#{count} #{'project'.pluralize(count)} need updates", type: :warning }
      when :insufficient_data
        { text: "Building history...", type: :info }
      else
        nil
      end
    %>
    <div class="metric-widget metric-widget--confidence metric-widget--confidence-<%= @confidence_level %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Confidence</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
          <div class="widget-info__tooltip">
            <div class="widget-info__methodology">Based on trend consistency and data freshness.</div>
            <div class="widget-info__range">
              <div>Range: 0–100</div>
              <div>High ≥70</div>
              <div>Medium ≥40</div>
              <div>Low &lt;40</div>
            </div>
            <div class="widget-info__score">Score: <%= @confidence_score %></div>
          </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <div class="confidence-ring">
          <svg viewBox="0 0 44 44">
            <circle class="confidence-ring__bg" cx="22" cy="22" r="18" />
            <% circumference = 2 * Math::PI * 18 %>
            <% offset = circumference - (@confidence_score / 100.0 * circumference) %>
            <circle class="confidence-ring__fill confidence-ring__fill--<%= @confidence_level %>"
                    cx="22" cy="22" r="18"
                    stroke-dasharray="<%= circumference.round(1) %>"
                    stroke-dashoffset="<%= offset.round(1) %>" />
          </svg>
        </div>
        <div class="metric-widget__text">
          <div class="metric-widget__label confidence-label--<%= @confidence_level %>"><%= @confidence_level.to_s.titleize %></div>
          <% if confidence_cta && @confidence_level != :high %>
            <span class="metric-widget__hint"><%= confidence_cta[:text] %></span>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
<% end %>

<!-- Toast Container -->
<div class="toast-container" data-toast-container></div>

<!-- Global Search -->
<%
  # Build flat list of all teams with ancestry for search
  all_teams_flat = []
  build_team_tree = ->(teams, ancestors = []) do
    teams.sort_by(&:name).each do |team|
      path = ancestors + [team.name]
      all_teams_flat << { entity: team, type: :team, path: path, record: TeamRecord.find_by(name: team.name) }
      build_team_tree.call(team.subordinate_teams, path) if team.subordinate_teams.any?
    end
  end
  build_team_tree.call(@teams) if @teams

  # Build flat list of all initiatives
  all_initiatives_flat = (@initiatives || []).map do |initiative|
    { entity: initiative, type: :initiative, record: InitiativeRecord.find_by(name: initiative.name) }
  end

  # Build flat list of all projects
  all_projects_flat = (@all_projects || []).map do |proj|
    { entity: proj, type: :project, record: ProjectRecord.find_by(name: proj.name) }
  end
%>
<div class="global-search">
  <input type="text" class="global-search__input" placeholder="Find or create what you are looking for..." data-global-search>
  <div class="global-search__results-container" data-global-search-container>
    <div class="section section--search-results">
      <h3 class="section__title" data-results-header>Results</h3>
      <div class="section__columns" data-global-search-results>
        <!-- Teams Column -->
        <div class="section__column" data-results-column="teams">
          <h4 class="section__subtitle">Teams</h4>
          <ul class="section__list">
            <% all_teams_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="team"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= team_path(entry[:record]) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Initiatives Column -->
        <div class="section__column" data-results-column="initiatives">
          <h4 class="section__subtitle">Initiatives</h4>
          <ul class="section__list">
            <% all_initiatives_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="initiative"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= initiative_path(entry[:record]) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Projects Column -->
        <div class="section__column" data-results-column="projects">
          <h4 class="section__subtitle">Projects</h4>
          <ul class="section__list">
            <% all_projects_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="project"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= project_path(entry[:record]) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <!-- No Results / Create Child -->
      <div class="global-search__no-results" data-no-results hidden>
        <h3 class="section__title">Create Child Project</h3>
        <p class="global-search__context">New project will be linked as a child of "<%= project.name %>"</p>
        <form action="<%= subordinates_project_path(@project_record) %>" method="post" class="global-search__create-form" data-create-form>
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <div class="global-search__form-fields-inline">
            <input type="text" name="project[name]" class="global-search__form-input" placeholder="Project Name (required)" data-create-name required>
            <input type="text" name="project[description]" class="global-search__form-input" placeholder="Description (highly recommended)">
            <input type="text" name="project[point_of_contact]" class="global-search__form-input" placeholder="Contacts (highly recommended)">
            <button type="submit" class="global-search__create-btn">Create Child Project</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Child Projects Section (only for parent projects) -->
<% if @project && !@project.leaf? %>
<%
  all_leaf_descendants = @project.leaf_descendants
  leaf_descendants = all_leaf_descendants.reject { |p| p.respond_to?(:archived?) && p.archived? }
  archived_projects = all_leaf_descendants.select { |p| p.respond_to?(:archived?) && p.archived? }
  sorted_descendants = sort_projects_canonical(leaf_descendants)
  sorted_archived = sort_projects_canonical(archived_projects)

  unhealthy = leaf_descendants.select { |p| [:off_track, :at_risk].include?(p.health) }
  sorted_unhealthy = sort_projects_canonical(unhealthy)

  stale = leaf_descendants.select do |p|
    next false unless [:in_progress, :blocked].include?(p.current_state)
    latest = p.latest_health_update
    latest.nil? || (Date.current - latest.date.to_date).to_i > 7
  end
  sorted_stale = sort_projects_canonical(stale)

  active_states = [:new, :in_progress, :blocked]
  inactive_states = [:completed, :paused, :cancelled]

  active_projects = leaf_descendants.select { |p| active_states.include?(p.current_state) }
  sorted_active = sort_projects_canonical(active_projects)

  inactive_projects = leaf_descendants.select { |p| inactive_states.include?(p.current_state) }
  sorted_inactive = sort_projects_canonical(inactive_projects)
%>
<section class="section section--projects">
  <div class="section__title-row">
    <h3 class="section__title">Child Projects</h3>
    <div class="dashboard-tabs-v2">
      <button class="dashboard-tab-v2 active" data-child-tab="all">
        All <span class="dashboard-tab-v2__count"><%= leaf_descendants.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-child-tab="unhealthy">
        Unhealthy <span class="dashboard-tab-v2__count"><%= unhealthy.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-child-tab="stale">
        Stale <span class="dashboard-tab-v2__count"><%= stale.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-child-tab="active">
        Active <span class="dashboard-tab-v2__count"><%= active_projects.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-child-tab="inactive">
        Inactive <span class="dashboard-tab-v2__count"><%= inactive_projects.size %></span>
      </button>
      <% if archived_projects.any? %>
        <button class="dashboard-tab-v2" data-child-tab="archived">
          Archived <span class="dashboard-tab-v2__count"><%= archived_projects.size %></span>
        </button>
      <% end %>
    </div>
  </div>

  <!-- Tab Content: All -->
  <div class="tab-content-v2 active" data-child-tab-content="all">
    <% if leaf_descendants.empty? %>
      <div class="tab-empty-v2">No child projects</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_descendants.each do |child_project| %>
          <%= render 'dashboard/project_list_item', project: child_project %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Unhealthy -->
  <div class="tab-content-v2" data-child-tab-content="unhealthy">
    <% if unhealthy.empty? %>
      <div class="tab-empty-v2">All child projects are healthy!</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_unhealthy.each do |child_project| %>
          <%= render 'dashboard/project_list_item', project: child_project %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Stale -->
  <div class="tab-content-v2" data-child-tab-content="stale">
    <% if stale.empty? %>
      <div class="tab-empty-v2">All child projects are up to date!</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_stale.each do |child_project| %>
          <%= render 'dashboard/project_list_item', project: child_project, tag_text: 'Stale', tag_modifier: 'stale' %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Active -->
  <div class="tab-content-v2" data-child-tab-content="active">
    <% if active_projects.empty? %>
      <div class="tab-empty-v2">No active child projects</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_active.each do |child_project| %>
          <% tag_text = child_project.current_state == :blocked ? 'Blocked' : nil %>
          <% tag_modifier = child_project.current_state == :blocked ? 'blocked' : nil %>
          <%= render 'dashboard/project_list_item', project: child_project, tag_text: tag_text, tag_modifier: tag_modifier %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Inactive -->
  <div class="tab-content-v2" data-child-tab-content="inactive">
    <% if inactive_projects.empty? %>
      <div class="tab-empty-v2">No inactive child projects</div>
    <% else %>
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_inactive.each do |child_project| %>
          <% tag_text = child_project.current_state.to_s.tr('_', ' ').titleize %>
          <%= render 'dashboard/project_list_item', project: child_project, tag_text: tag_text, tag_modifier: 'inactive' %>
        <% end %>
      </ul>
    <% end %>
  </div>

  <!-- Tab Content: Archived -->
  <% if archived_projects.any? %>
    <div class="tab-content-v2" data-child-tab-content="archived">
      <ul class="project-list-v2">
        <%= render 'dashboard/project_list_header' %>
        <% sorted_archived.each do |child_project| %>
          <%= render 'dashboard/project_list_item', project: child_project, tag_text: 'Archived', tag_modifier: 'archived' %>
        <% end %>
      </ul>
    </div>
  <% end %>
</section>
<% end %>

<!-- Updates Section (only for leaf projects) -->
<% if @project&.leaf? %>
<section class="section section--updates">
  <h3 class="section__title">Updates</h3>

  <div class="updates-list" data-updates-list>
    <!-- Create Update Form (first row) -->
    <form class="update-form" data-update-form action="<%= health_updates_project_path(@project_record) %>" method="post">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <div class="update-row update-row--form">
        <div class="update-row__date">
          <input type="date" name="health_update[date]" class="update-form__input update-form__input--date" value="<%= Date.current.strftime('%Y-%m-%d') %>" required data-update-date>
        </div>
        <div class="update-row__health">
          <input type="hidden" name="health_update[health]" value="<%= @selected_health %>" data-health-input>
          <div class="health-dropdown" data-health-dropdown>
            <button type="button" class="health-dropdown__toggle" data-health-toggle>
              <span class="health-dropdown__indicator health-dropdown__indicator--<%= @selected_health %>" data-health-indicator></span>
              <span class="health-dropdown__label" data-health-label><%= @selected_health.to_s.tr('_', ' ').titleize %></span>
              <span class="health-dropdown__arrow">▾</span>
            </button>
            <div class="health-dropdown__menu" data-health-menu>
              <% @health_options.each do |health_opt| %>
                <button type="button" class="health-dropdown__option" data-health-value="<%= health_opt %>">
                  <span class="health-dropdown__indicator health-dropdown__indicator--<%= health_opt %>"></span>
                  <span><%= health_opt.to_s.tr('_', ' ').titleize %></span>
                </button>
              <% end %>
            </div>
          </div>
        </div>
        <div class="update-row__description">
          <input type="text" name="health_update[description]" class="update-form__input" placeholder="What's the latest?" data-update-description>
        </div>
        <div class="update-row__actions">
          <button type="submit" class="btn btn--small" data-update-submit>Add Update</button>
        </div>
      </div>
    </form>

    <!-- Existing Updates Header -->
    <div class="updates-header" data-updates-header<%= ' hidden' unless @health_updates&.any? %>>
      <span class="updates-header__col updates-header__col--date">Date</span>
      <span class="updates-header__col updates-header__col--health">Health</span>
      <span class="updates-header__col updates-header__col--description">Description</span>
    </div>

    <!-- Existing Updates Container -->
    <div data-updates-container>
      <% if @health_updates&.any? %>
        <% @health_updates.each do |update| %>
          <div class="update-row" data-update-row>
            <span class="update-row__date"><%= update.date.strftime('%-m/%-d/%-y') %></span>
            <span class="update-row__health">
              <span class="health-indicator health-indicator--<%= update.health %>"></span>
              <span class="health-text"><%= update.health.to_s.tr('_', ' ').titleize %></span>
            </span>
            <span class="update-row__description"><%= update.description.presence || '—' %></span>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Empty State -->
    <div class="updates-empty" data-updates-empty<%= ' hidden' if @health_updates&.any? %>>No updates yet. Add your first update above!</div>
  </div>
</section>
<% end %>

<!-- Edit Modal -->
<div class="modal-overlay" data-edit-modal hidden>
  <div class="modal">
    <div class="modal__header">
      <h3>Edit Project</h3>
    </div>
    <form class="edit-project-form" data-edit-form>
      <div class="modal__body">
        <div class="form-field">
          <label for="project_name" class="form-field__label">Name</label>
          <input type="text" id="project_name" name="project[name]" class="form-field__input" value="<%= @project_record.name %>" required data-input-name>
        </div>
        <div class="form-field">
          <label for="project_description" class="form-field__label">Brief Description</label>
          <input type="text" id="project_description" name="project[description]" class="form-field__input" value="<%= @project_record.description %>" data-input-description>
        </div>
        <div class="form-field">
          <label for="project_point_of_contact" class="form-field__label">Contact(s)</label>
          <input type="text" id="project_point_of_contact" name="project[point_of_contact]" class="form-field__input" value="<%= @project_record.point_of_contact %>" data-input-poc>
        </div>
        <div class="form-field form-field--archive">
          <span class="form-field__label">Archive this project and remove it from view?</span>
          <label class="checkbox-field">
            <input type="hidden" name="project[archived]" value="0">
            <input type="checkbox" name="project[archived]" value="1" class="checkbox-field__input" <%= 'checked' if @project_record.archived %> data-archive-checkbox>
            <span class="checkbox-field__box"></span>
            <span class="checkbox-field__label" data-archive-label><%= @project_record.archived ? 'This project is archived and hidden.' : 'Click checkbox to archive' %></span>
          </label>
        </div>
      </div>
      <div class="modal__actions">
        <button type="button" class="btn secondary" data-edit-cancel>Cancel</button>
        <button type="submit" class="btn" data-edit-save>Save</button>
      </div>
    </form>
  </div>
</div>

<% if defined?(@errors) && @errors.present? %>
  <div class="errors">
    <ul>
      <% @errors.each do |err| %>
        <li><%= err %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const token = document.querySelector('meta[name="csrf-token"]')?.content;

  // State dropdown
  const stateDropdown = document.querySelector('[data-state-dropdown]');
  const stateToggle = document.querySelector('[data-state-toggle]');
  const stateMenu = document.querySelector('[data-state-menu]');

  if (stateDropdown && stateToggle && stateMenu) {
    stateToggle.addEventListener('click', () => {
      stateMenu.classList.toggle('open');
    });

    stateMenu.querySelectorAll('button[data-state]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const state = btn.dataset.state;
        stateMenu.classList.remove('open');

        fetch('<%= state_project_path(@project_record) %>', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ state })
        }).then((resp) => {
          if (resp.ok) {
            window.location.reload();
          }
        }).catch((err) => console.error(err));
      });
    });

    document.addEventListener('click', (e) => {
      if (!stateDropdown.contains(e.target)) {
        stateMenu.classList.remove('open');
      }
    });
  }

  // Edit modal
  const editToggle = document.querySelector('[data-edit-toggle]');
  const editModal = document.querySelector('[data-edit-modal]');
  const editCancel = document.querySelector('[data-edit-cancel]');
  const editForm = document.querySelector('[data-edit-form]');

  const showEditModal = () => {
    editModal.hidden = false;
  };

  const hideEditModal = () => {
    editModal.hidden = true;
  };

  editToggle?.addEventListener('click', showEditModal);
  editCancel?.addEventListener('click', hideEditModal);

  editModal?.addEventListener('click', (e) => {
    if (e.target === editModal) hideEditModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && editModal && !editModal.hidden) {
      hideEditModal();
    }
  });

  // Dynamic archive checkbox label
  const archiveCheckbox = document.querySelector('[data-archive-checkbox]');
  const archiveLabel = document.querySelector('[data-archive-label]');

  archiveCheckbox?.addEventListener('change', () => {
    archiveLabel.textContent = archiveCheckbox.checked
      ? 'This project is archived and hidden.'
      : 'Click checkbox to archive';
  });

  // AJAX form submission
  editForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(editForm);
    const saveBtn = editForm.querySelector('[data-edit-save]');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;

    try {
      const response = await fetch('<%= project_path(@project_record) %>', {
        method: 'PATCH',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': token
        },
        body: formData
      });

      const data = await response.json();

      if (response.ok) {
        // Update hero section
        const titleEl = document.querySelector('[data-project-title]');
        const taglineEl = document.querySelector('[data-project-tagline]');
        const contactEl = document.querySelector('[data-project-contact]');
        const pocEl = document.querySelector('[data-project-poc]');
        const actionsEl = document.querySelector('.project-hero__actions');
        let archivedBadge = document.querySelector('[data-archived-badge]');

        const name = formData.get('project[name]');
        const description = formData.get('project[description]');
        const poc = formData.get('project[point_of_contact]');
        const archived = formData.get('project[archived]') === '1';

        if (titleEl) titleEl.textContent = name;

        if (taglineEl) {
          taglineEl.textContent = description;
          taglineEl.hidden = !description;
        }

        if (contactEl && pocEl) {
          pocEl.textContent = poc;
          contactEl.hidden = !poc;
        }

        // Handle archived badge
        if (archived && !archivedBadge) {
          archivedBadge = document.createElement('span');
          archivedBadge.className = 'badge badge--archived';
          archivedBadge.setAttribute('data-archived-badge', '');
          archivedBadge.textContent = 'ARCHIVED';
          actionsEl.insertBefore(archivedBadge, actionsEl.firstChild);
        } else if (!archived && archivedBadge) {
          archivedBadge.remove();
        }

        hideEditModal();
      } else {
        const errorMsg = data.errors ? data.errors.join(', ') : 'Failed to save';
        alert(errorMsg);
      }
    } catch (error) {
      console.error(error);
      alert('An error occurred. Please try again.');
    } finally {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }
  });

  // Global search functionality
  const globalSearch = document.querySelector('[data-global-search]');
  const searchContainer = document.querySelector('[data-global-search-container]');
  const searchResultsBox = document.querySelector('.section--search-results');

  if (globalSearch && searchContainer && searchResultsBox) {
    const columns = searchResultsBox.querySelectorAll('[data-results-column]');
    const noResultsEl = searchResultsBox.querySelector('[data-no-results]');
    const createNameInput = searchResultsBox.querySelector('[data-create-name]');
    const resultsGrid = searchResultsBox.querySelector('.section__columns');
    const resultsHeader = searchResultsBox.querySelector('[data-results-header]');

    globalSearch.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      const queryLower = query.toLowerCase();

      if (query === '') {
        searchContainer.classList.remove('open');
        return;
      }

      searchContainer.classList.add('open');

      let totalVisible = 0;

      columns.forEach((column) => {
        const items = column.querySelectorAll('.section__item--searchable');
        let columnVisible = 0;

        items.forEach((item) => {
          const name = item.dataset.searchName || '';
          const poc = item.dataset.searchPoc || '';
          const matches = name.includes(queryLower) || poc.includes(queryLower);
          item.hidden = !matches;
          if (matches) columnVisible++;
        });

        column.hidden = columnVisible === 0;
        totalVisible += columnVisible;
      });

      if (noResultsEl) {
        noResultsEl.hidden = totalVisible > 0;
        const capitalizedQuery = query.charAt(0).toUpperCase() + query.slice(1);
        if (createNameInput) createNameInput.value = capitalizedQuery;
      }

      if (resultsGrid) resultsGrid.hidden = totalVisible === 0;
      if (resultsHeader) resultsHeader.hidden = totalVisible === 0;
    });

    document.addEventListener('click', (e) => {
      const globalSearchEl = document.querySelector('.global-search');
      if (globalSearchEl && !globalSearchEl.contains(e.target)) {
        searchContainer.classList.remove('open');
        globalSearch.value = '';
      }
    });

    globalSearch.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchContainer.classList.remove('open');
        globalSearch.value = '';
        globalSearch.blur();
      }
    });

    const createForm = searchResultsBox.querySelector('[data-create-form]');
    if (createForm) {
      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(createForm);
        const submitBtn = createForm.querySelector('.global-search__create-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Creating...';
        submitBtn.disabled = true;

        try {
          const response = await fetch(createForm.action, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'X-CSRF-Token': formData.get('authenticity_token')
            },
            body: formData
          });

          const data = await response.json();

          if (response.ok) {
            showToast(`<a href="${data.url}">"${data.name}"</a> created as child project!`, 'success');
            searchContainer.classList.remove('open');
            globalSearch.value = '';
            createForm.reset();
          } else {
            const errorMsg = data.errors ? data.errors.join(', ') : 'Failed to create child project';
            showToast(errorMsg, 'error');
          }
        } catch (error) {
          showToast('An error occurred. Please try again.', 'error');
        } finally {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      });
    }
  }

  // Child projects tab switching
  const childTabs = document.querySelectorAll('[data-child-tab]');
  const childTabContents = document.querySelectorAll('[data-child-tab-content]');

  childTabs.forEach((tab) => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.childTab;

      childTabs.forEach((t) => t.classList.remove('active'));
      tab.classList.add('active');

      childTabContents.forEach((content) => {
        content.classList.toggle('active', content.dataset.childTabContent === tabName);
      });
    });
  });

  // Health dropdown
  const healthDropdown = document.querySelector('[data-health-dropdown]');
  const healthToggle = document.querySelector('[data-health-toggle]');
  const healthMenu = document.querySelector('[data-health-menu]');
  const healthInput = document.querySelector('[data-health-input]');
  const healthIndicator = document.querySelector('[data-health-indicator]');
  const healthLabel = document.querySelector('[data-health-label]');

  if (healthDropdown && healthToggle && healthMenu) {
    healthToggle.addEventListener('click', () => {
      healthMenu.classList.toggle('open');
    });

    healthMenu.querySelectorAll('[data-health-value]').forEach((option) => {
      option.addEventListener('click', () => {
        const value = option.dataset.healthValue;
        const label = value.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

        healthInput.value = value;
        healthLabel.textContent = label;
        healthIndicator.className = `health-dropdown__indicator health-dropdown__indicator--${value}`;
        healthMenu.classList.remove('open');
      });
    });

    document.addEventListener('click', (e) => {
      if (!healthDropdown.contains(e.target)) {
        healthMenu.classList.remove('open');
      }
    });
  }

  // Health update form AJAX submission
  const updateForm = document.querySelector('[data-update-form]');
  if (updateForm) {
    updateForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(updateForm);
      const submitBtn = updateForm.querySelector('[data-update-submit]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Adding...';
      submitBtn.disabled = true;

      try {
        const response = await fetch(updateForm.action, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': token
          },
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          // Get form values before reset
          const dateInput = updateForm.querySelector('[data-update-date]');
          const dateValue = dateInput.value;
          const healthValue = healthInput.value;
          const descInput = updateForm.querySelector('[data-update-description]');
          const descValue = descInput.value || '—';

          // Format date for display
          const dateParts = dateValue.split('-');
          const displayDate = `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}/${dateParts[0].slice(2)}`;

          // Create new update row
          const newRow = document.createElement('div');
          newRow.className = 'update-row';
          newRow.setAttribute('data-update-row', '');
          const healthLabelText = healthValue.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          newRow.innerHTML = `
            <span class="update-row__date">${displayDate}</span>
            <span class="update-row__health">
              <span class="health-indicator health-indicator--${healthValue}"></span>
              <span class="health-text">${healthLabelText}</span>
            </span>
            <span class="update-row__description">${descValue}</span>
          `;

          // Show header, hide empty state
          const header = document.querySelector('[data-updates-header]');
          const emptyState = document.querySelector('[data-updates-empty]');
          const container = document.querySelector('[data-updates-container]');

          if (header) header.hidden = false;
          if (emptyState) emptyState.hidden = true;

          // Prepend new row
          if (container) {
            container.insertBefore(newRow, container.firstChild);
          }

          // Reset description only (keep date and health for convenience)
          descInput.value = '';

          // Update metrics if health changed
          if (data.health) {
            const healthDotMetric = document.querySelector('.metric-widget__dot');
            const healthLabelMetric = document.querySelector('.metric-widget--health .metric-widget__label');
            if (healthDotMetric && healthLabelMetric) {
              const newHealthClass = data.health.replace(/_/g, '-');
              healthDotMetric.className = `metric-widget__dot metric-widget__dot--${newHealthClass}`;
              healthLabelMetric.className = `metric-widget__label metric-widget__label--${newHealthClass}`;
              healthLabelMetric.textContent = data.health.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            }
          }

          showToast('Update added!', 'success');
        } else {
          const errorMsg = data.errors ? data.errors.join(', ') : 'Failed to add update';
          showToast(errorMsg, 'error');
        }
      } catch (error) {
        console.error(error);
        showToast('An error occurred. Please try again.', 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
  }

  // Toast notification function
  function showToast(message, type = 'success') {
    const container = document.querySelector('[data-toast-container]');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast toast--${type}`;
    toast.innerHTML = message;

    container.appendChild(toast);

    requestAnimationFrame(() => {
      toast.classList.add('toast--visible');
    });

    setTimeout(() => {
      toast.classList.remove('toast--visible');
      setTimeout(() => toast.remove(), 300);
    }, 10000);

    toast.addEventListener('click', (e) => {
      if (e.target.tagName !== 'A') {
        toast.classList.remove('toast--visible');
        setTimeout(() => toast.remove(), 300);
      }
    });
  }
});
</script>
