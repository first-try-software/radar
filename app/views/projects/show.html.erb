<% allowed_states = SetProjectState::SETTABLE_STATES %>
<% project = @project || @project_record %>

<div class="project-hero" data-project-hero>
  <div class="project-hero__actions">
    <% if project.archived? %>
      <span class="badge badge--archived" data-archived-badge>ARCHIVED</span>
    <% end %>
    <div class="state-dropdown" data-state-dropdown>
      <button class="state-toggle" type="button" data-state-toggle>
        <span class="badge state state--<%= project.current_state.to_s.tr('_', '-') %>" data-state-badge><%= project.current_state.to_s.tr('_', ' ').upcase %></span>
      </button>
      <div class="state-menu" data-state-menu>
        <% if allowed_states.any? %>
          <% allowed_states.each do |state| %>
            <button type="button" data-state="<%= state %>"><%= state.to_s.tr('_', ' ').titleize %></button>
          <% end %>
        <% else %>
          <div class="empty">No further transitions</div>
        <% end %>
      </div>
    </div>
    <button type="button" class="project-hero__edit-btn" data-edit-toggle aria-label="Edit project">✎</button>
  </div>
  <h1 class="project-hero__title" data-project-title><%= project.name %></h1>
  <p class="project-hero__tagline" data-project-tagline<%= ' hidden' if project.description.blank? %>><%= project.description %></p>
  <p class="project-hero__contact" data-project-contact<%= ' hidden' if project.point_of_contact.blank? %>>For more information, contact <span data-project-poc><%= project.point_of_contact %></span>.</p>
</div>

<!-- Metrics Row -->
<% if @health_summary %>
<%
  health = @project_health || :not_available
  health_class = health.to_s.tr('_', '-')
  summary = @health_summary
  total = summary[:on_track] + summary[:at_risk] + summary[:off_track]
  raw_score = if total > 0
    (summary[:on_track] * 1 + summary[:at_risk] * 0 + summary[:off_track] * -1).to_f / total
  else
    nil
  end
  raw_score_display = raw_score ? raw_score.round(2) : 'N/A'
  is_leaf = project.leaf?
%>
<div class="initiative-dashboard-v2">
  <div class="metrics-row-v2">
    <!-- Health Widget -->
    <div class="metric-widget metric-widget--health metric-widget--<%= health_class %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Current Health</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
          <div class="widget-info__tooltip">
            <% if is_leaf %>
              <div class="widget-info__methodology">Based on the most recent health update for this project.</div>
            <% else %>
              <div class="widget-info__methodology">Average of all leaf-node project health scores.</div>
            <% end %>
            <div class="widget-info__range">
              <div>On Track = +1</div>
              <div>At Risk = 0</div>
              <div>Off Track = −1</div>
            </div>
            <div class="widget-info__score">Score: <%= raw_score_display %></div>
          </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <span class="metric-widget__dot metric-widget__dot--<%= health_class %>"></span>
        <div class="metric-widget__text">
          <div class="metric-widget__label metric-widget__label--<%= health_class %>"><%= health.to_s.tr('_', ' ').titleize %></div>
        </div>
      </div>
    </div>

    <!-- Trend Widget -->
    <% trend_class = @weeks_of_data >= 2 ? "trend-#{@trend_direction}" : 'trend-insufficient' %>
    <div class="metric-widget metric-widget--trend metric-widget--<%= trend_class %>">
      <div class="metric-widget__header">
        <span class="metric-widget__title">6-Week Trend</span>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="widget-info">
            <span class="widget-info__icon">i</span>
            <div class="widget-info__tooltip">
              <div class="widget-info__methodology">Weekly average health scores over the past 6 weeks.</div>
              <div class="widget-info__range">Range: −1.0 to +1.0 per week</div>
              <div class="widget-info__score">Delta: <%= @trend_delta >= 0 ? '+' : '' %><%= @trend_delta.round(2) %> (<%= @weeks_of_data %> weeks)</div>
            </div>
          </div>
        </div>
      </div>
      <div class="metric-widget__chart">
        <% if @weeks_of_data >= 2 %>
          <svg viewBox="0 0 200 50" preserveAspectRatio="none" class="trend-svg">
            <defs>
              <linearGradient id="project-trend-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <% @trend_data.each_with_index do |point, i| %>
                  <% offset = (i.to_f / [@trend_data.length - 1, 1].max * 100).round %>
                  <% color = point[:health] == :on_track ? '#22c55e' : (point[:health] == :off_track ? '#ef4444' : '#f59e0b') %>
                  <stop offset="<%= offset %>%" stop-color="<%= color %>" />
                <% end %>
              </linearGradient>
            </defs>
            <%
              points = @trend_data.each_with_index.map do |point, i|
                x = (i.to_f / [@trend_data.length - 1, 1].max * 180) + 10
                y = 45 - ((point[:score] + 1) / 2.0 * 40)
                [x, y]
              end
              points_str = points.map { |p| "#{p[0].round(1)},#{p[1].round(1)}" }.join(' ')
            %>
            <polyline class="trend-line-v2" stroke="url(#project-trend-gradient)" points="<%= points_str %>" />
            <% points.each_with_index do |p, i| %>
              <% pt_health = @trend_data[i][:health] %>
              <circle cx="<%= p[0].round(1) %>" cy="<%= p[1].round(1) %>" r="4" class="trend-point-v2 trend-point-v2--<%= pt_health %>" />
            <% end %>
          </svg>
        <% elsif @weeks_of_data == 1 %>
          <div class="metric-widget__no-data">1 week of data</div>
        <% else %>
          <div class="metric-widget__no-data">Insufficient data</div>
        <% end %>
      </div>
    </div>

    <!-- Confidence Widget -->
    <%
      confidence_cta = case @confidence_factors&.dig(:biggest_drag)
      when :variance
        { text: "Volatile health trend", type: :info }
      when :staleness
        days = @confidence_factors.dig(:details, :days_since_update)
        { text: "Data is #{days}+ days old", type: :warning }
      when :coverage
        count = @confidence_factors.dig(:details, :projects_needing_update) || 0
        { text: "#{count} #{'project'.pluralize(count)} need updates", type: :warning }
      when :insufficient_data
        { text: "Building history...", type: :info }
      else
        nil
      end
    %>
    <div class="metric-widget metric-widget--confidence metric-widget--confidence-<%= @confidence_level %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Confidence</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
          <div class="widget-info__tooltip">
            <div class="widget-info__methodology">Based on trend consistency and data freshness.</div>
            <div class="widget-info__range">
              <div>Range: 0–100</div>
              <div>High ≥70</div>
              <div>Medium ≥40</div>
              <div>Low &lt;40</div>
            </div>
            <div class="widget-info__score">Score: <%= @confidence_score %></div>
          </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <div class="confidence-ring">
          <svg viewBox="0 0 44 44">
            <circle class="confidence-ring__bg" cx="22" cy="22" r="18" />
            <% circumference = 2 * Math::PI * 18 %>
            <% offset = circumference - (@confidence_score / 100.0 * circumference) %>
            <circle class="confidence-ring__fill confidence-ring__fill--<%= @confidence_level %>"
                    cx="22" cy="22" r="18"
                    stroke-dasharray="<%= circumference.round(1) %>"
                    stroke-dashoffset="<%= offset.round(1) %>" />
          </svg>
        </div>
        <div class="metric-widget__text">
          <div class="metric-widget__label confidence-label--<%= @confidence_level %>"><%= @confidence_level.to_s.titleize %></div>
          <% if confidence_cta && @confidence_level != :high %>
            <span class="metric-widget__hint"><%= confidence_cta[:text] %></span>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
<% end %>

<!-- Edit Modal -->
<div class="modal-overlay" data-edit-modal hidden>
  <div class="modal">
    <div class="modal__header">
      <h3>Edit Project</h3>
    </div>
    <form class="edit-project-form" data-edit-form>
      <div class="modal__body">
        <div class="form-field">
          <label for="project_name" class="form-field__label">Name</label>
          <input type="text" id="project_name" name="project[name]" class="form-field__input" value="<%= @project_record.name %>" required data-input-name>
        </div>
        <div class="form-field">
          <label for="project_description" class="form-field__label">Brief Description</label>
          <input type="text" id="project_description" name="project[description]" class="form-field__input" value="<%= @project_record.description %>" data-input-description>
        </div>
        <div class="form-field">
          <label for="project_point_of_contact" class="form-field__label">Contact(s)</label>
          <input type="text" id="project_point_of_contact" name="project[point_of_contact]" class="form-field__input" value="<%= @project_record.point_of_contact %>" data-input-poc>
        </div>
        <div class="form-field form-field--archive">
          <span class="form-field__label">Archive this project and remove it from view?</span>
          <label class="checkbox-field">
            <input type="hidden" name="project[archived]" value="0">
            <input type="checkbox" name="project[archived]" value="1" class="checkbox-field__input" <%= 'checked' if @project_record.archived %> data-archive-checkbox>
            <span class="checkbox-field__box"></span>
            <span class="checkbox-field__label" data-archive-label><%= @project_record.archived ? 'This project is archived and hidden.' : 'Click checkbox to archive' %></span>
          </label>
        </div>
      </div>
      <div class="modal__actions">
        <button type="button" class="btn secondary" data-edit-cancel>Cancel</button>
        <button type="submit" class="btn" data-edit-save>Save</button>
      </div>
    </form>
  </div>
</div>

<% if defined?(@errors) && @errors.present? %>
  <div class="errors">
    <ul>
      <% @errors.each do |err| %>
        <li><%= err %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const token = document.querySelector('meta[name="csrf-token"]')?.content;

  // State dropdown
  const stateDropdown = document.querySelector('[data-state-dropdown]');
  const stateToggle = document.querySelector('[data-state-toggle]');
  const stateMenu = document.querySelector('[data-state-menu]');

  if (stateDropdown && stateToggle && stateMenu) {
    stateToggle.addEventListener('click', () => {
      stateMenu.classList.toggle('open');
    });

    stateMenu.querySelectorAll('button[data-state]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const state = btn.dataset.state;
        stateMenu.classList.remove('open');

        fetch('<%= state_project_path(@project_record) %>', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ state })
        }).then((resp) => {
          if (resp.ok) {
            window.location.reload();
          }
        }).catch((err) => console.error(err));
      });
    });

    document.addEventListener('click', (e) => {
      if (!stateDropdown.contains(e.target)) {
        stateMenu.classList.remove('open');
      }
    });
  }

  // Edit modal
  const editToggle = document.querySelector('[data-edit-toggle]');
  const editModal = document.querySelector('[data-edit-modal]');
  const editCancel = document.querySelector('[data-edit-cancel]');
  const editForm = document.querySelector('[data-edit-form]');

  const showEditModal = () => {
    editModal.hidden = false;
  };

  const hideEditModal = () => {
    editModal.hidden = true;
  };

  editToggle?.addEventListener('click', showEditModal);
  editCancel?.addEventListener('click', hideEditModal);

  editModal?.addEventListener('click', (e) => {
    if (e.target === editModal) hideEditModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && editModal && !editModal.hidden) {
      hideEditModal();
    }
  });

  // Dynamic archive checkbox label
  const archiveCheckbox = document.querySelector('[data-archive-checkbox]');
  const archiveLabel = document.querySelector('[data-archive-label]');

  archiveCheckbox?.addEventListener('change', () => {
    archiveLabel.textContent = archiveCheckbox.checked
      ? 'This project is archived and hidden.'
      : 'Click checkbox to archive';
  });

  // AJAX form submission
  editForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(editForm);
    const saveBtn = editForm.querySelector('[data-edit-save]');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;

    try {
      const response = await fetch('<%= project_path(@project_record) %>', {
        method: 'PATCH',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': token
        },
        body: formData
      });

      const data = await response.json();

      if (response.ok) {
        // Update hero section
        const titleEl = document.querySelector('[data-project-title]');
        const taglineEl = document.querySelector('[data-project-tagline]');
        const contactEl = document.querySelector('[data-project-contact]');
        const pocEl = document.querySelector('[data-project-poc]');
        const actionsEl = document.querySelector('.project-hero__actions');
        let archivedBadge = document.querySelector('[data-archived-badge]');

        const name = formData.get('project[name]');
        const description = formData.get('project[description]');
        const poc = formData.get('project[point_of_contact]');
        const archived = formData.get('project[archived]') === '1';

        if (titleEl) titleEl.textContent = name;

        if (taglineEl) {
          taglineEl.textContent = description;
          taglineEl.hidden = !description;
        }

        if (contactEl && pocEl) {
          pocEl.textContent = poc;
          contactEl.hidden = !poc;
        }

        // Handle archived badge
        if (archived && !archivedBadge) {
          archivedBadge = document.createElement('span');
          archivedBadge.className = 'badge badge--archived';
          archivedBadge.setAttribute('data-archived-badge', '');
          archivedBadge.textContent = 'ARCHIVED';
          actionsEl.insertBefore(archivedBadge, actionsEl.firstChild);
        } else if (!archived && archivedBadge) {
          archivedBadge.remove();
        }

        hideEditModal();
      } else {
        const errorMsg = data.errors ? data.errors.join(', ') : 'Failed to save';
        alert(errorMsg);
      }
    } catch (error) {
      console.error(error);
      alert('An error occurred. Please try again.');
    } finally {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }
  });
});
</script>
