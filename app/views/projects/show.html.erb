<% content_for(:title) { "#{@project_record.name} - Radar" } %>
<% allowed_states = SetProjectState::SETTABLE_STATES %>
<% project = @project || @project_record %>

<div data-controller="edit-form" data-edit-form-url-value="<%= project_path(@project_record) %>">

<!-- Sticky Header -->
<div class="sticky-header" data-sticky-header>
  <div class="sticky-header__container">
    <div class="sticky-header__left">
      <div class="sticky-header__breadcrumb">
        <%= @project ? project_breadcrumb(@project, @project_record) : render_breadcrumb([{ name: 'Radar', path: root_path }]) %>
      </div>
      <div class="sticky-header__title-row">
        <img src="/logo-radar-animated-loop-v8.svg" alt="" class="sticky-header__logo">
        <h2 class="sticky-header__title"><%= project.name %></h2>
      </div>
    </div>
    <div class="sticky-header__right">
      <div class="sticky-header__actions">
        <% if project.archived? %>
          <span class="badge badge--archived">ARCHIVED</span>
        <% end %>
        <div class="sticky-header__badge">
          <span class="badge state state--<%= project.current_state.to_s.tr('_', '-') %>" data-state-badge><%= project.current_state.to_s.tr('_', ' ').upcase %></span>
        </div>
        <button type="button" class="sticky-header__edit-btn" data-action="edit-form#open" aria-label="Edit project">✎</button>
      </div>
      <% sticky_contact = @project&.effective_contact || project.point_of_contact %>
      <% if sticky_contact.present? %>
        <span class="sticky-header__contact">Contact: <%= sticky_contact %></span>
      <% else %>
        <span class="sticky-header__contact sticky-header__contact--missing">No contact specified</span>
      <% end %>
    </div>
  </div>
</div>

<div class="project-hero" data-project-hero>
  <div class="project-hero__breadcrumb" data-hero-breadcrumb>
    <%= @project ? project_breadcrumb(@project, @project_record) : render_breadcrumb([{ name: 'Radar', path: root_path }]) %>
  </div>
  <div class="project-hero__actions">
    <% if project.archived? %>
      <span class="badge badge--archived" data-archived-badge>ARCHIVED</span>
    <% end %>
    <div class="state-pill-dropdown"
         data-controller="state-dropdown"
         data-state-dropdown-url-value="<%= state_project_path(@project_record) %>">
      <button class="state-pill-toggle" type="button" data-action="state-dropdown#toggle">
        <span class="state-pill state-pill--<%= project.current_state.to_s.tr('_', '-') %>" data-state-badge><%= project.current_state.to_s.tr('_', ' ').titleize %></span>
        <span class="state-pill-arrow">▾</span>
      </button>
      <div class="state-pill-menu state-pill-menu--down" data-state-dropdown-target="menu">
        <% if allowed_states.any? %>
          <% allowed_states.each do |state| %>
            <button type="button" class="state-pill-option" data-state="<%= state %>" data-action="state-dropdown#select">
              <span class="state-pill state-pill--<%= state.to_s.tr('_', '-') %>"><%= state.to_s.tr('_', ' ').titleize %></span>
            </button>
          <% end %>
        <% else %>
          <div class="empty">No further transitions</div>
        <% end %>
      </div>
    </div>
    <button type="button" class="project-hero__edit-btn" data-action="edit-form#open" aria-label="Edit project">✎</button>
  </div>
  <h1 class="project-hero__title" data-project-title><%= project.name %></h1>
  <p class="project-hero__tagline" data-project-tagline<%= ' hidden' if project.description.blank? %>><%= project.description %></p>
  <% effective_contact = @project&.effective_contact || project.point_of_contact %>
  <% if effective_contact.present? %>
    <p class="project-hero__contact" data-project-contact>For more information, contact <span data-project-poc><%= effective_contact %></span>.</p>
  <% else %>
    <p class="project-hero__contact project-hero__contact--missing" data-project-contact>Psst! Do me a favor! Tell me who to call if this thing breaks!</p>
  <% end %>
</div>

<!-- Metrics Row -->
<% if @health_summary %>
<%
  health = @project_health || :not_available
  health_class = health.to_s.tr('_', '-')
  summary = @health_summary
  total = summary[:on_track] + summary[:at_risk] + summary[:off_track]
  raw_score = if total > 0
    (summary[:on_track] * 1 + summary[:at_risk] * 0 + summary[:off_track] * -1).to_f / total
  else
    nil
  end
  raw_score_display = raw_score ? raw_score.round(2) : 'N/A'
  is_leaf = project.leaf?

  # Calculate off-track and active counts from direct children
  unless is_leaf
    children = @project&.children || []
    active_states = [:in_progress, :blocked]
    active_children = children.select { |p| active_states.include?(p.current_state) }
    off_track_active = active_children.select { |p| p.health == :off_track }
    off_track_count = off_track_active.size
    active_count = active_children.size
  end
%>
<turbo-frame id="metrics-row">
<div class="initiative-dashboard-v2">
  <div class="metrics-row-v2">
    <!-- Health Widget -->
    <div id="health-widget" class="metric-widget metric-widget--health metric-widget--<%= health_class %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Current Health</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
          <div class="widget-info__tooltip">
            <% if is_leaf %>
              <div class="widget-info__methodology">Based on the most recent health update for this project.</div>
            <% else %>
              <div class="widget-info__methodology">Average of all leaf-node project health scores.</div>
            <% end %>
            <div class="widget-info__range">
              <div>On Track = +1</div>
              <div>At Risk = 0</div>
              <div>Off Track = −1</div>
            </div>
            <div class="widget-info__score">Score: <%= raw_score_display %></div>
          </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <span class="metric-widget__dot metric-widget__dot--<%= health_class %>"></span>
        <div class="metric-widget__text">
          <div class="metric-widget__label metric-widget__label--<%= health_class %>"><%= health.to_s.tr('_', ' ').titleize %></div>
          <% if !is_leaf && off_track_count && off_track_count > 0 %>
            <div class="metric-widget__detail"><%= off_track_count %> of <%= active_count %> child <%= 'project'.pluralize(active_count) %> off-track</div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Trend Widget -->
    <% trend_class = @weeks_of_data >= 2 ? "trend-#{@trend_direction}" : 'trend-insufficient' %>
    <div id="trend-widget" class="metric-widget metric-widget--trend metric-widget--<%= trend_class %>">
      <div class="metric-widget__header">
        <span class="metric-widget__title">6-Week Trend</span>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="widget-info">
            <span class="widget-info__icon">i</span>
            <div class="widget-info__tooltip">
              <div class="widget-info__methodology">Weekly average health scores over the past 6 weeks.</div>
              <div class="widget-info__range">Range: −1.0 to +1.0 per week</div>
              <div class="widget-info__score">Delta: <%= @trend_delta >= 0 ? '+' : '' %><%= @trend_delta.round(2) %> (<%= @weeks_of_data %> weeks)</div>
            </div>
          </div>
        </div>
      </div>
      <div class="metric-widget__chart">
        <% if @weeks_of_data >= 2 %>
          <svg viewBox="0 0 200 50" preserveAspectRatio="none" class="trend-svg">
            <defs>
              <linearGradient id="project-trend-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <% @trend_data.each_with_index do |point, i| %>
                  <% offset = (i.to_f / [@trend_data.length - 1, 1].max * 100).round %>
                  <% color = point[:health] == :on_track ? '#22c55e' : (point[:health] == :off_track ? '#ef4444' : '#f59e0b') %>
                  <stop offset="<%= offset %>%" stop-color="<%= color %>" />
                <% end %>
              </linearGradient>
            </defs>
            <%
              points = @trend_data.each_with_index.map do |point, i|
                x = (i.to_f / [@trend_data.length - 1, 1].max * 180) + 10
                y = 45 - ((point[:score] + 1) / 2.0 * 40)
                [x, y]
              end
              points_str = points.map { |p| "#{p[0].round(1)},#{p[1].round(1)}" }.join(' ')
            %>
            <polyline class="trend-line-v2" stroke="url(#project-trend-gradient)" points="<%= points_str %>" />
            <% points.each_with_index do |p, i| %>
              <% pt_health = @trend_data[i][:health] %>
              <circle cx="<%= p[0].round(1) %>" cy="<%= p[1].round(1) %>" r="4" class="trend-point-v2 trend-point-v2--<%= pt_health %>" />
            <% end %>
          </svg>
        <% elsif @weeks_of_data == 1 %>
          <div class="metric-widget__no-data">1 week of data</div>
        <% else %>
          <div class="metric-widget__no-data">Insufficient data</div>
        <% end %>
      </div>
    </div>

    <!-- Confidence Widget -->
    <%
      confidence_hint = case @confidence_factors&.dig(:biggest_drag)
      when :variance
        "Volatile health trend"
      when :staleness
        "Data growing stale"
      when :coverage
        "Update coverage is uneven"
      when :insufficient_data
        "Building history..."
      else
        nil
      end
    %>
    <div id="confidence-widget" class="metric-widget metric-widget--confidence metric-widget--confidence-<%= @confidence_level %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Confidence</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
          <div class="widget-info__tooltip">
            <div class="widget-info__methodology">Based on trend consistency and data freshness.</div>
            <div class="widget-info__range">
              <div>Range: 0–100</div>
              <div>High ≥70</div>
              <div>Medium ≥40</div>
              <div>Low &lt;40</div>
            </div>
            <div class="widget-info__score">Score: <%= @confidence_score %></div>
          </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <div class="confidence-ring">
          <svg viewBox="0 0 44 44">
            <circle class="confidence-ring__bg" cx="22" cy="22" r="18" />
            <% circumference = 2 * Math::PI * 18 %>
            <% offset = circumference - (@confidence_score / 100.0 * circumference) %>
            <circle class="confidence-ring__fill confidence-ring__fill--<%= @confidence_level %>"
                    cx="22" cy="22" r="18"
                    stroke-dasharray="<%= circumference.round(1) %>"
                    stroke-dashoffset="<%= offset.round(1) %>" />
          </svg>
        </div>
        <div class="metric-widget__text">
          <div class="metric-widget__label confidence-label--<%= @confidence_level %>"><%= @confidence_level.to_s.titleize %></div>
          <% if confidence_hint && @confidence_level != :high %>
            <span class="metric-widget__hint"><%= confidence_hint %></span>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
</turbo-frame>
<% end %>

<!-- Toast Container -->
<div class="toast-container" data-toast-container></div>

<!-- Global Search -->
<%
  # Build flat list of all teams with ancestry for search
  all_teams_flat = []
  build_team_tree = ->(teams, ancestors = []) do
    teams.sort_by(&:name).each do |team|
      path = ancestors + [team.name]
      all_teams_flat << { entity: team, type: :team, path: path, record: TeamRecord.find_by(name: team.name) }
      build_team_tree.call(team.subordinate_teams, path) if team.subordinate_teams.any?
    end
  end
  build_team_tree.call(@teams) if @teams

  # Build flat list of all initiatives
  all_initiatives_flat = (@initiatives || []).map do |initiative|
    { entity: initiative, type: :initiative, record: InitiativeRecord.find_by(name: initiative.name) }
  end

  # Build flat list of all projects
  all_projects_flat = (@all_projects || []).map do |proj|
    { entity: proj, type: :project, record: ProjectRecord.find_by(name: proj.name) }
  end
%>
<div class="global-search" data-controller="search">
  <input type="text"
         class="global-search__input"
         placeholder="<%= @project&.leaf? ? 'Find what you are looking for...' : 'Find or create what you are looking for...' %>"
         data-search-target="input"
         data-action="input->search#search keydown->search#escape">
  <div class="global-search__results-container" data-search-target="container">
    <div class="section section--search-results">
      <h3 class="section__title" data-search-target="resultsHeader">Results</h3>
      <div class="section__columns" data-search-target="resultsGrid">
        <!-- Teams Column -->
        <div class="section__column" data-search-target="column" data-results-column="teams">
          <h4 class="section__subtitle">Teams</h4>
          <ul class="section__list">
            <% all_teams_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="team"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= team_path(entry[:record]) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Initiatives Column -->
        <div class="section__column" data-search-target="column" data-results-column="initiatives">
          <h4 class="section__subtitle">Initiatives</h4>
          <ul class="section__list">
            <% all_initiatives_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="initiative"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= initiative_path(entry[:record]) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Projects Column -->
        <div class="section__column" data-search-target="column" data-results-column="projects">
          <h4 class="section__subtitle">Projects</h4>
          <ul class="section__list">
            <% all_projects_flat.each do |entry| %>
              <li class="section__item section__item--searchable"
                  data-search-type="project"
                  data-search-name="<%= entry[:entity].name.downcase %>"
                  data-search-poc="<%= entry[:entity].point_of_contact.to_s.downcase %>">
                <a href="<%= project_path(entry[:record]) %>" class="section__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= entry[:entity].health || :not_available %>"></span>
                  <span class="section__name"><%= entry[:entity].name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <!-- No Results -->
      <div class="global-search__no-results" data-search-target="noResults" hidden>
        <% if @project&.leaf? %>
          <p class="global-search__no-results-message">No matching results. This project tracks health updates directly and cannot have child projects.</p>
        <% else %>
          <h3 class="section__title">Create Child Project</h3>
          <div class="global-search__form-card">
            <%= form_with url: subordinates_project_path(@project_record), method: :post, local: false, class: "global-search__create-form" do |f| %>
              <div class="global-search__form-fields-inline">
                <input type="text" name="project[name]" class="global-search__form-input" placeholder="Project Name (required)" data-search-target="createName" required>
                <input type="text" name="project[description]" class="global-search__form-input" placeholder="Description (highly recommended)">
                <input type="text" name="project[point_of_contact]" class="global-search__form-input" placeholder="Contacts (highly recommended)">
                <button type="submit" class="global-search__create-btn">Create Child Project</button>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Child Projects Section (only for parent projects) -->
<% if @project && !@project.leaf? %>
<%
  all_children = @project.children
  direct_children = all_children.reject { |p| p.respond_to?(:archived?) && p.archived? }
  archived_projects = all_children.select { |p| p.respond_to?(:archived?) && p.archived? }
  sorted_descendants = sort_projects_canonical(direct_children)
  sorted_archived = sort_projects_canonical(archived_projects)

  unhealthy = direct_children.select { |p| [:off_track, :at_risk].include?(p.health) }
  sorted_unhealthy = sort_projects_canonical(unhealthy)

  stale = direct_children.select do |p|
    next false unless [:in_progress, :blocked].include?(p.current_state)
    latest = p.latest_health_update
    latest.nil? || (Date.current - latest.date.to_date).to_i > 7
  end
  sorted_stale = sort_projects_canonical(stale)

  active_states = [:new, :in_progress, :blocked]
  inactive_states = [:completed, :paused, :cancelled]

  active_projects = direct_children.select { |p| active_states.include?(p.current_state) }
  sorted_active = sort_projects_canonical(active_projects)

  inactive_projects = direct_children.select { |p| inactive_states.include?(p.current_state) }
  sorted_inactive = sort_projects_canonical(inactive_projects)
%>
<section class="section section--projects" data-controller="tabs inline-form" data-tabs-active-value="all">
  <div class="section__title-row">
    <h3 class="section__title">Child Projects</h3>
    <div class="dashboard-tabs-v2">
      <button class="dashboard-tab-v2 active" data-tabs-target="tab" data-tabs-name="all" data-action="tabs#switch">
        All <span class="dashboard-tab-v2__count"><%= direct_children.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="unhealthy" data-action="tabs#switch">
        Unhealthy <span class="dashboard-tab-v2__count"><%= unhealthy.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="stale" data-action="tabs#switch">
        Stale <span class="dashboard-tab-v2__count"><%= stale.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="active" data-action="tabs#switch">
        Active <span class="dashboard-tab-v2__count"><%= active_projects.size %></span>
      </button>
      <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="inactive" data-action="tabs#switch">
        Inactive <span class="dashboard-tab-v2__count"><%= inactive_projects.size %></span>
      </button>
      <% if archived_projects.any? %>
        <button class="dashboard-tab-v2" data-tabs-target="tab" data-tabs-name="archived" data-action="tabs#switch">
          Archived <span class="dashboard-tab-v2__count"><%= archived_projects.size %></span>
        </button>
      <% end %>
      <button class="dashboard-tab-v2 dashboard-tab-v2--add"
              data-inline-form-target="toggle"
              data-action="inline-form#toggle"
              aria-label="Create child project">+</button>
    </div>
  </div>

  <!-- Create Child Project Form (inline) -->
  <div class="inline-create-section" data-inline-form-target="section" hidden>
    <%= form_with url: subordinates_project_path(@project_record), method: :post, local: false, class: "inline-create-form" do |f| %>
      <div class="inline-create-form__row">
        <input type="text" name="project[name]" class="inline-create-form__input" placeholder="Project Name (required)" required>
        <input type="text" name="project[description]" class="inline-create-form__input" placeholder="Brief Description (highly recommended)">
        <input type="text" name="project[point_of_contact]" class="inline-create-form__input" placeholder="Contacts (highly recommended)">
        <button type="submit" class="btn btn--small">Create Child Project</button>
      </div>
    <% end %>
  </div>

  <!-- Tab Content: All -->
  <div class="tab-content-v2 active" data-tabs-target="content" data-tabs-name="all">
      <% if direct_children.empty? %>
        <div class="tab-empty-v2">No child projects</div>
      <% else %>
        <ul class="project-list-v2">
          <%= render 'dashboard/project_list_header' %>
          <% sorted_descendants.each do |child_project| %>
            <%= render 'dashboard/project_list_item', project: child_project %>
          <% end %>
        </ul>
      <% end %>
    </div>

    <!-- Tab Content: Unhealthy -->
    <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="unhealthy">
      <% if unhealthy.empty? %>
        <div class="tab-empty-v2">All child projects are healthy!</div>
      <% else %>
        <ul class="project-list-v2">
          <%= render 'dashboard/project_list_header' %>
          <% sorted_unhealthy.each do |child_project| %>
            <%= render 'dashboard/project_list_item', project: child_project %>
          <% end %>
        </ul>
      <% end %>
    </div>

    <!-- Tab Content: Stale -->
    <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="stale">
      <% if stale.empty? %>
        <div class="tab-empty-v2">All child projects are up to date!</div>
      <% else %>
        <ul class="project-list-v2">
          <%= render 'dashboard/project_list_header' %>
          <% sorted_stale.each do |child_project| %>
            <%= render 'dashboard/project_list_item', project: child_project, tag_text: 'Stale', tag_modifier: 'stale' %>
          <% end %>
        </ul>
      <% end %>
    </div>

    <!-- Tab Content: Active -->
    <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="active">
      <% if active_projects.empty? %>
        <div class="tab-empty-v2">No active child projects</div>
      <% else %>
        <ul class="project-list-v2">
          <%= render 'dashboard/project_list_header' %>
          <% sorted_active.each do |child_project| %>
            <% tag_text = child_project.current_state == :blocked ? 'Blocked' : nil %>
            <% tag_modifier = child_project.current_state == :blocked ? 'blocked' : nil %>
            <%= render 'dashboard/project_list_item', project: child_project, tag_text: tag_text, tag_modifier: tag_modifier %>
          <% end %>
        </ul>
      <% end %>
    </div>

    <!-- Tab Content: Inactive -->
    <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="inactive">
      <% if inactive_projects.empty? %>
        <div class="tab-empty-v2">No inactive child projects</div>
      <% else %>
        <ul class="project-list-v2">
          <%= render 'dashboard/project_list_header' %>
          <% sorted_inactive.each do |child_project| %>
            <% tag_text = child_project.current_state.to_s.tr('_', ' ').titleize %>
            <%= render 'dashboard/project_list_item', project: child_project, tag_text: tag_text, tag_modifier: 'inactive' %>
          <% end %>
        </ul>
      <% end %>
    </div>

    <!-- Tab Content: Archived -->
    <% if archived_projects.any? %>
      <div class="tab-content-v2" data-tabs-target="content" data-tabs-name="archived">
        <ul class="project-list-v2">
          <%= render 'dashboard/project_list_header' %>
          <% sorted_archived.each do |child_project| %>
            <%= render 'dashboard/project_list_item', project: child_project, tag_text: 'Archived', tag_modifier: 'archived' %>
          <% end %>
      </ul>
    </div>
  <% end %>
</section>
<% end %>

<!-- Updates Section (only for leaf projects) -->
<% if @project&.leaf? %>
<turbo-frame id="updates-section">
<section class="section section--updates">
  <h3 class="section__title">Updates</h3>

  <!-- Create Update Form -->
  <div class="inline-create-section"
       data-controller="health-update-form"
       data-health-update-form-state-url-value="<%= state_project_path(@project_record) %>"
       data-action="health-picker:selected->health-update-form#healthSelected health-picker:reset->health-update-form#healthReset">
    <%= form_with url: health_updates_project_path(@project_record),
                  method: :post,
                  local: false,
                  class: "update-form",
                  data: { health_update_form_target: "form", action: "submit->health-update-form#submit" } do |f| %>
      <input type="hidden" name="health_update[date]" value="<%= Date.current.strftime('%Y-%m-%d') %>">
      <input type="hidden" name="health_update[health]" value="" data-health-update-form-target="healthInput">
      <div class="inline-create-form__row">
        <div class="health-picker" data-controller="health-picker">
          <button type="button"
                  class="health-picker__btn health-picker__btn--on_track"
                  data-health-picker-target="button"
                  data-health-picker-value="on_track"
                  data-action="health-picker#select"
                  title="On Track">
            <span class="health-picker__dot"></span>
          </button>
          <button type="button"
                  class="health-picker__btn health-picker__btn--at_risk"
                  data-health-picker-target="button"
                  data-health-picker-value="at_risk"
                  data-action="health-picker#select"
                  title="At Risk">
            <span class="health-picker__dot"></span>
          </button>
          <button type="button"
                  class="health-picker__btn health-picker__btn--off_track"
                  data-health-picker-target="button"
                  data-health-picker-value="off_track"
                  data-action="health-picker#select"
                  title="Off Track">
            <span class="health-picker__dot"></span>
          </button>
        </div>
        <input type="text"
               name="health_update[description]"
               class="inline-create-form__input"
               placeholder="What's the current status? Any blockers?"
               data-health-update-form-target="description"
               data-action="keydown->health-update-form#handleInputKeydown">
        <div class="state-pill-dropdown" data-health-update-form-target="stateDropdown">
          <button type="button" class="state-pill-toggle" data-action="health-update-form#toggleStateDropdown">
            <span class="state-pill state-pill--<%= project.current_state.to_s.tr('_', '-') %>" data-health-update-form-target="stateDisplay"><%= project.current_state.to_s.tr('_', ' ').titleize %></span>
            <span class="state-pill-arrow">▾</span>
          </button>
          <input type="hidden" name="project_state" value="" data-health-update-form-target="stateInput">
          <div class="state-pill-menu">
            <% allowed_states.each do |state| %>
              <button type="button" class="state-pill-option" data-state-value="<%= state %>" data-action="health-update-form#selectState">
                <span class="state-pill state-pill--<%= state.to_s.tr('_', '-') %>"><%= state.to_s.tr('_', ' ').titleize %></span>
              </button>
            <% end %>
          </div>
        </div>
        <button type="submit"
                class="btn btn--small btn--disabled"
                data-health-update-form-target="submit"
                disabled>Update</button>
      </div>
    <% end %>
  </div>

  <div class="updates-list">
    <!-- Existing Updates Header -->
    <div class="updates-header" data-health-update-form-target="updatesHeader"<%= ' hidden' unless @health_updates&.any? %>>
      <span class="updates-header__col updates-header__col--date">Date</span>
      <span class="updates-header__col updates-header__col--health">Health</span>
      <span class="updates-header__col updates-header__col--description">Description</span>
    </div>

    <!-- Existing Updates Container -->
    <div id="updates-container" data-health-update-form-target="updatesContainer">
      <% if @health_updates&.any? %>
        <% @health_updates.each do |update| %>
          <%= render "projects/update_row", update: update %>
        <% end %>
      <% end %>
    </div>

    <!-- Empty State -->
    <div class="updates-empty" data-health-update-form-target="updatesEmpty"<%= ' hidden' if @health_updates&.any? %>>No updates yet. Add your first update above!</div>
  </div>
</section>
</turbo-frame>
<% end %>

<!-- Edit Modal -->
<div class="modal-overlay"
     data-edit-form-target="modal"
     data-action="click->edit-form#closeOnBackdrop keydown.escape@document->edit-form#close"
     hidden>
  <div class="modal">
    <div class="modal__header">
      <h3>Edit Project</h3>
    </div>
    <%= form_with model: @project_record,
                  url: project_path(@project_record),
                  method: :patch,
                  local: false,
                  class: "edit-project-form",
                  data: { edit_form_target: "form", action: "submit->edit-form#submit" } do |f| %>
      <div class="modal__body">
        <div class="form-field">
          <label for="project_name" class="form-field__label">Name</label>
          <input type="text" id="project_name" name="project[name]" class="form-field__input" value="<%= @project_record.name %>" required>
        </div>
        <div class="form-field">
          <label for="project_description" class="form-field__label">Brief Description</label>
          <input type="text" id="project_description" name="project[description]" class="form-field__input" value="<%= @project_record.description %>">
        </div>
        <div class="form-field">
          <label for="project_point_of_contact" class="form-field__label">Contact(s)</label>
          <input type="text" id="project_point_of_contact" name="project[point_of_contact]" class="form-field__input" value="<%= @project_record.point_of_contact %>">
        </div>
        <div class="form-field form-field--archive">
          <span class="form-field__label">Archive this project and remove it from view?</span>
          <label class="checkbox-field">
            <input type="hidden" name="project[archived]" value="0">
            <input type="checkbox"
                   name="project[archived]"
                   value="1"
                   class="checkbox-field__input"
                   <%= 'checked' if @project_record.archived %>
                   data-edit-form-target="archiveCheckbox"
                   data-action="change->edit-form#updateArchiveLabel">
            <span class="checkbox-field__box"></span>
            <span class="checkbox-field__label" data-edit-form-target="archiveLabel"><%= @project_record.archived ? 'This project is archived and hidden.' : 'Click checkbox to archive' %></span>
          </label>
        </div>
      </div>
      <div class="modal__actions">
        <button type="button" class="btn secondary" data-action="edit-form#close">Cancel</button>
        <button type="submit" class="btn" data-edit-form-target="saveButton">Save</button>
      </div>
    <% end %>
  </div>
</div>

</div><!-- end edit-form controller wrapper -->

<% if defined?(@errors) && @errors.present? %>
  <div class="errors">
    <ul>
      <% @errors.each do |err| %>
        <li><%= err %></li>
      <% end %>
    </ul>
  </div>
<% end %>
