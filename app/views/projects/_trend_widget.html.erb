<%
  weeks_of_data = local_assigns[:weeks_of_data] || 0
  trend_direction = local_assigns[:trend_direction] || 'stable'
  trend_delta = local_assigns[:trend_delta] || 0
  trend_data = local_assigns[:trend_data] || []

  trend_class = weeks_of_data >= 2 ? "trend-#{trend_direction}" : 'trend-insufficient'
%>
<div id="trend-widget" class="metric-widget metric-widget--trend metric-widget--<%= trend_class %>">
  <div class="metric-widget__header">
    <span class="metric-widget__title">6-Week Trend</span>
    <div style="display: flex; align-items: center; gap: 8px;">
      <div class="info-tooltip">
        <span class="info-tooltip__icon">i</span>
        <div class="info-tooltip__tooltip">
          <div class="info-tooltip__methodology">Weekly average health scores over the past 6 weeks.</div>
          <div class="info-tooltip__range">Range: âˆ’1.0 to +1.0 per week</div>
          <div class="info-tooltip__score">Delta: <%= trend_delta >= 0 ? '+' : '' %><%= trend_delta.round(2) %> (<%= weeks_of_data %> weeks)</div>
        </div>
      </div>
    </div>
  </div>
  <div class="metric-widget__chart">
    <% if weeks_of_data >= 2 %>
      <svg viewBox="0 0 200 50" preserveAspectRatio="none" class="trend-svg">
        <defs>
          <linearGradient id="project-trend-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <% trend_data.each_with_index do |point, i| %>
              <% offset = (i.to_f / [trend_data.length - 1, 1].max * 100).round %>
              <% color = point[:health] == :on_track ? '#22c55e' : (point[:health] == :off_track ? '#ef4444' : '#f59e0b') %>
              <stop offset="<%= offset %>%" stop-color="<%= color %>" />
            <% end %>
          </linearGradient>
        </defs>
        <%
          points = trend_data.each_with_index.map do |point, i|
            x = (i.to_f / [trend_data.length - 1, 1].max * 180) + 10
            y = 45 - ((point[:score] + 1) / 2.0 * 40)
            [x, y]
          end
          points_str = points.map { |p| "#{p[0].round(1)},#{p[1].round(1)}" }.join(' ')
        %>
        <polyline class="trend-line-v2" stroke="url(#project-trend-gradient)" points="<%= points_str %>" />
        <% points.each_with_index do |p, i| %>
          <% pt_health = trend_data[i][:health] %>
          <circle cx="<%= p[0].round(1) %>" cy="<%= p[1].round(1) %>" r="4" class="trend-point-v2 trend-point-v2--<%= pt_health %>" />
        <% end %>
      </svg>
    <% elsif weeks_of_data == 1 %>
      <div class="metric-widget__no-data">1 week of data</div>
    <% else %>
      <div class="metric-widget__no-data">Insufficient data</div>
    <% end %>
  </div>
</div>
