<nav class="breadcrumbs" aria-label="Breadcrumb">
  <ol>
    <% ref_crumb = breadcrumb_from_ref(params[:ref]) %>
    <% if ref_crumb %>
      <li><%= link_to ref_crumb[:name], ref_crumb[:path] %></li>
    <% else %>
      <li><%= link_to 'Initiatives', initiatives_path %></li>
    <% end %>
    <li aria-current="page"><%= @initiative_record.name %></li>
  </ol>
</nav>

<div class="initiative-dashboard-v2">
  <!-- Initiative Header -->
  <div class="initiative-header-v2">
    <div class="initiative-name-v2"><%= @initiative_record.name %></div>
    <div class="initiative-meta-v2">
        <% allowed_states = SetInitiativeState::SETTABLE_STATES %>
        <% cascading_states = Initiative::CASCADING_STATES %>
        <% related_project_count = @initiative_record.related_projects.count %>
        <div class="state-dropdown"
             data-state-url="<%= state_initiative_path(@initiative_record) %>"
             data-initiative-state-dropdown
             data-related-project-count="<%= related_project_count %>">
          <button class="state-toggle" type="button">
          <span class="badge state state--<%= @initiative_record.current_state.to_s.tr('_', '-') %>"><%= @initiative_record.current_state.to_s.tr('_', ' ').upcase %></span>
          </button>
          <div class="state-menu">
            <% if allowed_states.any? %>
              <% allowed_states.each do |state| %>
                <button type="button"
                        data-state="<%= state %>"
                        data-cascades="<%= cascading_states.include?(state) %>"><%= state.to_s.tr('_', ' ').titleize %></button>
              <% end %>
            <% else %>
              <div class="empty">No further transitions</div>
            <% end %>
          </div>
        </div>
      <% total_leaf_projects = @initiative&.leaf_projects&.size || 0 %>
      <span class="initiative-project-count"><%= @total_active_projects %> active / <%= total_leaf_projects %> projects</span>
          <% if @initiative_record.archived %>
            <span class="badge archived">archived</span>
          <% end %>
        </div>
  </div>

  <!-- Metrics Row: Health | Trend | Confidence -->
  <% initiative_health = @initiative&.health || :not_available %>
  <% health_class = initiative_health.to_s.tr('_', '-') %>
  <% raw_score = @initiative&.health_raw_score %>
  <% raw_score_display = raw_score ? raw_score.round(2) : 'N/A' %>

  <div class="metrics-row-v2">
    <!-- Health Widget -->
    <%
      # Determine most urgent action
      blocked_projects = @attention_required.select { |p| p.current_state == :blocked }
      off_track_projects = @attention_required.select { |p| p.health == :off_track && p.current_state != :blocked }

      urgent_action = if blocked_projects.any?
        { type: :blocked, count: blocked_projects.size, text: "#{blocked_projects.size} blocked #{'project'.pluralize(blocked_projects.size)}", tab: 'attention' }
      elsif off_track_projects.any?
        { type: :off_track, count: off_track_projects.size, text: "#{off_track_projects.size} off-track #{'project'.pluralize(off_track_projects.size)}", tab: 'attention' }
      elsif @stale_projects_14.any?
        { type: :stale, count: @stale_projects_14.size, text: "#{@stale_projects_14.size} stale #{'project'.pluralize(@stale_projects_14.size)}", tab: 'update' }
      elsif @stale_projects_7.any?
        { type: :warning, count: @stale_projects_7.size, text: "#{@stale_projects_7.size} stale #{'project'.pluralize(@stale_projects_7.size)}", tab: 'update' }
      elsif @never_updated_projects.any?
        { type: :warning, count: @never_updated_projects.size, text: "#{@never_updated_projects.size} #{'project'.pluralize(@never_updated_projects.size)} never updated", tab: 'update' }
      else
        nil
      end
    %>
    <div class="metric-widget metric-widget--health metric-widget--<%= health_class %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Current Health</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
          <div class="widget-info__tooltip">
            <div class="widget-info__methodology">Weighted average of leaf project health scores. On Track = +1, At Risk = 0, Off Track = −1.</div>
            <div class="widget-info__range">Range: −1.0 to +1.0</div>
            <div class="widget-info__score">Score: <%= raw_score_display %></div>
      </div>
    </div>
  </div>
      <div class="metric-widget__content">
        <span class="metric-widget__dot metric-widget__dot--<%= health_class %>"></span>
        <div class="metric-widget__text">
          <div class="metric-widget__label metric-widget__label--<%= health_class %>"><%= initiative_health.to_s.tr('_', ' ').titleize %></div>
          <% if urgent_action %>
            <button type="button" class="metric-widget__urgent metric-widget__urgent--<%= urgent_action[:type] %>" data-open-tab="<%= urgent_action[:tab] %>">
              <%= urgent_action[:text] %>
                </button>
              <% end %>
        </div>
      </div>
    </div>

    <!-- Trend Widget -->
    <% trend_class = @weeks_of_data >= 2 ? "trend-#{@trend_direction}" : 'trend-insufficient' %>
    <div class="metric-widget metric-widget--trend metric-widget--<%= trend_class %>">
      <div class="metric-widget__header">
        <span class="metric-widget__title">6-Week Trend</span>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="widget-info">
            <span class="widget-info__icon">i</span>
            <div class="widget-info__tooltip">
              <div class="widget-info__methodology">Weekly average health scores over the past 6 weeks. Direction based on change from oldest to newest data point.</div>
              <div class="widget-info__range">Range: −1.0 to +1.0 per week</div>
              <div class="widget-info__score">Delta: <%= @trend_delta >= 0 ? '+' : '' %><%= @trend_delta.round(2) %> (<%= @weeks_of_data %> weeks)</div>
            </div>
          </div>
        </div>
      </div>
      <div class="metric-widget__chart">
        <% if @weeks_of_data >= 2 %>
          <svg viewBox="0 0 200 50" preserveAspectRatio="none" class="trend-svg">
            <defs>
              <linearGradient id="trend-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <% @trend_data.each_with_index do |point, i| %>
                  <% offset = (i.to_f / [@trend_data.length - 1, 1].max * 100).round %>
                  <% color = point[:health] == :on_track ? '#22c55e' : (point[:health] == :off_track ? '#ef4444' : '#f59e0b') %>
                  <stop offset="<%= offset %>%" stop-color="<%= color %>" />
                <% end %>
              </linearGradient>
            </defs>
            <%
              # Calculate points for the trend line
              points = @trend_data.each_with_index.map do |point, i|
                x = (i.to_f / [@trend_data.length - 1, 1].max * 180) + 10
                # Score ranges from -1 to 1, map to y 45 to 5
                y = 45 - ((point[:score] + 1) / 2.0 * 40)
                [x, y]
              end
              points_str = points.map { |p| "#{p[0].round(1)},#{p[1].round(1)}" }.join(' ')
              first_point = points.first
              last_point = points.last
            %>
            <line class="trend-line-dotted"
                  x1="<%= first_point[0].round(1) %>" y1="<%= first_point[1].round(1) %>"
                  x2="<%= last_point[0].round(1) %>" y2="<%= last_point[1].round(1) %>" />
            <polyline class="trend-line-v2" stroke="url(#trend-gradient)" points="<%= points_str %>" />
            <% points.each_with_index do |p, i| %>
              <% health = @trend_data[i][:health] %>
              <circle cx="<%= p[0].round(1) %>" cy="<%= p[1].round(1) %>" r="4" class="trend-point-v2 trend-point-v2--<%= health %>" />
            <% end %>
          </svg>
        <% elsif @weeks_of_data == 1 %>
          <div class="metric-widget__no-data">1 week of data</div>
        <% else %>
          <div class="metric-widget__no-data">Insufficient data</div>
        <% end %>
      </div>
    </div>

    <!-- Confidence Widget -->
    <%
      confidence_cta = case @confidence_factors[:biggest_drag]
      when :variance
        { text: "Volatile health trend", tab: nil, type: :info }
      when :staleness
        days = @confidence_factors.dig(:details, :days_since_update)
        { text: "Data is #{days}+ days old", tab: 'update', type: :warning }
      when :coverage
        count = @confidence_factors.dig(:details, :projects_needing_update) || 0
        { text: "#{count} #{'project'.pluralize(count)} need updates", tab: 'update', type: :warning }
      when :insufficient_data
        { text: "Building history...", tab: nil, type: :info }
      else
        nil
      end
    %>
    <div class="metric-widget metric-widget--confidence metric-widget--confidence-<%= @confidence_level %>">
      <div class="metric-widget__title-row">
        <span class="metric-widget__title">Confidence</span>
        <div class="widget-info">
          <span class="widget-info__icon">i</span>
          <div class="widget-info__tooltip">
            <div class="widget-info__methodology">Based on trend consistency, data freshness, and project coverage. Lower variance and recent updates increase confidence.</div>
            <div class="widget-info__range">Range: 0–100 (High ≥70, Medium ≥40, Low &lt;40)</div>
            <div class="widget-info__score">Score: <%= @confidence_score %></div>
          </div>
        </div>
      </div>
      <div class="metric-widget__content">
        <div class="confidence-ring">
          <svg viewBox="0 0 44 44">
            <circle class="confidence-ring__bg" cx="22" cy="22" r="18" />
            <% circumference = 2 * Math::PI * 18 %>
            <% offset = circumference - (@confidence_score / 100.0 * circumference) %>
            <circle class="confidence-ring__fill confidence-ring__fill--<%= @confidence_level %>"
                    cx="22" cy="22" r="18"
                    stroke-dasharray="<%= circumference.round(1) %>"
                    stroke-dashoffset="<%= offset.round(1) %>" />
          </svg>
        </div>
        <div class="metric-widget__text">
          <div class="metric-widget__label confidence-label--<%= @confidence_level %>"><%= @confidence_level.to_s.titleize %></div>
          <% if confidence_cta && @confidence_level != :high %>
            <% if confidence_cta[:tab] %>
              <button type="button" class="metric-widget__urgent metric-widget__urgent--<%= confidence_cta[:type] %>" data-open-tab="<%= confidence_cta[:tab] %>">
                <%= confidence_cta[:text] %>
              </button>
            <% else %>
              <span class="metric-widget__hint"><%= confidence_cta[:text] %></span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <% if defined?(@errors) && @errors.present? %>
    <div class="errors">
      <ul>
        <% @errors.each do |err| %>
          <li><%= err %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Tabs -->
  <%
    inactive_projects = @initiative&.leaf_projects&.reject { |p| [:in_progress, :blocked].include?(p.current_state) } || []
  %>
  <div class="dashboard-tabs-v2">
    <button class="dashboard-tab-v2" data-tab="attention">
      Unhealthy <span class="dashboard-tab-v2__count"><%= @attention_required.size + @on_hold_projects.size %></span>
    </button>
    <button class="dashboard-tab-v2" data-tab="update">
      Stale <span class="dashboard-tab-v2__count"><%= @never_updated_projects.size + @stale_projects_14.size + @stale_projects_7.size %></span>
    </button>
    <button class="dashboard-tab-v2" data-tab="projects">
      Active <span class="dashboard-tab-v2__count"><%= @total_active_projects %></span>
    </button>
    <button class="dashboard-tab-v2" data-tab="inactive">
      Inactive <span class="dashboard-tab-v2__count"><%= inactive_projects.size %></span>
    </button>
    <button class="dashboard-tab-v2" data-tab="manage">
      Settings
          </button>
  </div>

  <!-- Tab Content: Needs Attention -->
  <div class="tab-content-v2" data-tab-content="attention">
    <% if @attention_required.empty? && @on_hold_projects.empty? %>
      <div class="tab-empty-v2">Everything is on track!</div>
    <% else %>
      <% if @attention_required.any? %>
        <div class="tab-section-v2">
          <h4 class="tab-section-v2__title"><%= @attention_required.size %> Unhealthy <%= 'Project'.pluralize(@attention_required.size) %></h4>
          <ul class="project-list-v2">
            <% @attention_required.each do |project| %>
              <li class="project-item-v2">
                <a href="<%= project_path(ProjectRecord.find_by(name: project.name), ref: "initiative:#{@initiative_record.id}") %>" class="project-item-v2__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= project.health %>"></span>
                  <span class="project-item-v2__name"><%= project.name %></span>
                  <% if project.current_state == :blocked %>
                    <span class="project-item-v2__tag project-item-v2__tag--blocked">Blocked</span>
                  <% end %>
                </a>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <% if @on_hold_projects.any? %>
        <div class="tab-section-v2">
          <h4 class="tab-section-v2__title"><%= @on_hold_projects.size %> On Hold</h4>
          <ul class="project-list-v2">
            <% @on_hold_projects.each do |project| %>
              <li class="project-item-v2">
                <a href="<%= project_path(ProjectRecord.find_by(name: project.name), ref: "initiative:#{@initiative_record.id}") %>" class="project-item-v2__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= project.health %>"></span>
                  <span class="project-item-v2__name"><%= project.name %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- Tab Content: Needs Update -->
  <div class="tab-content-v2" data-tab-content="update">
    <% if @never_updated_projects.empty? && @stale_projects_14.empty? && @stale_projects_7.empty? %>
      <div class="tab-empty-v2">Everything is up to date!</div>
    <% else %>
      <% if @never_updated_projects.any? %>
        <div class="tab-section-v2">
          <h4 class="tab-section-v2__title"><%= @never_updated_projects.size %> Never Updated</h4>
          <ul class="project-list-v2">
            <% @never_updated_projects.each do |project| %>
              <li class="project-item-v2">
                <a href="<%= project_path(ProjectRecord.find_by(name: project.name), ref: "initiative:#{@initiative_record.id}") %>" class="project-item-v2__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= project.health %>"></span>
                  <span class="project-item-v2__name"><%= project.name %></span>
                  <span class="project-item-v2__tag project-item-v2__tag--stale">Stale</span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <% if @stale_projects_14.any? %>
        <div class="tab-section-v2">
          <h4 class="tab-section-v2__title"><%= @stale_projects_14.size %> Not Updated in 14+ Days</h4>
          <ul class="project-list-v2">
            <% @stale_projects_14.each do |project| %>
              <li class="project-item-v2">
                <a href="<%= project_path(ProjectRecord.find_by(name: project.name), ref: "initiative:#{@initiative_record.id}") %>" class="project-item-v2__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= project.health %>"></span>
                  <span class="project-item-v2__name"><%= project.name %></span>
                  <span class="project-item-v2__tag project-item-v2__tag--stale">Stale</span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <% if @stale_projects_7.any? %>
        <div class="tab-section-v2">
          <h4 class="tab-section-v2__title"><%= @stale_projects_7.size %> Not Updated in 7+ Days</h4>
          <ul class="project-list-v2">
            <% @stale_projects_7.each do |project| %>
              <li class="project-item-v2">
                <a href="<%= project_path(ProjectRecord.find_by(name: project.name), ref: "initiative:#{@initiative_record.id}") %>" class="project-item-v2__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= project.health %>"></span>
                  <span class="project-item-v2__name"><%= project.name %></span>
                  <span class="project-item-v2__tag project-item-v2__tag--stale">Stale</span>
                </a>
              </li>
            <% end %>
          </ul>
    </div>
      <% end %>
    <% end %>
  </div>

  <!-- Tab Content: Active Projects -->
  <div class="tab-content-v2" data-tab-content="projects">
    <%
      active_projects = @initiative&.leaf_projects&.select { |p| [:in_progress, :blocked].include?(p.current_state) } || []
      stale_project_names = (@stale_projects_14 + @stale_projects_7 + @never_updated_projects).map(&:name)
    %>
    <% if active_projects.empty? %>
      <div class="tab-empty-v2">No active projects</div>
    <% else %>
      <div class="tab-section-v2">
        <h4 class="tab-section-v2__title"><%= active_projects.size %> Active <%= 'Project'.pluralize(active_projects.size) %></h4>
        <ul class="project-list-v2">
          <% active_projects.sort_by { |p| [p.health == :on_track ? 2 : (p.health == :at_risk ? 1 : 0), p.name] }.each do |project| %>
            <li class="project-item-v2">
              <a href="<%= project_path(ProjectRecord.find_by(name: project.name), ref: "initiative:#{@initiative_record.id}") %>" class="project-item-v2__link">
                <span class="project-item-v2__health project-item-v2__health--<%= project.health %>"></span>
                <span class="project-item-v2__name"><%= project.name %></span>
                <% if project.current_state == :blocked %>
                  <span class="project-item-v2__tag project-item-v2__tag--blocked">Blocked</span>
                <% elsif stale_project_names.include?(project.name) %>
                  <span class="project-item-v2__tag project-item-v2__tag--stale">Stale</span>
                <% end %>
              </a>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </div>

  <!-- Tab Content: Inactive Projects -->
  <div class="tab-content-v2" data-tab-content="inactive">
    <%
      state_order = { new: 0, todo: 1, on_hold: 2, done: 3 }
      sorted_inactive = inactive_projects.sort_by { |p| [state_order[p.current_state] || 99, p.name] }
    %>
    <% if inactive_projects.empty? %>
      <div class="tab-empty-v2">No inactive projects</div>
    <% else %>
      <div class="tab-section-v2">
        <h4 class="tab-section-v2__title"><%= inactive_projects.size %> Inactive <%= 'Project'.pluralize(inactive_projects.size) %></h4>
        <ul class="project-list-v2">
          <% sorted_inactive.each do |project| %>
            <li class="project-item-v2">
              <a href="<%= project_path(ProjectRecord.find_by(name: project.name), ref: "initiative:#{@initiative_record.id}") %>" class="project-item-v2__link">
                <span class="project-item-v2__health project-item-v2__health--<%= project.health || :not_available %>"></span>
                <span class="project-item-v2__name"><%= project.name %></span>
                <span class="project-item-v2__tag project-item-v2__tag--inactive"><%= project.current_state.to_s.tr('_', ' ').titleize %></span>
              </a>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </div>

  <!-- Tab Content: Settings -->
  <div class="tab-content-v2" data-tab-content="manage">
    <!-- Initiative Details -->
    <div class="manage-section-v2">
      <h4 class="manage-section-v2__title">Initiative Details</h4>
      <div class="settings-fields">
        <div class="editable-field settings-field__value<%= ' editable-field--empty' if @initiative_record.name.blank? %>"
             contenteditable="true"
             data-field="name"
             data-hint="Initiative name"
             data-update-url="<%= initiative_path(@initiative_record) %>"><%= @initiative_record.name.presence || 'Initiative name' %></div>
        <div class="editable-field settings-field__value<%= ' editable-field--empty' if @initiative_record.description.blank? %>"
             contenteditable="true"
             data-field="description"
             data-hint="Description"
             data-update-url="<%= initiative_path(@initiative_record) %>"><%= @initiative_record.description.presence || 'Description' %></div>
        <div class="editable-field settings-field__value<%= ' editable-field--empty' if @initiative_record.point_of_contact.blank? %>"
             contenteditable="true"
             data-field="point_of_contact"
             data-hint="Contact"
             data-update-url="<%= initiative_path(@initiative_record) %>"><%= @initiative_record.point_of_contact.presence || 'Contact' %></div>
      </div>
    </div>

    <!-- Add/Link Project -->
    <div class="manage-section-v2">
      <h4 class="manage-section-v2__title">Add Project</h4>
      <%
        # Only show top-level projects (projects without a parent)
        top_level_project_ids = ProjectRecord.left_joins(:parent_relationship).where(projects_projects: { id: nil }).pluck(:id)
        available_projects = ProjectRecord.where(archived: false, id: top_level_project_ids).where.not(id: @initiative_record.related_projects.pluck(:id)).order(:name)
      %>
        <form action="<%= related_projects_initiative_path(@initiative_record) %>"
              method="post"
            class="add-project-form-v2"
              data-add-link-form
              data-add-url="<%= add_related_project_initiative_path(@initiative_record) %>"
              data-link-url="<%= related_projects_initiative_path(@initiative_record) %>">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <input type="hidden" name="project[name]" value="" data-project-name-field />
          <input type="hidden" name="project_id" value="" data-child-id-field />
        <div class="add-project-form-v2__row">
            <div class="project-dropdown" data-project-dropdown>
              <div class="project-dropdown__input-wrapper">
                <input type="text"
                       class="project-dropdown__input"
                       placeholder="Add or link a project..."
                       data-project-dropdown-input
                       autocomplete="off" />
                <% if available_projects.any? %>
                  <span class="project-dropdown__arrow">▼</span>
                <% end %>
              </div>
              <% if available_projects.any? %>
                <div class="project-dropdown__menu" data-project-dropdown-menu>
                  <div class="project-dropdown__options" data-project-options>
                    <% available_projects.each do |project| %>
                      <button type="button"
                              class="project-dropdown__option"
                              data-project-id="<%= project.id %>"
                              data-project-name="<%= project.name %>"
                              data-project-search-text="<%= project.name.downcase %>">
                        <span class="project-dropdown__option-name"><%= project.name %></span>
                        <% if project.description.present? %>
                          <span class="project-dropdown__option-desc"><%= truncate(project.description, length: 50) %></span>
                        <% end %>
                      </button>
                    <% end %>
                  </div>
                  <div class="project-dropdown__no-results" data-no-results hidden>
                    No matches — press Add to create
                  </div>
                </div>
              <% end %>
            </div>
            <button type="submit" class="btn secondary" data-add-link-submit disabled>Add</button>
          </div>
        </form>
    </div>

    <!-- Linked Projects List -->
    <% linked_projects = @initiative_record.related_projects.order(:name) %>
    <% if linked_projects.any? %>
      <div class="manage-section-v2">
        <h4 class="manage-section-v2__title"><%= linked_projects.size %> Linked <%= 'Project'.pluralize(linked_projects.size) %></h4>
        <ul class="project-list-v2">
          <% project_repo = Rails.application.config.x.project_repository %>
          <% linked_projects.each do |project_record| %>
            <% domain_project = project_repo.find(project_record.id) %>
            <% project_health = domain_project&.health || :not_available %>
            <li class="project-item-v2">
              <div class="project-item-v2__link-wrapper">
                <a href="<%= project_path(project_record, ref: "initiative:#{@initiative_record.id}") %>" class="project-item-v2__link">
                  <span class="project-item-v2__health project-item-v2__health--<%= project_health %>"></span>
                  <span class="project-item-v2__name"><%= project_record.name %></span>
                </a>
                <button type="button"
                        class="project-item-v2__unlink"
                        data-unlink-url="/initiatives/<%= @initiative_record.id %>/related_projects/<%= project_record.id %>"
                        data-project-name="<%= project_record.name %>"
                        aria-label="Unlink <%= project_record.name %>"
                        title="Unlink project">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 7h3a5 5 0 0 1 0 10h-3m-6 0H6a5 5 0 0 1 0-10h3"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                    <line x1="4" y1="4" x2="20" y2="20" stroke-width="2.5"/>
                  </svg>
                </button>
              </div>
      </li>
          <% end %>
    </ul>
      </div>
    <% end %>
  </div>
</div>

<div class="modal-overlay" data-cascade-modal hidden>
  <div class="modal">
    <div class="modal__header">
      <h3>Update State</h3>
    </div>
    <div class="modal__body">
      <p>Set initiative to <strong data-cascade-state-name></strong>?</p>
      <p>This will also update <strong data-cascade-project-count></strong> related project(s) to the same state.</p>
    </div>
    <div class="modal__actions">
      <button type="button" class="btn secondary" data-cascade-cancel>Cancel</button>
      <button type="button" class="btn secondary" data-cascade-skip>Initiative Only</button>
      <button type="button" class="btn primary" data-cascade-confirm>Update All</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = document.querySelector('meta[name="csrf-token"]')?.content;

    // Editable fields
    document.querySelectorAll('.editable-field').forEach((el) => {
      const hint = el.dataset.hint;
      let original = el.innerText;
      let isShowingHint = el.classList.contains('editable-field--empty');

      el.addEventListener('focus', () => {
        if (isShowingHint && hint) {
          el.innerText = '';
          el.classList.remove('editable-field--empty');
          isShowingHint = false;
        }
      });

      el.addEventListener('blur', () => {
        const value = el.innerText.trim();

        if (!value && hint) {
          el.innerText = hint;
          el.classList.add('editable-field--empty');
          isShowingHint = true;
        }

        const saveValue = isShowingHint ? '' : value;
        const originalValue = original === hint ? '' : original;

        if (saveValue === originalValue) return;

        const field = el.dataset.field;
        const url = el.dataset.updateUrl;
        fetch(url, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ initiative: { [field]: saveValue } })
        }).then((resp) => {
          if (resp.ok) { original = isShowingHint ? hint : value; }
        }).catch((err) => console.error(err));
      });
    });

    // Tab toggle behavior
    const tabs = document.querySelectorAll('.dashboard-tab-v2');
    const tabContents = document.querySelectorAll('.tab-content-v2');

    function openTab(tabName) {
      const tab = document.querySelector(`.dashboard-tab-v2[data-tab="${tabName}"]`);
      const content = document.querySelector(`[data-tab-content="${tabName}"]`);

      // Close all tabs
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));

      // Open the requested tab
      tab?.classList.add('active');
      content?.classList.add('active');
    }

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        const isActive = tab.classList.contains('active');

        if (isActive) {
          // Close if already active
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
        } else {
          openTab(tabName);
        }
      });
    });

    // Urgent action badge click opens tab
    document.querySelectorAll('[data-open-tab]').forEach((btn) => {
      btn.addEventListener('click', () => {
        openTab(btn.dataset.openTab);
      });
    });

    // Add/Link form handling
    const addLinkForm = document.querySelector('[data-add-link-form]');
    if (addLinkForm) {
      const input = addLinkForm.querySelector('[data-project-dropdown-input]');
      const nameField = addLinkForm.querySelector('[data-project-name-field]');
      const idField = addLinkForm.querySelector('[data-child-id-field]');
      const submitBtn = addLinkForm.querySelector('[data-add-link-submit]');
      const addUrl = addLinkForm.dataset.addUrl;
      const linkUrl = addLinkForm.dataset.linkUrl;

      const updateSubmitState = () => {
        const hasInput = input.value.trim().length > 0;
        submitBtn.disabled = !hasInput;
      };

      input?.addEventListener('input', updateSubmitState);

      addLinkForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const selectedId = idField.value;
        const inputValue = input.value.trim();

        if (selectedId) {
          addLinkForm.action = linkUrl;
          idField.name = 'project_id';
          idField.value = selectedId;
        } else if (inputValue) {
          addLinkForm.action = addUrl;
          nameField.value = inputValue;
        } else {
          return;
        }

        addLinkForm.submit();
      });
    }

    // Project dropdown with inline search
    const projectDropdown = document.querySelector('[data-project-dropdown]');
    if (projectDropdown) {
      const input = projectDropdown.querySelector('[data-project-dropdown-input]');
      const menu = projectDropdown.querySelector('[data-project-dropdown-menu]');
      const optionsContainer = projectDropdown.querySelector('[data-project-options]');
      const noResults = projectDropdown.querySelector('[data-no-results]');
      const idField = document.querySelector('[data-child-id-field]');
      let selectedProjectName = '';

      const closeMenu = () => {
        menu?.classList.remove('open');
        filterOptions('');
        if (selectedProjectName) {
          input.value = selectedProjectName;
        }
      };

      const openMenu = () => {
        menu?.classList.add('open');
        if (selectedProjectName && input.value === selectedProjectName) {
          input.value = '';
        }
      };

      const filterOptions = (query) => {
        const lowerQuery = query.toLowerCase();
        let visibleCount = 0;

        optionsContainer?.querySelectorAll('.project-dropdown__option').forEach((option) => {
          const searchText = option.dataset.projectSearchText || '';
          const matches = searchText.includes(lowerQuery);
          option.style.display = matches ? '' : 'none';
          if (matches) visibleCount++;
        });

        if (noResults) {
          noResults.hidden = visibleCount > 0;
        }
      };

      input?.addEventListener('focus', openMenu);

      input?.addEventListener('input', (e) => {
        if (idField) idField.value = '';
        selectedProjectName = '';

        if (!menu?.classList.contains('open')) {
          openMenu();
        }
        filterOptions(e.target.value);
      });

      input?.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeMenu();
          input?.blur();
        }
      });

      optionsContainer?.querySelectorAll('.project-dropdown__option').forEach((optionBtn) => {
        optionBtn.addEventListener('click', () => {
          const projectId = optionBtn.dataset.projectId;
          const projectName = optionBtn.dataset.projectName;

          if (idField) idField.value = projectId;
          selectedProjectName = projectName;
          input.value = projectName;
          input.classList.add('project-dropdown__input--selected');
          closeMenu();

          const submitBtn = document.querySelector('[data-add-link-submit]');
          if (submitBtn) submitBtn.disabled = false;
        });
      });

      document.addEventListener('click', (e) => {
        if (!projectDropdown.contains(e.target)) {
          closeMenu();
        }
      });
    }

    // State dropdown with cascade confirmation
    const stateDropdown = document.querySelector('[data-initiative-state-dropdown]');
    if (stateDropdown) {
      const stateUrl = stateDropdown.dataset.stateUrl;
      const relatedProjectCount = parseInt(stateDropdown.dataset.relatedProjectCount, 10) || 0;
      const stateToggle = stateDropdown.querySelector('.state-toggle');
      const stateMenu = stateDropdown.querySelector('.state-menu');
      const stateButtons = stateDropdown.querySelectorAll('[data-state]');

      const cascadeModal = document.querySelector('[data-cascade-modal]');
      const cascadeStateName = document.querySelector('[data-cascade-state-name]');
      const cascadeProjectCount = document.querySelector('[data-cascade-project-count]');
      const cascadeConfirmBtn = document.querySelector('[data-cascade-confirm]');
      const cascadeSkipBtn = document.querySelector('[data-cascade-skip]');
      const cascadeCancelBtn = document.querySelector('[data-cascade-cancel]');
      let pendingState = null;

      const showCascadeModal = (state, stateName) => {
        pendingState = state;
        cascadeStateName.textContent = stateName;
        cascadeProjectCount.textContent = relatedProjectCount;
        cascadeModal.hidden = false;
        cascadeConfirmBtn?.focus();
      };

      const hideCascadeModal = () => {
        cascadeModal.hidden = true;
        pendingState = null;
      };

      const updateState = (state, cascade) => {
        const url = new URL(stateUrl, window.location.origin);
        url.searchParams.set('state', state);
        if (cascade) {
          url.searchParams.set('cascade', 'true');
        }

        fetch(url.toString(), {
          method: 'PATCH',
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': token
          }
        }).then((resp) => {
          if (resp.ok) {
            window.location.reload();
          }
        }).catch((err) => console.error(err));
      };

      stateToggle?.addEventListener('click', () => {
        stateMenu.classList.toggle('open');
      });

      stateButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const state = btn.dataset.state;
          const cascades = btn.dataset.cascades === 'true';
          const stateName = btn.textContent.trim();
          stateMenu.classList.remove('open');

          if (cascades && relatedProjectCount > 0) {
            showCascadeModal(state, stateName);
          } else {
            updateState(state, false);
          }
        });
      });

      cascadeConfirmBtn?.addEventListener('click', () => {
        if (pendingState) {
          const stateToUpdate = pendingState;
          hideCascadeModal();
          updateState(stateToUpdate, true);
        }
      });

      cascadeSkipBtn?.addEventListener('click', () => {
        if (pendingState) {
          const stateToUpdate = pendingState;
          hideCascadeModal();
          updateState(stateToUpdate, false);
        }
      });

      cascadeCancelBtn?.addEventListener('click', hideCascadeModal);

      cascadeModal?.addEventListener('click', (e) => {
        if (e.target === cascadeModal) hideCascadeModal();
      });

      document.addEventListener('click', (e) => {
        if (!stateDropdown.contains(e.target)) {
          stateMenu.classList.remove('open');
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          stateMenu.classList.remove('open');
          if (!cascadeModal?.hidden) {
            hideCascadeModal();
          }
        }
      });
    }

    // Unlink project handler
    document.querySelectorAll('[data-unlink-url]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const url = btn.dataset.unlinkUrl;
        const projectName = btn.dataset.projectName;

        if (confirm(`Unlink "${projectName}" from this initiative?`)) {
          fetch(url, {
            method: 'DELETE',
            headers: {
              'Accept': 'application/json',
              'X-CSRF-Token': token
            }
          }).then((resp) => {
            if (resp.ok) {
              window.location.reload();
            }
          }).catch((err) => console.error(err));
        }
      });
    });
  });
</script>
