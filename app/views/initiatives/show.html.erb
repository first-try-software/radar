<nav class="breadcrumbs" aria-label="Breadcrumb">
  <ol>
    <li><%= link_to 'Initiatives', initiatives_path %></li>
    <li aria-current="page"><%= @initiative_record.name %></li>
  </ol>
</nav>

<div class="grid">
  <div class="card">
    <div class="project-header">
      <div class="health-toggle-placeholder">
        <div class="project-header__health">
          <%= initiative_health_indicator(@initiative || @initiative_record, with_tooltip: true) %>
        </div>
      </div>
      <div class="project-header__text">
        <div class="editable-field project-name"
             contenteditable="true"
             data-field="name"
             data-update-url="<%= initiative_path(@initiative_record) %>"><%= @initiative_record.name %></div>

        <div class="editable-field project-description<%= ' editable-field--empty' if @initiative_record.description.blank? %>"
             contenteditable="true"
             data-field="description"
             data-hint="What is this initiative about?"
             data-update-url="<%= initiative_path(@initiative_record) %>"><%= @initiative_record.description.presence || 'What is this initiative about?' %></div>

        <div class="editable-field project-poc<%= ' editable-field--empty' if @initiative_record.point_of_contact.blank? %>"
             contenteditable="true"
             data-field="point_of_contact"
             data-hint="Where can I get more information (person, email, slack channel, etc.)?"
             data-update-url="<%= initiative_path(@initiative_record) %>"><%= @initiative_record.point_of_contact.presence || 'Where can I get more information (person, email, slack channel, etc.)?' %></div>

        <% if defined?(@errors) && @errors.present? %>
          <div class="errors">
            <ul>
              <% @errors.each do |err| %>
                <li><%= err %></li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
      <div class="project-header__state">
        <div class="badges">
          <% if @initiative_record.archived %>
            <span class="badge archived">archived</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 class="section-title children-title">Related Projects</h3>
    <ul class="list children-list" data-related-projects-list>
      <% related_projects = @initiative_record.related_project_relationships.includes(:project).order(:order).map(&:project) %>
      <%= render partial: 'initiatives/related_project_item', collection: related_projects, as: :project, locals: { initiative: @initiative_record } %>
      <% if related_projects.empty? %>
        <li class="list-item" data-empty-message><span class="muted">No related projects yet.</span></li>
      <% end %>
      <% available_projects = ProjectRecord.where.not(id: related_projects.map(&:id)).order(:name) %>
      <% if available_projects.any? %>
        <li class="list-item">
          <%= form_with url: related_projects_initiative_path(@initiative_record),
                        method: :post,
                        local: true,
                        html: { class: 'child-form', data: { project_link_form: true } } do |form| %>
            <div class="child-actions">
              <div class="project-dropdown" data-project-dropdown>
                <%= form.hidden_field :project_id, value: '', data: { project_dropdown_value: true } %>
                <div class="project-dropdown__input-wrapper">
                  <input type="text"
                         class="project-dropdown__input"
                         placeholder="Select a project..."
                         data-project-dropdown-input
                         autocomplete="off" />
                  <span class="project-dropdown__arrow">â–¼</span>
                </div>
                <div class="project-dropdown__menu" data-project-dropdown-menu>
                  <div class="project-dropdown__options" data-project-options>
                    <% available_projects.each do |project| %>
                      <button type="button"
                              class="project-dropdown__option"
                              data-project-id="<%= project.id %>"
                              data-project-name="<%= project.name %>"
                              data-project-search-text="<%= project.name.downcase %>">
                        <span class="project-dropdown__option-name"><%= project.name %></span>
                        <% if project.description.present? %>
                          <span class="project-dropdown__option-desc"><%= truncate(project.description, length: 50) %></span>
                        <% end %>
                      </button>
                    <% end %>
                  </div>
                  <div class="project-dropdown__no-results" data-no-results hidden>
                    No matching projects
                  </div>
                </div>
              </div>
              <%= form.submit 'Link', class: 'btn secondary', data: { project_link_submit: true } %>
            </div>
          <% end %>
        </li>
      <% end %>
    </ul>
  </div>
</div>

<div class="modal-overlay" data-unlink-modal hidden>
  <div class="modal">
    <div class="modal__header">
      <h3>Unlink Project</h3>
    </div>
    <div class="modal__body">
      <p>Remove <strong data-unlink-project-name></strong> from this initiative?</p>
      <p>The project itself will not be deleted.</p>
    </div>
    <div class="modal__actions">
      <button type="button" class="btn secondary" data-unlink-cancel>Cancel</button>
      <button type="button" class="btn danger" data-unlink-confirm>Unlink</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = document.querySelector('meta[name="csrf-token"]')?.content;

    document.querySelectorAll('.editable-field').forEach((el) => {
      const hint = el.dataset.hint;
      let original = el.innerText;
      let isShowingHint = el.classList.contains('editable-field--empty');

      el.addEventListener('focus', () => {
        if (isShowingHint && hint) {
          el.innerText = '';
          el.classList.remove('editable-field--empty');
          isShowingHint = false;
        }
      });

      el.addEventListener('blur', () => {
        const value = el.innerText.trim();

        if (!value && hint) {
          el.innerText = hint;
          el.classList.add('editable-field--empty');
          isShowingHint = true;
        }

        const saveValue = isShowingHint ? '' : value;
        const originalValue = original === hint ? '' : original;

        if (saveValue === originalValue) return;

        const field = el.dataset.field;
        const url = el.dataset.updateUrl;
        fetch(url, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ initiative: { [field]: saveValue } })
        }).then((resp) => {
          if (resp.ok) { original = isShowingHint ? hint : value; }
        }).catch((err) => console.error(err));
      });
    });

    // Project dropdown with inline search
    const projectDropdown = document.querySelector('[data-project-dropdown]');
    if (projectDropdown) {
      const input = projectDropdown.querySelector('[data-project-dropdown-input]');
      const menu = projectDropdown.querySelector('[data-project-dropdown-menu]');
      const hiddenInput = projectDropdown.querySelector('[data-project-dropdown-value]');
      const optionsContainer = projectDropdown.querySelector('[data-project-options]');
      const noResults = projectDropdown.querySelector('[data-no-results]');
      let selectedProjectName = '';

      const closeMenu = () => {
        menu?.classList.remove('open');
        filterOptions('');
        if (selectedProjectName) {
          input.value = selectedProjectName;
        }
      };

      const openMenu = () => {
        menu?.classList.add('open');
        if (selectedProjectName && input.value === selectedProjectName) {
          input.value = '';
        }
      };

      const filterOptions = (query) => {
        const lowerQuery = query.toLowerCase();
        let visibleCount = 0;

        optionsContainer?.querySelectorAll('.project-dropdown__option').forEach((option) => {
          const searchText = option.dataset.projectSearchText || '';
          const matches = searchText.includes(lowerQuery);
          option.style.display = matches ? '' : 'none';
          if (matches) visibleCount++;
        });

        if (noResults) {
          noResults.hidden = visibleCount > 0;
        }
      };

      input?.addEventListener('focus', openMenu);

      input?.addEventListener('input', (e) => {
        if (!menu?.classList.contains('open')) {
          openMenu();
        }
        filterOptions(e.target.value);
      });

      input?.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeMenu();
          input?.blur();
        }
      });

      optionsContainer?.querySelectorAll('.project-dropdown__option').forEach((optionBtn) => {
        optionBtn.addEventListener('click', () => {
          const projectId = optionBtn.dataset.projectId;
          const projectName = optionBtn.dataset.projectName;

          hiddenInput.value = projectId;
          selectedProjectName = projectName;
          input.value = projectName;
          input.classList.add('project-dropdown__input--selected');
          closeMenu();
        });
      });

      document.addEventListener('click', (e) => {
        if (!projectDropdown.contains(e.target)) {
          closeMenu();
        }
      });

      const form = document.querySelector('[data-project-link-form]');
      form?.addEventListener('submit', (e) => {
        if (!hiddenInput.value) {
          e.preventDefault();
          input?.focus();
        }
      });
    }

    // Unlink modal
    const unlinkModal = document.querySelector('[data-unlink-modal]');
    const unlinkProjectName = document.querySelector('[data-unlink-project-name]');
    const unlinkConfirmBtn = document.querySelector('[data-unlink-confirm]');
    const unlinkCancelBtn = document.querySelector('[data-unlink-cancel]');
    let pendingUnlinkUrl = null;

    const showUnlinkModal = (projectName, url) => {
      unlinkProjectName.textContent = projectName;
      pendingUnlinkUrl = url;
      unlinkModal.hidden = false;
      unlinkConfirmBtn?.focus();
    };

    const hideUnlinkModal = () => {
      unlinkModal.hidden = true;
      pendingUnlinkUrl = null;
    };

    const performUnlink = () => {
      if (!pendingUnlinkUrl) return;

      const url = pendingUnlinkUrl;
      hideUnlinkModal();

      fetch(url, {
        method: 'DELETE',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': token
        }
      }).then((resp) => {
        if (resp.ok) {
          window.location.reload();
        }
      }).catch((err) => console.error(err));
    };

    unlinkConfirmBtn?.addEventListener('click', performUnlink);
    unlinkCancelBtn?.addEventListener('click', hideUnlinkModal);

    unlinkModal?.addEventListener('click', (e) => {
      if (e.target === unlinkModal) hideUnlinkModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !unlinkModal?.hidden) {
        hideUnlinkModal();
      }
    });

    document.querySelectorAll('.unlink-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const url = btn.dataset.unlinkUrl;
        const projectName = btn.dataset.projectName;
        showUnlinkModal(projectName, url);
      });
    });
  });
</script>
