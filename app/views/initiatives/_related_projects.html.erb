<%
  initiative = local_assigns[:initiative]
  initiative_record = local_assigns[:initiative_record]

  # Be defensive - initiative might be a record or domain object
  all_related_projects = initiative.respond_to?(:related_projects) ? (initiative.related_projects || []) : []
  direct_projects = all_related_projects.reject { |p| p.respond_to?(:archived?) && p.archived? }
  archived_projects = all_related_projects.select { |p| p.respond_to?(:archived?) && p.archived? }
  sorted_projects = sort_projects_canonical(direct_projects)
  sorted_archived = sort_projects_canonical(archived_projects)

  # Determine list type based on first project (all should be same type)
  first_project = direct_projects.first
  list_type = (first_project && first_project.respond_to?(:children) && first_project.children.any?) ? :parent : :leaf
%>

<turbo-frame id="related-projects-section">
  <section class="section section--projects" data-controller="inline-form">
    <div class="section__header">
      <h3 class="section__title">Related Projects</h3>
      <div class="section__actions">
        <button class="dashboard-tab-v2 dashboard-tab-v2--add"
                data-inline-form-target="toggle"
                data-action="inline-form#toggle"
                aria-label="Create related project">+</button>
        <div class="info-tooltip">
          <span class="info-tooltip__icon">i</span>
          <div class="info-tooltip__tooltip">
            <div class="info-tooltip__methodology">Related projects are linked to this initiative. Their health aggregates into the initiative's overall health.</div>
            <div class="info-tooltip__range">
              <div>• Projects can be linked to multiple initiatives</div>
              <div>• Health is calculated from leaf project updates</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Related Project Form (inline) -->
    <div class="inline-create-section" data-inline-form-target="section" hidden>
      <%= form_with url: add_related_project_initiative_path(initiative_record), method: :post, local: false, class: "inline-create-form" do |f| %>
        <div class="inline-create-form__row">
          <input type="text" name="project[name]" class="inline-create-form__input" placeholder="Project Name (required)" required>
          <input type="text" name="project[description]" class="inline-create-form__input" placeholder="Brief Description (highly recommended)">
          <input type="text" name="project[point_of_contact]" class="inline-create-form__input" placeholder="Contacts (highly recommended)">
          <button type="submit" class="btn btn--small">Create Related Project</button>
        </div>
      <% end %>
    </div>

    <% if direct_projects.empty? && archived_projects.empty? %>
      <div class="tab-empty-v2">No related projects</div>
    <% else %>
      <% if direct_projects.any? %>
        <ul class="project-list-v2">
          <%= render 'dashboard/project_list_header', list_type: list_type %>
          <% sorted_projects.each do |project| %>
            <%= render 'dashboard/project_list_item', project: project, list_type: list_type %>
          <% end %>
        </ul>
      <% end %>

      <% if archived_projects.any? %>
        <details class="section__archived-details">
          <summary class="section__archived-summary">Archived (<%= archived_projects.size %>)</summary>
          <ul class="project-list-v2" style="margin-top: 8px;">
            <% sorted_archived.each do |project| %>
              <%= render 'dashboard/project_list_item', project: project, list_type: list_type, tag_text: 'Archived', tag_modifier: 'archived' %>
            <% end %>
          </ul>
        </details>
      <% end %>
    <% end %>
  </section>
</turbo-frame>
